
Hamzeh, et al.               Informational                     [Page 36]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


   Some error recovery procedures are common to all states of the
   control connection.  If an expected reply does not arrive within 60
   seconds, the control connection is closed, unless otherwise
   specified.  Appropriate logging should be implemented for easy
   determination of the problems and the reasons for closing the control
   connection.

   Receipt of an invalid or malformed Control Connection message should
   be logged appropriately, and the control connection should be closed
   and restarted to ensure recovery into a known state.

3.1.  Control Connection States

   The control connection relies on a standard TCP connection for its
   service.  The PPTP control connection protocol is not distinguishable
   between the PNS and PAC, but is distinguishable between the
   originator and receiver. The originating peer is the one which first
   attempts the TCP open. Since either PAC or PNS may originate a
   connection, it is possible for a TCP collision to occur.  See section
   3.1.3 for a description of this situation.

3.1.1.  Control Connection Originator (may be PAC or PNS)

                TCP Open Indication
                /Send Start Control
                  Connection Request       +-----------------+
     +------------------------------------>|  wait_ctl_reply |
     |                                     +-----------------+
     |     Collision/See (4.1.3) Close TCP   V  V  V   Receive Start Ctl
     |       +-------------------------------+  |  |   Connection Reply
     |       |                                  |  |   Version OK
     ^       V                                  |  V
+-----------------+          Receive Start Ctl  | +-----------------+
|      idle       |          Connection Reply   | |   established   |
+-----------------+          Version Not OK     | +-----------------+
     ^                                          |  V   Local Terminate
     |         Receive Stop Control             |  |   /Send Stop
     |         Connection Request               |  |    Control Request
     |         /Send Stop Control Reply         V  V
     |          Close TCP                  +-----------------+
     +-------------------------------------| wait_stop_reply |
                                           +-----------------+









Hamzeh, et al.               Informational                     [Page 37]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


   idle
      The control connection originator attempts to open a TCP
      connection to the peer during idle state. When the TCP connection
      is open, the originator transmits a send Start-Control-
      Connection-Request and then enters the wait_ctl_reply state.

   wait_ctl_reply
      The originator checks to see if another TCP connection has been
      requested from the same peer, and if so, handles the collision
      situation described in section 3.1.3.

      When a Start-Control-Connection-Reply is received, it is examined
      for a compatible version. If the version of the reply is lower
      than the version sent in the request, the older (lower) version
      should be used provided it is supported.  If the version in the
      reply is earlier and supported, the originator moves to the
      established state. If the version is earlier and not supported, a
      Stop-Control-Connection-Request SHOULD be sent to the peer and the
      originator moves into the wait_stop_reply state.

   established
      An established connection may be terminated by either a local
      condition or the receipt of a Stop-Control-Connection-Request. In
      the event of a local termination, the originator MUST send a
      Stop-Control-Connection-Request and enter the wait_stop_reply
      state.

      If the originator receives a Stop-Control-Connection-Request it
      SHOULD send a Stop-Control-Connection-Reply and close the TCP
      connection making sure that the final TCP information has been
      "pushed" properly.

   wait_stop_reply
      If a Stop-Control-Connection-Reply is received, the TCP connection
      SHOULD be closed and the control connection becomes idle.
















Hamzeh, et al.               Informational                     [Page 38]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


3.1.2.  Control connection Receiver (may be PAC or PNS)

Receive Start Control Connection Request
Version Not OK/Send Start Control Connection
Reply with Error
  +--------+
  |        |         Receive Control Connection Request Version OK
  |        |         /Send Start Control Connection Reply
  |        |   +----------------------------------------+
  ^        V   ^                                        V
+-----------------+             Receive Start Ctl    +-----------------+
|      Idle       |             Connection Request   |   Established   |
+-----------------+             /Send Stop Reply     +-----------------+
        ^      ^                 Close TCP           V  V Local Terminate
        |      +-------------------------------------+  | /Send Stop
        |                                               |  Control Conn.
        |                                               V  Request
        |                                     +-----------------+
        +-------------------------------------| Wait-Stop-Reply |
                 Receive Stop Control         +-----------------+
                 Connection Reply
                 /Close TCP

   idle
      The control connection receiver waits for a TCP open attempt on
      port 1723. When notified of an open TCP connection, it should
      prepare to receive PPTP messages.  When a Start-Control-
      Connection-Request is received its version field should be
      examined. If the version is earlier than the receiver's version
      and the earlier version can be supported by the receiver, the
      receiver SHOULD send a Start-Control-Connection-Reply. If the
      version is earlier than the receiver's version and the version
      cannot be supported, the receiver SHOULD send a Start-Connection-
      Reply message, close the TCP connection and remain in the idle
      state.  If the receiver's version is the same as earlier than the
      peer's, the receiver SHOULD send a Start-Control-Connection-Reply
      with the receiver's version and enter the established state.

   established
      An established connection may be terminated by either a local
      condition or the reception of a Stop-Control-Connection-Request.
      In the event of a local termination, the originator MUST send a
      Stop-Control-Connection-Request and enter the wait_stop_reply
      state.







Hamzeh, et al.               Informational                     [Page 39]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


      If the originator receives a Stop-Control-Connection-Request it
      SHOULD send a Stop-Control-Connection-Reply and close the TCP
      connection, making sure that the final TCP information has been
      "pushed" properly.

   wait_stop_reply
      If a Stop-Control-Connection-Reply is received, the TCP connection
      SHOULD be closed and the control connection becomes idle.

3.1.3.  Start Control Connection Initiation Request Collision

   A PAC and PNS must have only one control connection between them. It
   is possible, however, for a PNS and a PAC to simultaneously attempt
   to establish a control connection to each other. When a Start-
   Control-Connection-Request is received on one TCP connection and
   another Start-Control-Connection-Request has already been sent on
   another TCP connection to the same peer, a collision has occurred.

   The "winner" of the initiation race is the peer with the higher IP
   address (compared as 32 bit unsigned values, network number more
   significant). For example, if the peers 192.33.45.17 and 192.33.45.89
   collide, the latter will be declared the winner.  The loser will
   immediately close the TCP connection it initiated, without sending
   any further PPTP control messages on it and will respond to the
   winner's request with a Start-Control-Connection-Reply message. The
   winner will wait for the Start-Control-Connection-Reply on the
   connection it initiated and also wait for a TCP termination
   indication on the connection the loser opened.  The winner MUST NOT
   send any messages on the connection the loser initiated.

3.1.4.  Keep Alives and Timers

   A control connection SHOULD be closed by closing the underlying TCP
   connection under the following circumstances:

   1. If a control connection is not in the established state (i.e.,
      Start-Control-Connection-Request and Start-Control-Connection-
      Reply have not been exchanged), a control connection SHOULD be
      closed after 60 seconds by a peer waiting for a Start-Control-
      Connection-Request or Start-Control-Connection-Reply message.

   2. If a peer's control connection is in the established state and has
      not received a control message for 60 seconds, it SHOULD send a
      Echo-Request message. If an Echo-Reply is not received 60 seconds
      after the Echo-Request message transmission, the control
      connection SHOULD be closed.





Hamzeh, et al.               Informational                     [Page 40]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


3.2.  Call States

3.2.1.  Timing considerations

   Because of the real-time nature of telephone signaling, both the PNS
   and PAC should be implemented with multi-threaded architectures such
   that messages related to multiple calls are not serialized and
   blocked. The transit delay between the PAC and PNS should not exceed
   one second. The call and connection state figures do not specify
   exceptions caused by timers. The implicit assumption is that since
   the TCP-based control connection is being verified with keep-alives,
   there is less need to maintain strict timers for call control
   messages.

   Establishing outbound international calls, including the modem
   training and negotiation sequences, may take in excess of 1 minute so
   the use of short timers is discouraged.

   If a state transition does not occur within 1 minute (except for
   connections in the idle or established states), the integrity of the
   protocol processing between the peers is suspect and the ENTIRE
   CONTROL CONNECTION should be closed and restarted. All Call IDs are
   logically released whenever a control connection is started. This
   presumably also helps in preventing toll calls from being "lost" and
   never cleared.

3.2.2.  Call ID Values

   Each peer assigns a Call ID value to each user session it requests or
   accepts. This Call ID value MUST be unique for the tunnel between the
   PNS and PAC to which it belongs. Tunnels to other peers can use the
   same Call ID number so the receiver of a packet on a tunnel needs to
   associate a user session with a particular tunnel and Call ID.  It is
   suggested that the number of potential Call ID values for each tunnel
   be at least twice as large as the maximum number of calls expected on
   a given tunnel.

   A session is defined by the triple (PAC, PNS, Call ID).

3.2.3.  Incoming Calls

   An Incoming-Call-Request message is generated by the PAC when an
   associated telephone line rings. The PAC selects a Call ID and serial
   number and indicates the call bearer type.  Modems should always
   indicate analog call type.  ISDN calls should indicate digital when
   unrestricted digital service or rate adaption is used and analog if





Hamzeh, et al.               Informational                     [Page 41]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


   digital modems are involved. Dialing number, dialed number, and
   subaddress may be included in the message if they are available from
   the telephone network.

   Once the PAC sends the Incoming-Call-Request, it waits for a response
   from the PNS but does not answer the call from the telephone network.
   The PNS may choose not to accept the call if:

      -  No resources are available to handle more sessions

      -  The dialed, dialing, or subaddress fields are not indicative of
         an authorized user

      -  The bearer service is not authorized or supported

   If the PNS chooses to accept the call, it responds with an Incoming-
   Call-Reply which also indicates window sizes (see section 4.2). When
   the PAC receives the Outgoing-Call-Reply, it attempts to connect the
   call, assuming the calling party has not hung up. A final call
   connected message from the PAC to the PNS indicates that the call
   states for both the PAC and the PNS should enter the established
   state.

   When the dialed-in client hangs up, the call is cleared normally and
   the PAC sends a Call-Disconnect-Notify message. If the PNS wishes to
   clear a call, it sends a Call-Clear-Request message and then waits
   for a Call-Disconnect-Notify.

3.2.3.1.  PAC Incoming Call States

    Ring/Send Incoming Call Request          +-----------------+
  +----------------------------------------->|    wait_reply   |
  |                                          +-----------------+
  |           Receive Incoming Call Reply    V  V  V
  |           Not Accepting                  |  |  |   Receive Incoming
  |         +--------------------------------+  |  |   Call Reply Accept-
  |         |    +------------------------------+  |   ing/Answer call;
  |         |    |     Abort/Send Call             |   Send Call
  ^         V    V     Disconnect Notify           V   Connected
+-----------------+                              +-----------------+
|      idle       |<-----------------------------|   established   |
+-----------------+  Receive Clear Call Request  +-----------------+
                     or telco call dropped
                     or local disconnect
                     /Send Call Disconnect Notify






Hamzeh, et al.               Informational                     [Page 42]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


The states associated with the PAC for incoming calls are:

   idle
      The PAC detects an incoming call on one of its telco interfaces.
      Typically this means an analog line is ringing or an ISDN TE has
      detected an incoming Q.931 SETUP message. The PAC sends an
      Incoming-Call-Request message and moves to the wait_reply state.

   wait_reply
      The PAC receives an Incoming-Call-Reply message indicating non-
      willingness to accept the call (general error or don't accept) and
      moves back into the idle state. If the reply message indicates
      that the call is accepted, the PAC sends an Incoming-Call-
      Connected message and enters the established state.

   established
      Data is exchanged over the tunnel.  The call may be cleared
      following:

         An event on the telco connection. The PAC sends a
         Call-Disconnect-Notify message

         Receipt of a Call-Clear-Request.  The PAC sends a
         Call-Disconnect-Notify message

         A local reason. The PAC sends a Call-Disconnect-Notify message.

3.2.3.2.  PNS Incoming Call States

  Receive Incoming Call Request
  /Send Incoming Call Reply                  +-----------------+
   Not Accepting if Error                    |   Wait-Connect  |
  +-----+                                    +-----------------+
  |     |     Receive Incoming Call Req.     ^  V  V
  |     |     /Send Incoming Call Reply OK   |  |  |   Receive Incoming
  |     |   +--------------------------------+  |  |   Call Connect
  ^     V   ^    V------------------------------+  V
+-----------------+  Receive Call Disconnect     +-----------------+
|      Idle       |  Notify                   +- |   Established   |
+-----------------+                           |  +-----------------+
        ^        ^                            |   V   Local Terminate
        |        +----------------------------+   |   /Send Call Clear
        |            Receive Call Disconnect      |    Request
        |            Notify                       V
        |                                      +-----------------+
        +--------------------------------------| Wait-Disconnect |
                     Receive Call Disconnect   +-----------------+
                     Notify



Hamzeh, et al.               Informational                     [Page 43]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


The states associated with the PNS for incoming calls are:

   idle
      An Incoming-Call-Request message is received. If the request is
      not acceptable, an Incoming-Call-Reply is sent back to the PAC and
      the PNS remains in the idle state.  If the Incoming-Call-Request
      message is acceptable, an Incoming-Call-Reply is sent indicating
      accept in the result code. The session moves to the wait_connect
      state.

   wait_connect
      If the session is connected on the PAC, the PAC sends an incoming
      call connect message to the PNS which then moves into established
      state. The PAC may send a Call-Disconnect-Notify to indicate that
      the incoming caller could not be connected.  This could happen,
      for example, if a telephone user accidently places a standard
      voice call to a PAC resulting in a handshake failure on the called
      modem.

   established
      The session is terminated either by receipt of a Call-Disconnect-
      Notify message from the PAC or by sending a Call-Clear-Request.
      Once a Call-Clear-Request has been sent, the session enters the
      wait_disconnect state.

   wait_disconnect
      Once a Call-Disconnect-Notify is received the session moves back
      to the idle state.

3.2.4.  Outgoing Calls

   Outgoing messages are initiated by a PNS and instruct a PAC to place
   a call on a telco interface. There are only two messages for outgoing
   calls: Outgoing-Call-Request and Outgoing-Call-Reply. The PNS sends
   an Outgoing-Call-Request specifying the dialed party phone number and
   subaddress as well as speed and window parameters. The PAC MUST
   respond to the Outgoing-Call-Request message with an Outgoing-Call-
   Reply message once the PAC determines that:

      The call has been successfully connected

      A call failure has occurred for reasons such as: no interfaces are
      available for dial-out, the called party is busy or does not
      answer, or no dial tone is detected on the interface chosen for
      dialing






Hamzeh, et al.               Informational                     [Page 44]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


3.2.4.1.  PAC Outgoing Call States

Receive Outgoing Call Request in Error
/Send Outgoing Call Reply with Error
  |--------+
  |        |         Receive Outgoing Call Request No Error
  |        |         /Off Hook; Dial
  |        |   +-----------------------------------------
  ^        V   ^                                        V
+-----------------+           Incomplete Call        +-----------------+
|      idle       |           /Send Outgoing Call    |   wait_cs_ans   |
+-----------------+            Reply with Error      +-----------------+
        ^      ^           or Recv. Call Clear Req.  V  V Telco Answer
        |      |              /Send Disconnect Notify|  | /Send Outgoing
        |      +-------------------------------------+  |  Call Reply.
        |                                               V
        |                                     +-----------------+
        +-------------------------------------|   established   |
                 Receive Call Clear Request   +-----------------+
                 or local terminate
                 or telco disconnect
                 /Hangup call and send
                 Call Disconnect Notify

   The states associated with the PAC for outgoing calls are:

   idle
      Received Outgoing-Call-Request. If this is received in error,
      respond with an Outgoing-Call-Reply with error condition set.
      Otherwise, allocate physical channel to dial on. Place the
      outbound call, wait for a connection, and move to the wait_cs_ans
      state.

   wait_cs_ans
      If the call is incomplete, send an Outgoing-Call-Reply with a
      non-zero Error Code. If a timer expires on an outbound call, send
      back an Outgoing-Call-Reply with a non-zero Error Code. If a
      circuit switched connection is established, send an Outgoing-
      Call-Reply indicating success.

   established
      If a Call-Clear-Request is received, the telco call SHOULD be
      released via appropriate mechanisms and a Call-Disconnect-Notify
      message SHOULD BE sent to the PNS. If the call is disconnected by
      the client or by the telco interface, a Call-Disconnect-Notify
      message SHOULD be sent to the PNS.





Hamzeh, et al.               Informational                     [Page 45]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


3.2.4.2.  PNS Outgoing Call States

                Open Indication                              Abort/Send
                /Send Outgoing Call                          Call Clear
                 Request                  +-----------------+Request
        +-------------------------------->|    Wait-Reply   |----------+
        |                                 +-----------------+          |
        |     Receive Outgoing Call Reply   V     V   Receive Outgoing |
        |     with Error                    |     |   Call Reply       |
        |   +-------------------------------+     |   No Error         |
        ^   V                                     V                    |
+-----------------+                              +-----------------+   |
|      Idle       |<-----------------------------|   Established   |   |
+-----------------+    Receive Call Disconnect   +-----------------+   |
        ^              Notify                     V   Local Terminate  |
        |                                         |   /Send Call Clear |
        |                                         |    Request         |
        |     Receive Call Disconnect             V                    |
        |     Notify                      +-----------------+          |
        +---------------------------------| Wait-Disconnect |<---------+
                                          +-----------------+

The states associated with the PNS for outgoing calls are:

   idle
      An Outgoing-Call-Request message is sent to the PAC and the
      session moves into the wait_reply state.

   wait_reply
      An Outgoing-Call-Reply is received which indicates an error. The
      session returns to idle state. No telco call is active. If the
      Outgoing-Call-Reply does not indicate an error, the telco call is
      connected and the session moves to the established state.

   established
      If a Call-Disconnect-Notify is received, the telco call has been
      terminated for the reason indicated in the Result and Cause Codes.
      The session moves back to the idle state. If the PNS chooses to
      terminate the session, it sends a Call-Clear-Request to the PAC
      and then enters the wait_disconnect state.

   wait_disconnect
      A session disconnection is waiting to be confirmed by the PAC.
      Once the PNS receives the Call-Disconnect-Notify message, the
      session enters idle state.






Hamzeh, et al.               Informational                     [Page 46]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


4.  Tunnel Protocol Operation

   The user data carried by the PPTP protocol are PPP data packets.  PPP
   packets are carried between the PAC and PNS, encapsulated in GRE
   packets which in turn are carried over IP.  The encapsulated PPP
   packets are essentially PPP data packets less any media specific
   framing elements.  No HDLC flags, bit insertion, control characters,
   or control character escapes are included. No CRCs are sent through
   the tunnel. The IP packets transmitted over the tunnels between a PAC
   and PNS has the following general structure:

      +--------------------------------+
      |          Media Header          |
      +--------------------------------+
      |           IP Header            |
      +--------------------------------+
      |           GRE Header           |
      +--------------------------------+
      |           PPP Packet           |
      +--------------------------------+

4.1.  Enhanced GRE header

   The GRE header used in PPTP is enhanced slightly from that specified
   in the current GRE protocol specification [1,2].  The main difference
   involves the definition of a new Acknowledgment Number field, used to
   determine if a particular GRE packet or set of packets has arrived at
   the remote end of the tunnel.  This Acknowledgment capability is not
   used in conjunction with any retransmission of user data packets.  It
   is used instead to determine the rate at which user data packets are
   to be transmitted over the tunnel for a given user session.  The
   format of the enhanced GRE header is as follows:

    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |C|R|K|S|s|Recur|A| Flags | Ver |         Protocol Type         |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |    Key (HW) Payload Length    |       Key (LW) Call ID        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                  Sequence Number (Optional)                   |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |               Acknowledgment Number (Optional)                |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+







Hamzeh, et al.               Informational                     [Page 47]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


   C
      (Bit 0) Checksum Present.  Set to zero (0).

   R
      (Bit 1) Routing Present.  Set to zero (0).

   K
      (Bit 2) Key Present.  Set to one (1).
   S
      (Bit 3) Sequence Number Present.  Set to one (1) if a payload
      (data) packet is present.  Set to zero (0) if payload is not
      present (GRE packet is an Acknowledgment only).

   s
      (Bit 4) Strict source route present.  Set to zero (0).

   Recur
      (Bits 5-7) Recursion control.  Set to zero (0).

   A
      (Bit 8) Acknowledgment sequence number present.  Set to one (1) if
      packet contains Acknowledgment Number to be used for acknowledging
      previously transmitted data.

   Flags
      (Bits 9-12) Must be set to zero (0).

   Ver
      (Bits 13-15) Must contain 1 (enhanced GRE).

   Protocol Type
      Set to hex 880B [8].

   Key
      Use of the Key field is up to the implementation.  PPTP uses it as
      follows:
         Payload Length
            (High 2 octets of Key) Size of the payload, not including
            the GRE header

         Call ID
            (Low 2 octets) Contains the Peer's Call ID for the session
            to which this packet belongs.

         Sequence Number
            Contains the sequence number of the payload.  Present if S
            bit (Bit 3) is one (1).




Hamzeh, et al.               Informational                     [Page 48]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


         Acknowledgment Number
            Contains the sequence number of the highest numbered GRE
            packet received by the sending peer for this user session.
            Present if A bit (Bit 8) is one (1).

         The payload section contains a PPP data packet without any
         media specific framing elements.

         The sequence numbers involved are per packet sequence numbers.
         The sequence number for each user session is set to zero at
         session startup.  Each packet sent for a given user session
         which contains a payload (and has the S bit (Bit 3) set to one)
         is assigned the next consecutive sequence number for that
         session.

         This protocol allows acknowledgments to be carried with the
         data and makes the overall protocol more efficient, which in
         turn requires less buffering of packets.

4.2.  Sliding Window Protocol

   The sliding window protocol used on the PPTP data path is used for
   flow control by each side of the data exchange.  The enhanced GRE
   protocol allows packet acknowledgments to be piggybacked on data
   packets.  Acknowledgments can also be sent separately from data
   packets.  Again, the main purpose of the sliding window protocol is
   for flow control--retransmissions are not performed by the tunnel
   peers.

4.2.1.  Initial Window Size

   Although each side has indicated the maximum size of its receive
   window, it is recommended that a conservative approach be taken when
   beginning to transmit data.  The initial window size on the
   transmitter is set to half the maximum size the receiver requested,
   with a minimum size of one packet.  The transmitter stops sending
   packets when the number of packets awaiting acknowledgment is equal
   to the current window size.  As the receiver successfully digests
   each window, the window size on the transmitter is bumped up by one
   packet until the maximum is reached.  This method prevents a system
   from flooding an already congested network because no history has
   been established.

4.2.2.  Closing the Window

   When a time-out does occur on a packet, the sender adjusts the size
   of the transmit window down to one half its value when it failed.
   Fractions are rounded up, and the minimum window size is one.



Hamzeh, et al.               Informational                     [Page 49]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


4.2.3.  Opening the Window

   With every successful transmission of a window's worth of packets
   without a time-out, the transmit window size is increased by one
   packet until it reaches the maximum window size that was sent by the
   other side when the call was connected.  As stated earlier, no
   retransmission is done on a time-out. After a time-out, the
   transmission resumes with the window starting at one half the size of
   the transmit window when the time-out occurred and adjusting upward
   by one each time the transmit window is filled with packets that are
   all acknowledged without time-outs.

4.2.4.  Window Overflow

   When a receiver's window overflows with too many incoming packets,
   excess packets are thrown away.  This situation should not arise if
   the sliding window procedures are being properly followed by the
   transmitter and receiver. It is assumed that, on the transmit side,
   packets are buffered for transmission and are no longer accepted from
   the packet source when the transmit buffer fills.

4.2.5.  Multi-packet Acknowledgment

   One feature of the PPTP sliding window protocol is that it allows the
   acknowledgment of multiple packets with a single acknowledgment. All
   outstanding packets with a sequence number lower or equal to the
   acknowledgment number are considered acknowledged. Time-out
   calculations are performed using the time the packet corresponding to
   the highest sequence number being acknowledged was transmitted.

   Adaptive time-out calculations are only performed when an
   Acknowledgment is received.  When multi-packet acknowledgments are
   used, the overhead of the adaptive time-out algorithm is reduced. The
   PAC is not required to transmit multi-packet acknowledgments; it can
   instead acknowledge each packet individually as it is delivered to
   the PPP client.

4.3.  Out-of-sequence Packets

   Occasionally packets lose their sequencing across a complicated
   internetwork.  Say, for example that a PNS sends packets 0 to 5 to a
   PAC.  Because of rerouting in the internetwork, packet 4 arrives at
   the PAC before packet 3. The PAC acknowledges packet 4, and may
   assume packet 3 is lost. This acknowledgment grants window credit
   beyond packet 4.






Hamzeh, et al.               Informational                     [Page 50]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


   When the PAC does receive packet 3, it MUST not attempt to transmit
   it to the corresponding PPP client.  To do so could cause problems,
   as proper PPP protocol operation is premised upon receiving packets
   in sequence.  PPP does properly deal with the loss of packets, but
   not with reordering so out of sequence packets between the PNS and
   PAC MUST be silently discarded, or they may be reordered by the
   receiver.  When packet 5 comes in, it is acknowledged by the PAC
   since it has a higher sequence number than 4, which was the last
   highest packet acknowledged by the PAC.  Packets with duplicate
   sequence numbers should never occur since the PAC and PNS never
   retransmit GRE packets.  A robust implementation will silently
   discard duplicate GRE packets, should it receive any.

4.4.  Acknowledgment Time-Outs

   PPTP uses sliding windows and time-outs to provide both user session
   flow-control across the internetwork and to perform efficient data
   buffering to keep the PAC-PNS data channels full without causing
   receive buffer overflow.  PPTP requires that a time-out be used to
   recover from dropped data or acknowledgment packets.  The exact
   implementation of the time-out is vendor-specific.  It is suggested
   that an adaptive time-out be implemented with backoff for congestion
   control.  The time-out mechanism proposed here has the following
   properties:

      Independent time-outs for each session. A device (PAC or PNS) will
      have to maintain and calculate time-outs for every active session.

      An administrator-adjustable maximum time-out, MaxTimeOut, unique
      to each device.

      An adaptive time-out mechanism that compensates for changing
      throughput.  To reduce packet processing overhead, vendors may
      choose not to recompute the adaptive time-out for every received
      acknowledgment.  The result of this overhead reduction is that the
      time-out will not respond as quickly to rapid network changes.

      Timer backoff on time-out to reduce congestion. The backed-off
      timer value is limited by the configurable maximum time-out value.
      Timer backoff is done every time an acknowledgment time-out
      occurs.

   In general, this mechanism has the desirable behavior of quickly
   backing off upon a time-out and of slowly decreasing the time-out
   value as packets are delivered without time-outs.






Hamzeh, et al.               Informational                     [Page 51]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


   Some definitions:

      Packet Processing Delay (PPD) is the amount of time required for
      each side to process the maximum amount of data buffered in their
      receive packet sliding window. The PPD is the value exchanged
      between the PAC and PNS when a call is established. For the PNS,
      this number should be small.  For a PAC making modem connections,
      this number could be significant.

      Sample is the actual amount of time incurred receiving an
      acknowledgment for a packet. The Sample is measured, not
      calculated.

      Round-Trip Time (RTT) is the estimated round-trip time for an
      Acknowledgment to be received for a given transmitted packet. When
      the network link is a local network, this delay will be minimal
      (if not zero). When the network link is the Internet, this delay
      could be substantial and vary widely. RTT is adaptive: it will
      adjust to include the PPD and whatever shifting network delays
      contribute to the time between a packet being transmitted and
      receiving its acknowledgment.

      Adaptive Time-Out (ATO) is the time that must elapse before an
      acknowledgment is considered lost.  After a time-out, the sliding
      window is partially closed and the ATO is backed off.

   The Packet Processing Delay (PPD) parameter is a 16-bit word
   exchanged during the Call Control phase that represents tenths of a
   second (64 means 6.4 seconds). The protocol only specifies that the
   parameter is exchanged, it does not specify how it is calculated. The
   way values for PPD are calculated is implementation-dependent and
   need not be variable (static time-outs are allowed). The PPD must be
   exchanged in the call connect sequences, even if it remains constant
   in an implementation. One possible way to calculate the PPD is:

   PPD' = ((PPP_MAX_DATA_MTU - Header) * WindowSize * 8) / ConnectRate
   PPD = PPD' + PACFudge

   Header is the total size of the IP and GRE headers, which is 36. The
   MTU is the overall MTU for the internetwork link between the PAC and
   PNS.  WindowSize represents the number of packets in the sliding
   window, and is implementation-dependent. The latency of the
   internetwork could be used to pick a window size sufficient to keep
   the current session's pipe full. The constant 8 converts octets to
   bits (assuming ConnectRate is in bits per second).  If ConnectRate is
   in bytes per second, omit the 8.  PACFudge is not required but can be
   used to take overall processing overhead of the PAC into account.




Hamzeh, et al.               Informational                     [Page 52]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


   The value of PPD is used to seed the adaptive algorithm with the
   initial RTT[n-1] value.

4.4.1.  Calculating Adaptive Acknowledgment Time-Out

   We still must decide how much time to allow for acknowledgments to
   return. If the time-out is set too high, we may wait an unnecessarily
   long time for dropped packets. If the time-out is too short, we may
   time out just before the acknowledgment arrives. The acknowledgment
   time-out should also be reasonable and responsive to changing network
   conditions.

   The suggested adaptive algorithm detailed below is based on the TCP
   1989 implementation and is explained in [11].  'n' means this
   iteration of the calculation, and 'n-1' refers to values from the
   last calculation.

      DIFF[n] = SAMPLE[n] - RTT[n-1]
      DEV[n] = DEV[n-1] + (beta * (|DIFF[n]| - DEV[n-1]))
      RTT[n] = RTT[n-1] + (alpha * DIFF[n])
      ATO[n] = MAX (MinTimeOut, MIN (RTT[n] +
               (chi * DEV[n]), MaxTimeOut))

      DIFF represents the error between the last estimated round-trip
      time and the measured time. DIFF is calculated on each iteration.

      DEV is the estimated mean deviation. This approximates the
      standard deviation.  DEV is calculated on each iteration and
      stored for use in the next iteration. Initially, it is set to 0.

      RTT is the estimated round-trip time of an average packet. RTT is
      ycalculated on each iteration and stored for use in the next
      iteration.  Initially, it is set to PPD.

      ATO is the adaptive time-out for the next transmitted packet. ATO
      is calculated on each iteration.  Its value is limited, by the MIN
      function, to be a maximum of the configured MaxTimeOut value.

      Alpha is the gain for the average and is typically 1/8 (0.125).

      Beta is the gain for the deviation and is typically 1/4 (0.250).

      Chi is the gain for the time-out and is typically set to 4.








Hamzeh, et al.               Informational                     [Page 53]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


   To eliminate division operations for fractional gain elements, the
   entire set of equations can be scaled. With the suggested gain
   constants, they should be scaled by 8 to eliminate all division.  To
   simplify calculations, all gain values are kept to powers of two so
   that shift operations can be used in place of multiplication or
   division.

4.4.2.  Congestion Control: Adjusting for Time-Out

   This section describes how the calculation of ATO is modified in the
   case where a time-out does occur.  When a time-out occurs, the time-
   out value should be adjusted rapidly upward.  Although the GRE
   packets are not retransmitted when a time-out occurs, the time-out
   should be adjusted up toward a maximum limit.  To compensate for
   shifting internetwork time delays, a strategy must be employed to
   increase the time-out when it expires (notice that in addition to
   increasing the time-out, we are also shrinking the size of the window
   as described in the next section).  For an interval in which a time-
   out occurs, the new
   ATO is calculated as:

      RTT[n] = delta * RTT[n-1]
      DEV[n] = DEV[n-1]
      ATO[n] = MAX (MinTimeOut, MIN (RTT[n] +
               (chi * DEV[n]), MaxTimeOut))

   In this calculation of ATO, only the two values that both contribute
   to ATO and are stored for the next iteration are calculated.  RTT is
   scaled by delta, and DEV is unmodified.  DIFF is not carried forward
   and is not used in this scenario.  A value of 2 for Delta, the time-
   out gain factor for RTT, is suggested.

5.  Security Considerations

   The security of user data passed over the tunneled PPP connection is
   addressed by PPP, as is authentication of the PPP peers.

   Because the PPTP control channel messages are neither authenticated
   nor integrity protected, it might be possible for an attacker to
   hijack the underlying TCP connection.  It is also possible to
   manufacture false control channel messages and alter genuine messages
   in transit without detection.

   The GRE packets forming the tunnel itself are not cryptographically
   protected.  Because the PPP negotiations are carried out over the
   tunnel, it may be possible for an attacker to eavesdrop on and modify
   those negotiations.




Hamzeh, et al.               Informational                     [Page 54]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


   Unless the PPP payload data is cryptographically protected, it can be
   captured and read or modified.

6.  Authors' Addresses

   Kory Hamzeh
   Ascend Communications
   1275 Harbor Bay Parkway
   Alameda, CA 94502

   EMail: kory@ascend.com


   Gurdeep Singh Pall
   Microsoft Corporation
   Redmond, WA

   EMail: gurdeep@microsoft.com


   William Verthein
   U.S. Robotics/3Com


   Jeff Taarud
   Copper Mountain Networks


   W. Andrew Little
   ECI Telematics


   Glen Zorn
   Microsoft Corporation
   Redmond, WA

   EMail: glennz@microsoft.com














Hamzeh, et al.               Informational                     [Page 55]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


7.  References

   [1]  Hanks, S., Li, T., Farinacci, D. and P. Traina, "Generic Routing
        Encapsulation (GRE)", RFC 1701, October 1994.

   [2]  Hanks, S., Li, T., Farinacci, D. and P. Traina, "Generic Routing
        Encapsulation (GRE) over IPv4 Networks", RFC 1702, October 1994.

   [3]  Lloyd, B. and W. Simpson, "PPP Authentication Protocols", RFC
        1334, October 1992.

   [4]  Postel, J., "Transmission Control Protocol", STD 7, RFC 793,
        September 1981.

   [5]  Postel, J., "User Data Protocol", STD 6, RFC 768, August 1980.

   [6]  Reynolds, J. and J. Postel, "Assigned Numbers", STD 2, RFC 1700,
        October 1994.  See also: http://www.iana.org/numbers.html

   [7]  Simpson, W., editor, "The Point-to-Point Protocol (PPP)", STD
        51, RFC 1661, July 1994.

   [8]  Ethertype for PPP, Reserved with Xerox Corporation.

   [9]  Simpson, W., "PPP Challenge Handshake Authentication Protocol
        (CHAP)", RFC 1994, August 1996.

   [10] Blunk, L. and J Vollbrecht, "PPP Extensible Authentication
        Protocol (EAP)", RFC 2284, March 1998.

   [11] Stevens, R., "TCP/IP Illustrated, Volume 1", p. 300, Addison-
        Wesley, 1994.

   [12] Bradner, S., "Key words for use in RFCs to Indicate Requirement
        Levels", BCP 14, RFC 2119, March 1997.
















Hamzeh, et al.               Informational                     [Page 56]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


8. Full Copyright Statement

   Copyright (C) The Internet Society (1999).  All Rights Reserved.

   This document and translations of it may be copied and furnished to
   others, and derivative works that comment on or otherwise explain it
   or assist in its implementation may be prepared, copied, published
   and distributed, in whole or in part, without restriction of any
   kind, provided that the above copyright notice and this paragraph are
   included on all such copies and derivative works.  However, this
   document itself may not be modified in any way, such as by removing
   the copyright notice or references to the Internet Society or other
   Internet organizations, except as needed for the purpose of
   developing Internet standards in which case the procedures for
   copyrights defined in the Internet Standards process must be
   followed, or as required to translate it into languages other than
   English.

   The limited permissions granted above are perpetual and will not be
   revoked by the Internet Society or its successors or assigns.

   This document and the information contained herein is provided on an
   "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
   TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
   BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
   HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
   MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.

Acknowledgement

   Funding for the RFC Editor function is currently provided by the
   Internet Society.



















Hamzeh, et al.               Informational                     [Page 57]


10.10.13 4.4.1.3 Протокол туннелей на сетевом уровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 1/41
Previous:  4.4.1.2 I P-туннели    UP:  4.4.1 I P-протокол
4.4.1.3 Протокол туннелей на сетевом уровне L2 (L2TP)
Семенов Ю.А.  (ИТЭФ-МФТИ)
Semenov Yu  (ITEP-MIPT)
(W.  Townsley,  A.  Valencia,  A. ,  Rubens,  G.  Pall,  G.  Zorn,  B.  Palter ,  Layer  Two Tunneling Protocol "L2TP".  RFC-2661,  August
1999.  Перевод Семенова Ю. А. )
Введение
Топология
Обзор протокола
Формат заголовка L2TP
Типы управляющих сообщений
Пары значений-атрибутов управляющих сообщений
Сокрытие значений атрибутов AVP
Обзор AVP
Протокольные операции
Установление контрольного соединения
Установление сессии
Переадресация кадров PPP
Использование порядковых номеров в канале данных
Keepalive (Hello)
Прерывание сессии
Разрыв контрольного соединения
Надежная доставка управляющих сообщений
Протокол ьная спецификация контрольного соединения
Машины состояний управляющего соединения
Входящие вызовы
Исходящие вызовы
Ликвидация туннеля
Реал изация L2TP через специфическую среду L2TP через UDP/IP
Соображения безопасности Соображения IANA
Ссылки
Приложения

1.0. Введение
Протокол PPP  [RFC1661] определяет механизм инкапсуляции для транспортировки мультипротокольных пакетов
для соединений точка-точка сетевого уровня L2.  Обычно,  пользователь получает соединение L2 с сервером доступа
NAS  (Network Access Server ) посредством одной из следующих технологий:  посредством модема через
коммутируемую телефонную сеть, ISDN, ADSL, и т. д. Далее через это соединение реализуется протокол PPP. В такой
конфигурации терминальная точка L2 и сессии PPP находится в одном и том же физическом устройстве  (NAS).
Разрабатывается версия протокола для безопасного удаленного доступа через L2TP  (RFC-2888).
Протокол L2TP расширяет модель PPP,  позволяя размещение терминальных точек L2 и PPP в различных физических
устройствах,  подключенных к сети с коммутацией пакетов.  В L2TP,  пользователь имеет соединение L2 с
концентратором доступа  (например,  модемным пулом,  ADSL DSLAM, и т. д.),  а концентратор в свою очередь
туннелирует индивидуальные PPP-кадры в NAS.  Это позволяет разделить обработку PPP-пакетов и реализацию шлюза.
Очевидным преимуществом такого разделения является то,  что вместо требования завершения соединения L2 в
NAS,  соединение может завершаться в локальном концентраторе,  который затем продлевает логический канал PPP
через общую инфраструктуру,  такую как, например,  Интернет. C точки зрения пользователя нет никакой разницы
между завершением туннеля на уровне L2 в NAS или через L2TP.
Многоканальный PPP  [RFC1990] требует,  чтобы все каналы,  образующие многоканальную связь,  были объединены
в группу с помощью одного NAS.  Благодаря возможности формирования сессий PPP с оконечными адресами,
отличными от точки присоединения,  L2TP может использоваться для схем,  когда все каналы приходят на вход
одного NAS.
10.10.13 4.4.1.3 Протокол туннелей на сетевом у ровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 2/41
1.1. Терминология
Аналоговый канал
Коммуникационный канал,  который обычно обеспечивает при передаче
голоса полосу 3. 1 кГц в обоих направлениях.
Пары атрибут
значение AVP  (Attribute Value Pair) Объединение уникального атрибута
(представляемого в виде целого числа) и действительного значения этого
атрибута.  Пара AVP имеет переменную длину.  Несколько AVP образуют
управляющие сообщения,  которые используются при установлении,
поддержке и ликвидации туннеля.
Вызов
Соединение  (или попытка соединения) между удаленной системой и LAC
(L2TP Access Concentrator ).  Например,  телефонный вызов через обычную
коммутируемую телефонную сеть PSTN.  Вызов  (входящий или исходящий),
который успешно осуществил связь между удаленной системой и LAC,
реализуется в ходе L2TP-сессии при условии,  что туннель между LAC и LNS
(L2TP Network Server ) уже создан.   (Смотри также:  сессия,  входящий вызов,
исходящий вызов).
Вызванный номер Телефонный номер,  использованный для связи с получателем вызова.
Вызывающий номер Телефонный номер,  откуда пришел вызов.
CHAP
Challenge Handshake Authentication Protocol  [RFC1994],  криптографический
PPP-протокол для аутентификации вызова/отклика,  в котором пароль не
передается открытым текстом.
Управляющее соединение
Управляющее соединение работает в пределах имеющейся полосы
туннеля и служит для установления,  аннулирования и поддержания сессий
и самого туннеля.
Управляющие сообщения
Управляющими сообщениями обмениваются LAC и LNS,  работающие в
пределах имеющейся полосы туннеля.  Управляющие сообщения
контролируют сам туннель и реализуемые через него сессии.
Цифровой канал
Коммутируемый канал,  по которому передаются цифровые данные в
обоих направлениях.
DSLAM
Digital Subscr iber  Line  (DSL) Access Module  (модуль доступа клиентов к
цифровым линиям).  Сетевой прибор,  используемый для реализации DSL-сервиса. 
Это обычно концентратор индивидуальных DSL-линий,
размещенный в центральном офисе  (CO),  или местный коммутатор.
Входящий вызов
Вызов,  полученный LAC для туннелирования в LNS  (смотри Вызов,
Исходящий вызов).
Концентратор доступа L2TP (LAC)
Узел,  который действует в качестве одной из сторон L2TP-туннеля и
является партнером для LNS  (L2TP Network Server ).  LAC размещается
между LNS и удаленной системой,  переадресуя им пакеты.  Пакеты,
посланные от LAC к LNS,  требуют туннелирования с помощью протокола
L2TP,  как это определено в данном документе.  Соединение между LAC и
удаленной системой является локальным  (смотри:  клиент LAC) или
осуществляется через канал PPP.
Сетевой сервер L2TP  (LNS)
Узел,  который работает в качестве одного из концов L2TP туннеля,  и
является партнером для LAC  (L2TP Access Concentrator ).  LNS является
10.10.13 4.4.1.3 Протокол туннелей на сетевом у ровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 3/41
логической терминальной точкой PPP-сессии,  которая организует туннель
между удаленной системой и LAC.
Домен управления  (MD)
Сеть или сети,  управляемые общей администрацией administration,
политикой или системой.  Например,  доменом управления LNS может быть
корпоративная сеть,  которую  он   обслуживает.  Доменом управления LAC
может быть сервис-провайдер Интернет,  которым он управляет.
Сервер доступа к сети  (NAS)
Прибор,  предоставляющий доступ к локальной сети для пользователей
удаленной сети,  такой как общедоступная коммутируемая телефонная сеть
(PSTN).  NAS может выполнять функцию LAC,  LNS или и того и другого.
Исходящий вызов вызов,  входящий вызов).
Партнер
При использовании в контексте L2TP,  партнер относится к LAC или LNS.
Партнером LAC является LNS и наоборот.  При использовании в контексте
PPP,  партнером является любая из сторон PPP-соединения.
POTS Plain Old Telephone Service  (обычная телефонная служба).
Удаленная система
Оконечная система или маршрутизатор,  соединенный с удаленной сетью
(т. e.  PSTN),  которая является инициатором или получателем вызова.
Относится также к клиенту,  подключающемуся через коммутируемую
телефонную сеть  (dial-up).
Сессия
Протокол L2TP ориентирован на соединение.  LNS и LAC поддерживают
состояния для каждого вызова,  который инициирован или воспринят LAC.
Сессия L2TP формируется между LAC и LNS,  когда создано соединение
точка-точка PPP между удаленной системой и LNS.  Дейтограммы,
относящиеся к соединению PPP,  пересылаются по туннелю,
организованному между LAC и LNS.  Существует полное соответствие
между сессиями L2TP и сопряженными с ними вызовами.   (Смотри также:
вызов).
Туннель
Туннель между LAC и LNS.  Туннель состоит из управляющего соединения и
нуля или более сессий L2TP.  Туннель передает инкапсулированные
дейтограммы PPP и управляющие сообщения между LAC и LNS.
Сообщение с нулевой длиной
тела  (ZLB)
Управляющий пакет,  имеющий только заголовок L2TP.  ZLB-сообщения
используются в качестве откликов в управляющем канале.
2. Топология
На диаграмме  (рис.  1. ) показана схема работы протокола L2TP.  Целью здесь является туннелирование кадров PPP
между удаленной системой или клиентом LAC и LNS,  размещенной в LAN.
Рис.  1.  Схема работы протокола L2TP
10.10.13 4.4.1.3 Протокол туннелей на сетевом у ровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 4/41
Удаленная система инициирует PPP-соединение с LAC через коммутируемую телефонную сеть PSTN.  LAC затем
прокладывает туннель для PPP-соединения через Интернет,  Frame Relay или ATM к LNS,  посредством чего
осуществляется доступ к исходной LAN  (Home LAN).  Адреса удаленной системе предоставляются исходной LAN
через согласование с PPP NCP.  Аутентификация,  авторизация и аккоунтинг могут быть предоставлены областью
управления LAN,  как если бы пользователь был непосредственно соединен с сервером сетевого доступа NAS.
LAC-клиент  (ЭВМ,  которая исполняет программу L2TP) может также участвовать в туннелировании до исходной
LAN без использования отдельного LAC.  В этом случае,  ЭВМ,  содержащая программу LAC клиента,  уже имеет
соединение с Интернет.  Затем создается "виртуальное" PPP-соединение и локальная программа L2TP LAC
формирует туннель до LNS.  Как и в выше описанном случае,  адресация,  аутентификация,  авторизация и аккоунтинг
будут обеспечены областью управления исходной LAN.
3. Обзор протокола
L2TP использует два вида пакетов,  управляющие и информационные сообщения.  Управляющие сообщения
используются при установлении,  поддержании и аннулировании туннелей и вызовов.  Информационные сообщения
используются для инкапсуляции PPP-кадров пересылаемых по туннелю.  Управляющие сообщения используют
надежный контрольный канал в пределах L2TP,  чтобы гарантировать доставку  (смотри раздел 5. 1).
Информационные сообщения если происходит их потеря,  не пересылаются повторно.
PPP кадры
L2TP Информационные сообщения L2TP Управляющие сообщения
L2TP Информационный канал  (ненадежный) L2TP Канал управления  (надежный)
Транспортировка пакетов  (UDP,  FR,  ATM,  etc. )
Рис.  2. 0.  Структура протокола L2TP
На рис.  2. 0 показано взаимоотношение PPP-кадров и управляющих сообщений по управляющему и
информационному каналам L2TP.  PPP-кадры передаются через ненадежный канал данных,  инкапсулированные
сначала в L2TP,  а затем в транспортные пакеты,  такие как UDP,  Frame Relay,  ATM и т. д. .  Управляющие сообщения
посылаются через надежный управляющий канал L2TP,  который передает пакеты в пределах того же пакетного
транспорта.
Порядковые номера необходимы во всех управляющих сообщениях и используются в управляющем канале для
обеспечения надежной доставки.  Информационные сообщения могут использовать порядковые номера,  чтобы
восстановить порядок пакетов и детектировать потерю кадров.  Все коды посылаются в порядке,  принятом для
сетей  (старшие октеты первые).
3.1. Формат заголовка L2TP
Пакеты L2TP для контрольного и информационного каналов используют один и тот же формат заголовка.  Заметим,
что поля длина,  Ns и Nr - опционные для информационных пакетов,  являются обязательными для всех
управляющих сообщений.
Заголовок имеет следующий формат:
0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16           31
T L X X S X O P X X X X Версия Длина  (опц)
ID туннеля ID сессии
10.10.13 4.4.1.3 Протокол туннелей на сетевом у ровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 5/41
Рис.  3.  Формат заголовка L2TP
Бит тип  (T) характеризует разновидность пакета.  Он устанавливается равным 0 для информационных сообщений и 1
- для управляющих.
Если бит длины  (L) равен 1,  поле длина присутствует.  Для управляющих сообщений этот бит должен быть равен 1.
Биты x зарезервированы для будущих применений.  Все зарезервированные биты должны быть установлены
равными 0 для исходящих сообщений и игнорироваться для входящих.
Если бит последовательности  (S) равен 1,  поля Ns и Nr  присутствуют.  Бит S для управляющих сообщений должен
быть равен 1.
Если бит смещения  (O) равен 1,  поле величины смещения присутствует.  Бит O для управляющих сообщений должен
быть равен 0.
Если бит приоритета Р равен 1,  это информационное сообщение должно обслуживаться с предпочтением при
обработке очередей и передаче.  Запрос эхо LCP  (Link Control Protocol) используется для канала,  в качестве контроля
keepalive,  его следует посылать с битом приоритета равным 1.  Без этого,  временные периоды локальной перегрузки
могут вызвать интерференцию с сообщениями keepalive и потерю связи.  Эта особенность характерна только для
информационных сообщений.  Бит P должен быть равен 0 для всех управляющих сообщений.
Поле Ver должно быть равно 2,  указывая версию заголовка информационного сообщения L2TP.  Значение 1
зарезервировано для детектирования пакетов L2F  [RFC-2341],  в условиях,  когда они приходят вперемешку с L2TP-пакетами.
Пакеты,  полученные с неизвестным значением поля Ver должны отбрасываться.  Поле длина указывает
общую длину сообщения в октетах.
ID-туннеля содержит идентификатор управляющего соединения.  Идентификаторы туннеля L2TP имеют только
локальное значение.  То есть,  разные концы одного туннеля должны иметь разные  ID.   ID-туннеля в каждом
сообщении должно быть тем,  которое ожидает получатель.   ID-туннеля выбираются при формировании туннеля.
ID-сессии определяет идентификатор для сессии данного туннеля.  Сессии L2TP именуются с помощью
идентификаторов,  которые имеют только локальное значение.   ID-сессии в каждом сообщении должно быть тем,
которое ожидает получатель.   ID-сессии выбираются при формировании сессии.
Ns определяет порядковый номер информационного или управляющего сообщения,  начиная с нуля и увеличиваясь
на 1  (по модулю 2
16
) для каждого посланного сообщения.  Смотри разделы 5. 8 и 5. 4.
Nr  содержит порядковый номер,  который ожидается для следующего сообщения.  Таким образом,  Nr  делается
равным Ns последнего по порядку полученного сообщения плюс один  (по модулю 2
16
).  В информационных
сообщениях,  Nr  зарезервировано и,  если присутствует  (как это определяется S- битом),  должно игнорироваться при
получении.  Смотри раздел 5. 8.
Поле величина смещения  (Offset Size),  если имеется,  специфицирует число октетов после заголовка L2TP,  где
должно начинаться поле данных.  Содержимое заполнителя смещения не определено.  Если поле смещения
присутствует,  заголовок L2TP завершается после завершающего октета заполнителя смещения.
3.2. Типы управляющих сообщений
Тип сообщения AVP  (смотри раздел 4. 4. 1) определяет специфический тип посылаемого управляющего сообщения.
В данном документе определены следующие типы управляющих сообщений  (смотри разделы 6. 1 - 6. 14):
Управление контрольным соединением
0 (зарезервировано)
1 (SCCRQ) Star t-Control-Connection-Request
2 (SCCRP) Star t-Control-Connection-Reply
3 (SCCCN) Star t-Control-Connection-Connected
4 (StopCCN) Stop-Control-Connection-Notification
5 (зарезервировано)
10.10.13 4.4.1.3 Протокол туннелей на сетевом у ровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 6/41
6 (HELLO) Hello
Управление вызовами  (Call Management)
7 (OCRQ) Outgoing-Call-Request
8 (OCRP) Outgoing-Call-Reply
9 (OCCN) Outgoing-Call-Connected
10 (ICRQ) Incoming-Call-Request
11 (ICRP) Incoming-Call-Reply
12 (ICCN) Incoming-Call-Connected
13 (зарезервировано)
14 (CDN) Call-Disconnect-Notify
Сообщения об ошибках
15 (WEN) WAN-Er ror-Notify
Управление сессией PPP
16 (SLI) Set-Link-Info
4. Пары значений-атрибутов управляющих
сообщений
4.1. Формат AVP
Каждая AVP кодируется следующим образом:
0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31
M H rsvd Длина ID производителя
Тип атрибута Значение атрибута
Продолжение поля значение атрибута до границы,  заданной полем длина
Рис.  4.
Первые 6 бит представляют собой битовую маску,  характеризующую атрибуты AVP.
Два бита определены в этом документе,  остальные - зарезервированы на будущее.  Зарезервированные биты
должны равняться нулю.  AVP,  полученная с зарезервированным набором бит равным 1,  должна рассматриваться
как не узнанная AVP.
Обязательный бит M  (Mandatory) контролирует реакцию системы на получение нераспознанной AVP.  Если бит
M =1 для нераспознанной AVP в сообщении,  ассоциированном с определенной сессией,  эта сессия должна быть
немедленно завершена.  Если бит M =1 для нераспознанной AVP в сообщении,  ассоциированном со всем туннелем,
этот туннель  (и все его сессии) должен быть ликвидирован.  Если бит M =0,  нераспознанную AVP следует
игнорировать.  Управляющие сообщения должны обрабатываться при этом так,  как если бы AVP не было.
Бит  сокрытия  (H).  Идентифицирует скрываемые данные в поле значения атрибута AVP.  Эта возможность может
использоваться,  чтобы исключить передачу важных данных,  например пароля пользователя,  в незашифрованном
тексте AVP.  В разделе 4. 3 описана процедура выполнения сокрытия AVP.
Длина.  Число октетов  (включая поля полной длины и маски) в AVP.  Длина может быть вычислена как 6 + длина
10.10.13 4.4.1.3 Протокол туннелей на сетевом у ровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 7/41
поля значения атрибута в октетах.  Поле имеет 10 бит,  позволяя закодировать до 1023 октетов в одной AVP.
Минимальный код длины AVP равен 6.  Если длина равна 6,  поле значения атрибута отсутствует.
ID производителя  (Vendor   ID).   IANA определила значения кодов производителей  (SMI Network Management
Pr ivate Enterpr ise Codes)  [RFC1700].  Значение 0,  соответствующее атрибутам,  адаптированным для  IETF,
используется для всех AVP,  определенных в данном документе.  Любой производитель,  желающий реализовать свое
собственное расширение L2TP,  может использовать свой код Vendor  ID вместе с частными значениями атрибута,
гарантирующие отсутствие столкновений с любыми расширениями других производителей,  или будущими
расширениями  IETF.  Заметим,  что для  ID-производителя выделено 16 бит,  что ограничивает максимальное число
производителей цифрой 65, 535.
Тип атрибута:  2-октетное значение с уникальной интерпретацией для совокупности AVP данного  ID-производителя.
Значение атрибута.  Действительное значение атрибута для заданного Vendor   ID и типа атрибута.  Оно следует
немедленно после поля типа атрибута,  и занимает все пространство октетов,  отведенное значением поля длина  (т. e. ,
длина минус 6 октетов заголовка).  Это поле отсутствует,  если длина равна 6.
4.2. Обязательные AVP
Получение неизвестной AVP,  которая имеет бит M=1,  является катастрофическим для сессии или туннеля,  с которым
она ассоциирована.  Таким образом,  бит M должен быть определен только для AVP,  которые критичны для
нормальной работы сессии или туннеля.  Далее,  в случае,  когда LAC  (L2TP access Concentrator ) или LNS  (L2TP
Network Server ) получают неизвестную AVP с M-битом равным 1 и закрывают сессию или туннель,  ответственность
за это полностью несет партнер,  пославший обязательную AVP.  Прежде чем определить AVP с M=1,  в особенности
AVP специфичное для данного производителя,  убедитесь в том,  что вы именно этого хотите.
Когда имеется адекватная альтернатива использованию M-бита,  ей следует воспользоваться.  Например,  вместо того,
чтобы посылать AVP с M=1 для определения существования специфического расширения,  можно решить проблему
путем посылки AVP в сообщении-запросе в расчете на получение соответствующего AVP в отклике.
Использование M-бита с новыми AVP  (не определенными в этом документе) должно предоставить возможность
сконфигурировать программу так,  чтобы AVP либо не посылалась,  или посылалась с M-битом равным нулю.
4.3. Сокрытие значений атрибутов AVP
Бит H в заголовке каждой AVP предлагает механизм указания принимающему партнеру,  представлено ли
содержимое AVP скрытым или открытым текстом.  Эта возможность применяется,  чтобы скрыть важную
информацию управляющих сообщений,  такую как пароль пользователя или его  ID.
Бит H должен быть равен 1,  если имеется общий ключ для LAC и LNS.  Этот ключ является тем же ключом,  который
использовался для аутентификации туннеля  (смотри раздел 5. 1. 1).  Если бит H =1 в любой AVP в данном
управляющем сообщении,  там должен также присутствовать случайный вектор AVP и должен предшествовать
первому AVP,  имеющему H = 1.
Сокрытие значения AVP делается за несколько шагов.  Сначала берутся поля длины и значения оригинала  (открытый
текст) AVP и кодируются согласно субформата скрытого AVP:
0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31
Длина значения оригинала Значение оригинала атрибута
Продолжение  значения оригинала атрибута Заполнитель
Рис 5.  Субформат скрытого AVP
Исходная длина  значения атрибута.  Это длина кода исходного значения атрибута,  которое следует закрыть,  в
октетах.  Необходимо определить исходную длину значения атрибута,  так как ее значение теряется при добавлении
10.10.13 4.4.1.3 Протокол туннелей на сетевом у ровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 8/41
заполнителя.
Исходное  значение атрибута.  Значение атрибута,  которое должно быть скрыто.
Заполнитель. Произвольные дополнительные октеты,  используемые для того,  чтобы скрыть длину значения
атрибута,  когда необходимо скрыть само значение.
Чтобы замаскировать размер скрытого поля данных,  используемый субформат может быть дополнен некоторым
количеством произвольных октетов.  Заполнитель не меняет значения поля,  но изменяет величину поля длина AVP,
которое было сформировано.  Например,  если значение атрибута,  которое необходимо скрыть,  занимает 4 октета,
исходная длина AVP будет равна 10 октетам  (6 + длина поля значения атрибута).  После операции сокрытия,  длина
AVP станет равной 6 + длина атрибута + размер поля длины исходного значения атрибута + длина заполнителя.
Таким образом,  если заполнитель имеет 12 октетов,  длина AVP будет равна 6 + 4 + 2 + 12 = 24 октетам.  Далее,
производится хэширование  (MD5) для полученного объединения:
+ 2 октета номера атрибута AVP
+ общий секретный ключ
+ случайный вектор произвольной длины
Значение случайного вектора,  используемого в этом хэше,  передается в поле случайный вектор AVP.  Этот
случайный вектор AVP должен быть помещен в сообщение отправителем до любого скрытого AVP.  Тот же самый
случайный вектор может быть использован для более чем одного скрытого AVP сообщения.  Если для сокрытия
последующих AVP используется другой случайный вектор,  тогда новый случайный вектор AVP должен быть
помещен в командное сообщение до первого его использования.
Значение хэша MD5 затем объединяется с помощью операции XOR с первыми 16 октетами сегмента субформата
скрытого AVP и помещается в поле значения атрибута скрытого AVP.  Если субформат скрытого AVP имеет менее
16 октетов,  субформат преобразуется так,  как если бы поле значения атрибута было дополнено до 16 октетов перед
операцией XOR,  но модифицируются только действительные октеты,  присутствующие в субформате,  а длина AVP
не изменяется.
Если субформат длиннее 16 октетов,  вычисляется второй хэш MD5 для потока октетов,  состоящего из общего
секретного ключа,  за которым следует результат первой операции XOR.  Этот хэш объединяется с помощью
операции XOR со вторым 16 октетным  (или менее) сегментом субформата,  а результат помещается в
соответствующие октеты поля значения скрытого AVP.
Если необходимо,  эта операция повторяется,  для общего секретного ключа,  используемого совместно с каждым
результатом операции XOR,  чтобы получить очередной хэш,  для которого будет выполняться XOR с кодом
следующего сегмента.
Метод сокрытия был адаптирован из RFC 2138  [RFC2138],  который был взят из секции "Mixing  in  the Plaintext" книги
"Network Secur ity" Кауфмана,  Пелмана и Спенсера  [KPS].  Ниже дается детальное пояснение метода:
Берется общий секретный ключ S,  случайный вектор RV и значение атрибута AV.  Поле значение делится на секции
по 16 октетов p1,  p2 и т. д.  Последняя секция дополняется до границы в 16 октетов специальным заполнителем.
Вычисляются блоки шифротекста c(1),  c(2),  и т. д.  Мы также определяем промежуточные значения b1,  b2,  и т. д.
b1 = MD5(AV + S + RV) c(1) = p1 xor  b1
b2 = MD5(S + c(1)) c(2) = p2 xor  b2
. .
. .
. .
bi = MD5(S + c(i-1)) c(i) = pi xor  bi
строка будет содержать c(1)+c(2)+. . . +c(i) где + означает объединение.
По получение,  случайный вектор берется из AVP,  включенного в сообщение до AVP,  подлежащего сокрытию.
Описанный выше процесс реверсируется с целью получения исходного значения.
10.10.13 4.4.1.3 Протокол туннелей на сетевом у ровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 9/41
4.4. Обзор AVP
Имя AVP является списком,  указывающим типы сообщений,  которые использует каждая AVP.  После каждого
названия AVP следует короткое описание назначения AVP,  подробности формата значения атрибута,  и любая
дополнительная информация,  необходимая для правильного использования AVP.
4.4.1.  AVP,  применимые для всех управляющих сообщений
Тип  сообщения  (все  сообщения)
Тип сообщения AVP,  тип атрибута 0,  идентифицируют управляющее сообщение и определяет контекст,  в котором
будет определено точное значение последующих AVP.  Поле значения атрибута для этой AVP имеет следующий
формат:
0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
Тип сообщения
Рис.  6
Тип  сообщения характеризуется целым 2-октетным числом без  знака.
Тип сообщения AVP должен быть первым AVP в сообщении,  который следует непосредственно сразу за заголовком
управляющего cообщения  (определено в разделе 3. 1).  Список типов управляющих сообщений и их
идентификаторов смотри в разделе 3. 2.
Обязательный бит  (M) в типе сообщения AVP имеет специальное назначение.  Этот бит служит скорее не для
указания того,  следует ли игнорировать саму AVP,  если бы она не распознана,  а указанием того,  что при не
распознании следует игнорировать управляющее сообщение.  Таким образом,  если M-бит равен 1 в типе сообщения
AVP,  а тип сообщения неизвестен программе,  туннель должен быть ликвидирован.  Если бит M=0,  тогда программа
может игнорировать сообщения неизвестных типов.  M-бит должен быть сделан равным 1 для всех типов
сообщений определенных в данном документе.  Эта AVP не может быть скрытой  (H-бит должен быть равен нулю 0).
Длина этого AVP равна 8.
Случайный вектор  (все  сообщения)
Случайный вектор AVP,  тип атрибута 36,  используются для разрешения сокрытия значения атрибута AVP.
Случайная последовательность октетов может иметь произвольную длину,  хотя для случайного вектора
рекомендуется длина,  по крайней мере,  16 октетов.  Строка содержит случайный вектор для использования при
вычислении хэша MD5 чтобы извлечь или скрыть значение атрибута скрытого AVP  (смотри раздел 4. 2).
В сообщении может быть более одного случайного вектора AVP.  Эта AVP должна предшествовать первому AVP с
битом H =1.
M-бит для этого AVP должно быть равно 1.  Это AVP не должно быть скрыто  (H-бит должен быть равен 0).  Длина
этого AVP равно 6 плюс длина случайной строки октетов.
4.4.2.  Коды результата и ошибки
Результирующий код  (CDN, StopCCN)
Результирующий код AVP,  тип атрибута - 1,  индицируют причину завершения работы управляющего канала или
сессии.  Поле значения атрибута AVP имеет следующий формат:
0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31
10.10.13 4.4.1.3 Протокол туннелей на сетевом у ровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 10/41
Код результата Код ошибки  (опц.)
Сообщение об ошибке  (опц.)
Рис.  7.  Формат поля значения атрибута AVP
Результирующий код представляет собой целое число без знака длиной в 2 октета.  Опционный код ошибки
представляет собой 2-октетное целое число без знака.  Опционное сообщение об ошибке поясняет код ошибки.
Присутствие кода ошибки и сообщения определяется полем длины AVP.  Сообщение об ошибке содержит
произвольную строку текста,  пригодного для чтения,  характеризующего ситуацию.  Читабельный текст во всех
сообщений об ошибке должен быть представлен в кодировке UTF-8,  для языка по умолчанию  [RFC2277].
Эта AVP не должна быть скрытой  (H-бит должен быть равен 0).  M-бит для этой AVP должен быть равен 1.  Длина
равна 8,  если в сообщении нет кода ошибки и нет сообщения об ошибке,  10,  если имеется код ошибки,  но нет
сообщения об ошибке,  или 10 + длина сообщения об ошибке,  если имеется код и сообщение об ошибке.
Определенные значения кодов результата для сообщения StopCCN перечислены ниже:
0.   Зарезервировано
1.   Общий запрос ликвидации управляющего соединения
2.   Общая ошибка - код ошибки указывает на разновидность возникшей проблемы
3.   Управляющий канал уже существует
4.   Источник запроса не авторизован для формирования управляющего канала
5.   Версия протокола источника запроса не поддерживается.  Код ошибки указывает на более высокую
поддерживаемую версию
6.   Источник запроса прекратил работу  (shutdown)
7.   Ошибка машины конечных состояний
Определены следующие значения кодов результата для сообщений CDN:
0 - Зарезервировано
1 - Вызов прерван из-за потери несущей.
2 - Вызов прерван по причине,  указанной в коде ошибки
3 - Вызов прерван по административным причинам
4 - Вызов не прошел из-за отсутствия необходимых условий  (временная причина)
5 - Вызов не прошел из-за отсутствия необходимых условий  (постоянная причина)
6 - Неверное место назначения
7 - Вызов не прошел из-за невозможности детектировать несущую
8 - Вызов не прошел из-за регистрации сигнала “занято”
9 - Вызов не прошел из-за отсутствия постоянного гудка  (разрешение набора номера)
10 - Вызов не состоялся в пределах временного интервала,  выделенного LAC
11 - Вызов реализовал соединение,  но не обнаружено соответствующих кадров
Коды ошибок,  определенные ниже,  относятся к типам ошибок,  которые не являются специфическими для любого
конкретного L2TP-запроса,  и относятся скорее к ошибкам протокола или формата сообщения.  Если L2TP-отклик
указывает в своем коде результата,  что произошла общая ошибка,  для выяснения причины должен быть
проанализирован общий код ошибки.  В настоящее время определены общие коды ошибки и их значение:
0.   Отсутствие ошибки.
1.   Пока нет контрольного соединения для данной пары LAC-LNS.
2.   Длина не корректна.
3.   Одно из значений полей находится вне допустимых пределов или зарезервированное поле имеет ненулевое
значение.
4.   Недостаточно ресурсов для осуществления операции
5.   ID-сессии не верно в данном контексте
6.   Произошла ошибка в LAC,  специфическая для оборудования производителя.
7.   Испробовать другое место назначение.  Если LAC знает о других возможных местах назначения LNS,  следует
попробовать одно из них.  Это может быть использовано для управления LAC,  базирующемся на LNS-политике,
например,  в случае существования многоканальных PPP.
8.   Сессия или туннель были аннулированы  (shutdown) из-за получения неизвестной AVP с битом M=1  (смотри
раздел 4. 2).  Сообщение об ошибке должно содержать атрибут некорректного AVP в читаемой текстовой
форме.
10.10.13 4.4.1.3 Протокол туннелей на сетевом у ровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 11/41
Когда используется код общей ошибки = 6,  дополнительная информация об ошибке должна быть помещена в поле
сообщения об ошибке.
4.4.3.  AVP управления контрольным соединением
Версия протокола  (SCCRP, SCCRQ)
Версия протокола AVP,  тип атрибута - 2,  указывает на версию протокола L2TP отправителя.  Поле значения атрибута
для данной AVP имеет следующий формат:
0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
Ver Rev
Рис.  8.  Поле значения атрибута для AVP управления контрольным соединением
Поле Ver характеризуется целым числом без знака длиной в один октет и содержит код 1.  Поле Rev характеризуется
целым числом без знака длиной в один октет и содержит код 0.  Так характеризуется версия протокола L2TP 1,  и
модификация версии 0.  Заметим,  что это не тот же код версии,  что включается в заголовок каждого сообщения.
Эта AVP не должна быть скрытой  (бит H должен быть равен 0).  Бит M для данной AVP должен быть равен 1.  Длина
этой AVP равна 8.
Возможность работы  с кадрами  (SCCRP, SCCRQ)
Возможность работы с кадрами AVP,  тип атрибута - 3,  предоставляет партнеру указание на типы кадров,  которые
будут приняты или запрошены отправителем.  Поле значения атрибута для этого AVP имеет следующий формат:
0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31
Зарезервировано для будущих определений типа кадрового обмена A S
Рис.  9.  Поле значения атрибута для AVP возможности работы с кадрами
Поле значения атрибута представляет собой 32-битовую маску,  с двумя определенными битами.  Если бит A=1,
поддерживается асинхронный обмен кадрами.  Если бит S=1,  поддерживается синхронный обмен кадрами.
Партнер не должен запрашивать входящий или исходящий вызов с кадровым типом AVP,  специфицирующим
значение,  не указанное в AVP,  которые были получены при установлении управляющего соединения.  Такая попытка
приведет к тому,  что вызов будет отвергнут.
Эта AVP может быть скрытой  (H-бит может быть 0 или 1).  M-бит для этого AVP должен быть равен 1.  Длина  (до
сокрытия) равна 10.
Возможности носителя  (SCCRP, SCCRQ)
AVP возможностей носителя,  тип атрибута - 4,  предоставляют партнеру указание на типы носителя,
поддерживаемые аппаратным интерфейсом отправителя для исходящих вызовов.  Поле значения атрибута для этого
AVP имеет следующий формат:
0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31
Зарезервировано для будущих определений типа несущей среды A D
Рис.  10.  Поле значения атрибута для AVP возможности носителя
Это 32-битная маска,  с двумя определенными битами.  Если бит A =1,  поддерживается аналоговый доступ.  Если бит
D =1,  поддерживается цифровой доступ.
10.10.13 4.4.1.3 Протокол туннелей на сетевом у ровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 12/41
LNS не должен запрашивать исходящих вызовов,  специфицирующих значение в AVP типа носителя для приборов,
неуказанных в AVP типа носителя,  полученных от LAC при установлении управляющего соединения.  Такая
попытка приведет к тому,  что вызов будет отвергнут.  Эти AVP должны присутствовать,  если отправитель может
осуществлять исходящие вызовы,  когда это требуется.
Заметим,  что LNS,  который не может работать как LAC,  а также не поддерживает оборудование для обработки
входящих и исходящих вызовов,  должен установить биты A и D этого AVP равными 0,  или не должен вообще
посылать AVP.  LNS,  который может работать в качестве LAC,  и направлять исходящие вызовы,  должен
устанавливать биты A или D так,  как это нужно.  Присутствие этого сообщения не гарантирует того,  что данный
исходящий вызов будет направлен отправителем,  если это потребуется,  хотя такая возможность и существует.
Эта AVP может быть скрытой  (бит H может быть 0 или 1).  M-бит для этой AVP должен быть равен 1.  Длина  (до
сокрытия) равна 10.
Арбитр конфликта  (Ti e Breaker  (SCCRQ))
AVP арбитра конфликта,  тип атрибута - 5,  указывает,  что отправитель желает иметь один туннель между заданной
парой LAC-LNS.
Значение Tie Breaker характеризуется 8-октетным кодом,  который используется для выбора одного туннеля,  когда
LAC и LNS требуют формирования туннеля одновременно.  Получатель SCCRQ должен проверить,  был ли послано
партнеру SCCRQ и,  если это так,  должен сравнить свое значение Tie Breaker с полученным.  Более низкое значение
"wins" и "loser " должно вызвать молчаливую ликвидацию туннеля.  В случае,  когда код арбитра присутствует на
обеих сторонах и значения равны,  обе стороны должны ликвидировать туннели.  Если получен  tie breaker,  а
невыполненный просроченный SCCRQ не имеет значения  tie breaker ,  инициатор,  который включает AVP Tie Breaker
"выигрывает".  Если ни одна из сторон не посылает Tie Breaker,  тогда открываются два туннеля.
Эта AVP не должна быть скрытой  (H-бит должен быть равен 0).  M-бит для этого AVP должен быть равен 0.  Длина
этой AVP равна 14.
Фирменная версия  (Fi rmware Revi si on)  (SCCRP, SCCRQ)
Фирменная версия AVP,  тип атрибута 6,  указывает на фирменную версию прибора,  пославшего сообщение.
Поле фирменная версия имеет 2 октета и представляется целым числом без знака,  закодированным в формате,
который определяется фирмой.
Для приборов,  которые не имеют кода фирменной версии  (универсальные ЭВМ,  где,  например,  работают
программные модули L2TP),  вместо этого может быть сообщена модификация программных модулей L2TP.
Эта AVP может быть скрыта  (H-бит может быть равен 0 или 1).  M-бит для этой AVP должен быть равен 0.  Длина  (до
сокрытия) равна 8.
Имя ЭВМ  (SCCRP, SCCRQ)
AVP имени ЭВМ,  тип атрибута 7,  указывает на имя ЭВМ,  реализующей функцию LAC или LNS.
Имя ЭВМ имеет переменную длину,  но должно иметь,  по крайней мере,  один октет.  Это имя должно быть
максимально уникальным;  для ЭВМ,  участвующих в DNS  [RFC1034],  следует выбирать полное имя домена.
Эта AVP не должна быть скрыта  (H-бит должен быть 0).  M-бит для этой AVP должен быть равен 1.  Длина этой AVP
равна 6 плюс длина имени ЭВМ.
Имя производителя  (SCCRP, SCCRQ)
AVP имени производителя,  тип атрибута 8,  содержит специфическую для производителя строку,  которая
характеризует тип используемого LAC или LNS.
Имя производителя представляет собой строку октетов произвольной длины.  Для обеспечения читаемости текст
этой AVP должен быть представлен с помощью символьного набора UTF-8 на языке,  выбранном по умолчанию
[RFC2277].
Эта AVP может быть скрытой  (H-бит может быть 0 или 1).  M-бит для данной AVP должен быть равен 0.  Длина  (до
сокрытия) этой AVP равна 6 плюс длина имени производителя.
10.10.13 4.4.1.3 Протокол туннелей на сетевом у ровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 13/41
ID, присвоенное  туннелю  (SCCRP, SCCRQ, StopCCN)
AVP  ID,  присвоенного туннелю,  тип атрибута 9,  несет в себе  ID,  присвоенное туннелю отправителем.   ID,  присвоенное
туннелю,  содержит в себе 2-октетное целое неравное нулю число без знака.
AVP  ID,  присвоенное туннелю,  определяет код,  используемый при мультиплексировании и демультиплексировании
в случае работы с несколькими туннелями между LNS и LAC.  Партнер L2TP должен помещать этот код в поле
заголовка  ID-туннеля всех управляющих и информационных сообщений,  пересылаемых через туннель.  Пока от
партнера не получена AVP с присвоенным  ID-туннеля,  управляющие сообщения должны посылаться этому
партнеру со значением  ID-туннеля = 0.
В управляющем сообщении StopCCN,  AVP ID,  присвоенного туннелю,  должно быть тождественно AVP  ID,
присвоенного туннелю,  посланному первым,  позволяя партнеру идентифицировать соответствующий туннель,  даже
если сообщение StopCCN послано до получения AVP  ID.
Эта AVP может быть скрытой  (H-бит может быть 0 или 1).  M-бит для этой AVP должен быть равен 1.  Длина  (до
сокрытия) этой AVP равна 8.
Размер приемного окна  (Receive WindowSize  (SCCRQ, SCCRP))
Размер приемного окна AVP,  тип атрибута 10,  специфицирует размер приемного окна,  которое предлагает
удаленный партнер.  Размер окна характеризуется 2-октетным целым числом без знака.
Если размер окна отсутствует,  партнер должен предполагать этот код равным 4.  Удаленный партнер может послать
специфицированный номер управляющего сообщения,  прежде чем ожидать отклика.
Эта AVP не должна быть скрытой  (H-бит должен быть равен 0).  M-бит для этой AVP должен быть равен 1.  Длина
этой AVP равна 8.
Приглашение  (Challenge  (SCCRP, SCCRQ))
AVP приглашения,  тип атрибута 11,  указывает,  что отправивший его партнер хочет аутентифицировать концы
туннеля,  используя CHAP-стиль аутентификационного механизма.  Вызов содержит один или более октетов
произвольной информации.
Эта AVP может быть скрытой  (бит H может быть 0 или 1).  M-бит для этой AVP должен быть равен 1.  Длина  (до
сокрытия) этой AVP равна 6 плюс длина приглашения  (challenge).
Отклик на приглашение  (Challenge Response  (SCCCN, SCCRP))
AVP отклика,  тип атрибута 13,  направляет ответ на полученное сообщение.
Поле отклик содержит 16 октетов,  соответствуя CHAP-стилю  [RFC1994] отклика на вызов.
Эта AVP должна присутствовать в SCCRP или SCCCN,  если приглашение было получено в предыдущем SCCRQ или
SCCRP.  Для целей вычисления значения  ID в CHAP-отклике используется код типа сообщения AVP для этого кадра
(например,  2 для SCCRP,  и 3 для SCCCN).
Эта AVP может быть скрытой  (бит H может быть 0 или 1).  M-бит для этой AVP должен быть равен 1.  Длина  (до
сокрытия) этой AVP равна 22.
4.4.4.  AVP управления вызовом
Q. 931 код причины  (CDN)
AVP,  тип атрибута 12,  используется,  чтобы предоставить дополнительную информацию в случае
непреднамеренного разрыва соединения.  Поле значения атрибута для этого AVP имеет следующий формат:
0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31
Код причины Сообщение причины Сообщение-рекомендация
10.10.13 4.4.1.3 Протокол туннелей на сетевом уровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 14/41
Рис.  11.  Поле значения атрибута для AVP кода причины Q. 931
В качестве кода причины присылается код Q. 931,  а в качестве сообщения причины - сообщение Q. 931  (например,
DISCONNECT),  ассоциированное с кодом причины.  Оба кода присылаются в их исходных кодировках  ITU  [DSS1].
Дополнительный ASCI-текст сообщения-рекомендации может быть включен  (присутствие определяется с помощью
кода длины AVP) для дальнейшего уточнения причины отсоединения.
Эта AVP не должна быть скрытой  (H-бит должен быть равен 0).  M-бит для этой AVP должен быть равен 1.  Длина
этой AVP равна 9,  плюс размер сообщения Advisory.
ID, присвоенное  сессии  (CDN,  ICRP,  ICRQ, OCRP, OCRQ)
AVP  ID,  присвоенного сессии,  тип атрибута 14,  содержит  ID,  присвоенное сессии отправителем сообщения.   ID,
присвоенное сессии,  представляет собой 2-октетное целое,  ненулевое число без знака.
AVP  ID,  присвоенного сессии,  определяет код,  который используется для мультиплексирования и
демультиплексирования данных,  посылаемых через туннель между LNS и LAC.  Партнер L2TP должен поместить этот
код в поле заголовка  ID-сессии всех управляющих и информационных сообщений,  которые пересылаются по
туннелю в рамках данной сессии.  До того как от партнера придет AVP  ID,  присвоенного сессии,  управляющие
сообщения должны посылаться партнеру с  ID-сессии,  равным нулю.
В управляющем сообщении CDN,  используется первое AVP  ID-сессии,  полученное партнером,  позволяя партнеру
идентифицировать соответствующий туннель,  даже если CDN послано до получения  ID,  присвоенное сессии.
Эта AVP может быть скрытой  (бит H может быть 0 или 1).  M-бит для этой AVP должен быть равен 1.  Длина  (до
сокрытия) этой AVP равна 8.
Порядковый номер вызова  (ICRQ, OCRQ)
AVP порядкового номера вызова,  тип атрибута 15,  несет в себе идентификатор,  присвоенный данному вызову LAC
или LNS.  Порядковый номер вызова представляет собой 32-битовый код.
Порядковый номер вызова предназначен для удобного административного указателя для обоих концов туннеля,
когда необходимо проанализировать причину отказа.  Порядковые номера вызова должны быть монотонно
возрастающими числами,  которые должны быть уникальными для достаточно большого периода времени для всех
соединенных LNS и LAC.
Эта AVP может быть скрытой  (бит H может быть 0 или 1).  M-бит для этой AVP должен быть равен 1.  Длина  (до
сокрытия) этой AVP равна 10.
Максимальный BPS  (OCRQ)
AVP максимального BPS,  тип атрибута 16,  характеризует минимальную приемлемую скорость передачи канала для
данного вызова.
Максимальный BPS представляет собой 32-битовый код,  характеризующий скорость передачи в битах в секунду.
Эта AVP может быть скрытой  (бит H может быть 0 или 1).  M-бит для этой AVP должен быть равен 1.  Длина  (до
сокрытия) этой AVP равна 10.
Максимальный BPS  (OCRQ)
AVP максимального BPS,  тип атрибута 17,  характеризует максимальную приемлемую скорость канала для данного
вызова.
Максимальный BPS представляет собой 32-битный код,  характеризующий скорость передачи в битах в секунду.
Эта AVP может быть скрытым  (H-бит может быть 0 или 1).  M-бит для этого AVP должен быть равен 1.  Длина  (до
сокрытия) этого AVP равна 10.
Тип носителя  (ICRQ, OCRQ)
AVP типа носителя,  тип атрибута 18,  характеризует тип носителя для входящего или исходящего вызовов.  Поле
значения атрибута для этого AVP имеет следующий формат:
10.10.13 4.4.1.3 Протокол туннелей на сетевом у ровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 15/41
0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31
Зарезервировано для будущих определений типа несущей среды A D
Рис.  12.  Поле значения атрибута для AVP типа носителя
Тип носителя представляет собой 32-битовую маску,  которая характеризует возможности несущей среды для
вызова  (ICRQ) или требования к среде для данного вызова  (OCRQ).  Если бит A=1,  то вызов относится к аналоговому
каналу.  Если бит D=1,  то вызов относится к цифровому каналу.  Могут быть установлены оба бита,  что может
означать,  что тип канала не определен,  или допустима работа,  как с аналоговым,  так и цифровым каналами.
Биты в поле значение данной AVP должны устанавливаться LNS для OCRQ,  если они были установлены в AVP
возможностей носителя,  полученной от LAC в период установления управляющего соединения.
Можно не устанавливать ни A,  ни D-биты в  ICRQ.  Такая установка может означать,  что вызов не был получен по
физическому каналу  (например,  если LAC и PPP находятся в той же подсистеме).
Эта AVP может быть скрыта  (H-бит может быть 0 или 1).  M-бит этой AVP должен быть равен 1.  Длина  (до сокрытия)
этой AVP равна 10.
Тип кадрового обмена  (ICCN,  OCCN,  OCRQ)
AVP типа кадрового обмена,  тип атрибута 19,  характеризует тип кадров для входящих и исходящих вызовов.  Поле
значения атрибута для этого AVP имеет следующий формат:
0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31
Зарезервировано для будущих определений типа кадрового обмена A S
Рис.  13.  Поле значения атрибута для AVP типа кадрового обмена
Тип кадрового обмена представляет собой 32-битовую маску,  которая указывает тип кадрового обмена PPP,
запрошенный для OCRQ,  или тип кадрового обмена PPP,  согласованный для OCCN или  ICCN.  Тип кадрового обмена
может быть использован как указание PPP на LNS,  какую из канальных опций использовать для согласования с LCP
[RFC1662].
Бит A указывает на асинхронный обмен кадрами.  Бит S указывает на синхронный обмен кадрами.  Для OCRQ могут
быть установлены оба бита,  что будет означать допустимость обоих типов кадрового обмена.
Биты в поле значение этой AVP должны устанавливаться только LNS для OCRQ,  если они были установлены в AVP
возможностей кадрового обмена,  полученной от LAC в процессе установления управляющего соединения.  Эта AVP
может быть скрытой  (H-бит может быть 0 или 1).  M-бит для этой AVP должен быть равен 1.  Длина  (до сокрытия)
этой AVP равна 10.
Вызванный номер  (Called Number  (ICRQ, OCRQ))
AVP вызванного номера,  тип атрибута 21,  характеризует телефонный номер,  куда посылается вызов для OCRQ.
Вызванный номер представляет собой ASCII-строку произвольной длины.  Может быть необходим контакт между
администратором LAC и LNS для координации интерпретации значения,  необходимого данной AVP.
Эта AVP может быть скрытой  (бит H может быть 0 или 1).  M-бит для этой AVP должен быть равен 1.  Длина  (до
сокрытия) этой AVP равна 6 плюс длина телефонного номера.
Вызывающий номер  (Calling Number  (ICRQ))
AVP вызывающего номера,  тип атрибута 22,  содержит телефонный номер входящего вызова.
Вызывающий номер представляет собой ASCII-строку произвольной длины.  Может быть необходим контакт между
администратором LAC и LNS для координации интерпретации значения,  необходимого данной AVP.
10.10.13 4.4.1.3 Протокол туннелей на сетевом уровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 16/41
Эта AVP может быть скрытой  (бит H может быть 0 или 1).  M-бит для этой AVP должен быть равен 1.  Длина  (до
сокрытия) этой AVP равна 6 плюс длина телефонного номера.
Субадрес  (ICRQ, OCRQ)
AVP субадреса,  тип атрибута 23,  несет в себе дополнительную информацию по вызову.
Субадрес является ASCII-строкой.  Может быть,  необходим контакт между администратором LAC и LNS для
координации интерпретации значения,  необходимого данной AVP.
Эта AVP может быть скрытой  (бит H может быть 0 или 1).  M-бит для этой AVP должен быть равен 1.  Длина  (до
сокрытия) этой AVP равна 6 плюс длина субадреса.
Скорость канала  (Tx)  (Connect Speed  (ICCN, OCCN))
AVP скорости канала  (Tx) BPS,  тип атрибута 24,  характеризует быстродействие устройства,  выбранного для попытки
установления соединения.  Скорость канала  (Tx) BPS содержит 4 октета и характеризует скорость обмена в битах в
секунду.
Когда присутствует опционная AVP скорости соединения Rx,  значение этой AVP представляет быстродействие
канала с точки зрения LAC  (например,  скорость передачи данных,  передаваемых от LAC в удаленную систему).
Когда опционная AVP скорости соединения Rx отсутствует,  быстродействие канала между удаленной системой и
LAC предполагается симметричным и представляется одной величиной этой AVP.
Эта AVP может быть скрытой  (бит H может быть 0 или 1).  M-бит для этой AVP должен быть равен 1.  Длина  (до
сокрытия) этой AVP равна 10.
Скорость  соединения Rx  (Connect Speed  (ICCN, OCCN))
AVP скорости соединения Rx,  тип атрибута 38,  представляет скорость канала с точки зрения LAC  (например,
информация,  передаваемая от удаленной системы в LAC).  Поле значения атрибута для этого AVP имеет следующий
формат:
0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31
BPS  (H) BPS  (L)
Рис.  14.  Поле значения атрибута для AVP скорости соединения Rx
BPS имеет 4 октета,  характеризующие скорость обмена в битах в секунду.  Присутствие этой AVP означает,  что
быстродействие канала может быть асимметричным с учетом скорости передачи,  заданной в AVP скорости
соединения Rx.
Эта AVP может быть скрытой  (бит H может быть 1 или 0).  M-бит для этой AVP должен быть равен 0.  Длина  (до
сокрытия) этой AVP равна 10.
ID физического канала  (ICRQ, OCRP)
AVP  ID физического канала,  тип атрибута 25,  представляет код физического канала,  присвоенный ему
производителем,  и используемый при вызове.   ID физического канала имеет 4 октета и служит только для целей
регистрации.
Эта AVP может быть скрытой  (бит H может быть 0 или 1).  M-бит этой AVP должен быть равен 0.  Длина  (до сокрытия)
этой AVP равна 10.
ID частной  группы  (ICCN)
AVP  ID частной группы,  тип атрибута 37,  используется LAC для индикации того,  что этот вызов ассоциируется с
определенной группой клиентов.   ID частной группы представляет собой строку октетов произвольной длины.
LNS может воспринимать PPP-сессию,  а также сетевой трафик в рамках сессии специальным образом,
определенным партнером.  Например,  если LNS соединен с несколькими частными сетями,  использующими
незарегистрированные адреса,  эта AVP может быть включена LAC,  чтобы индицировать,  что данный вызов должен
10.10.13 4.4.1.3 Протокол туннелей на сетевом у ровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 17/41
быть ассоциирован с одной из частных сетей.
ID частной группы представляет собой строку,  соответствующую таблице в LNS,  которая определяет конкретные
характеристики выбранной группы.  LAC может определить  ID частной группы из отклика RADIUS,  локальной
конфигурации,  или некоторых других источников.
Эта AVP может быть скрытой  (H-бит может быть 1 или 0).  M-бит для этой AVP должен быть равен 0.  Длина  (до
сокрытия) этой AVP равна 6 плюс длина  ID частной группы.
Необходима нумерация  (Sequenci ng Requi red  (ICCN, OCCN))
AVP Sequencing Required,  тип атрибута 39,  сообщает LNS,  что порядковые номера должны всегда присутствовать в
информационном канале.  Эта AVP не имеет поля значения атрибута.
Эта AVP не должна быть скрытой  (H-бит должен быть 0).  M-бит этой AVP должен быть равен 1.  Длина этой AVP
равна 6.
4.4.5.  AVP прокси LCP и аутентификации
LAC может откликнуться на вызов и согласовать LCP с удаленной системой,  возможно для того чтобы установить
идентичность системы.  В этом случае,  эти AVP могут быть включены для индикации свойств канала,  которые
запросила удаленная система в исходном состоянии,  свойства,  согласованные удаленной системой и LAC после
согласования,  а также аутентификационная информация PPP,  полученная LAC.  Эта информация может быть
использована,  чтобы инициировать PPP LCP и аутентификационные системы в LNS,  позволяя PPP продолжить
работу без повторного согласования параметров с LCP.
LCP CONFREQ, полученный в исходном  состоянии  (ICCN)
В AVP,  полученного в исходном состоянии LCP CONFREQ,  тип атрибута 26,  предоставляет LNS исходное сообщение
CONFREQ,  полученное LAC от партнера PPP.
LCP CONFREQ является копией тела полученного исходного CONFREQ,  начиная с первой опции тела сообщения
LCP.  Длина поля значения атрибута LCP CONFREQ имеет произвольную длину.  Эта AVP может быть скрытой  (H-бит
может быть 0 или 1).  M-бит для этой AVP должен быть равен 0.  Длина  (до сокрытия) этой AVP равна 6 плюс длина
CONFREQ.
Последний посланный LCP CONFREQ  (ICCN)
В AVP последнего посланного LCP CONFREQ,  тип атрибута 27,  предоставляет LNS последнего CONFREQ,  посланного
LAC партнеру PPP.
LCP CONFREQ является копией тела финального CONFREQ,  посланного клиенту с целью завершения LCP-согласования,  начиная с первой опции тела LCP-сообщения.  Длина поля значения атрибута LCP CONFREQ имеет
произвольную длину.  Эта AVP может быть скрытой  (бит H может быть 0 или 1).  M-бит этой AVP должен быть равен
0.  Длина  (до сокрытия) этой AVP равна 6 плюс длина CONFREQ.
Последний полученный LCP CONFREQ  (ICCN)
AVP последнего полученного LCP CONFREQ,  тип атрибута 28,  предоставляет LNS последнего CONFREQ,
полученного концентратором LAC от PPP-партнера.
LCP CONFREQ является копией тела последнего CONFREQ,  полученного от клиента с целью завершения процедуры
согласования LCP,  начиная с первой опции тела LCP-сообщения.
Эта AVP может быть скрытой  (бит H может быть 0 или 1).  M-бит для этой AVP должен быть равен 0.  Длина  (до
сокрытия) этой AVP равна 6 плюс длина CONFREQ.
Тип прокси Authen  (ICCN)
AVP типа прокси Authen,  тип атрибута 29,  определяет,  должна ли использоваться прокси аутентификация.  Тип
Authen представляет собой 2-октетное целое число без знака.
Эта AVP может быть скрытой  (бит H может быть 0 или 1).  M-бит для этой AVP должен быть равен 0.  Длина  (до
10.10.13 4.4.1.3 Протокол туннелей на сетевом у ровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 18/41
сокрытия) этой AVP равна 8.  Определенные значения типа Authen:
0 - Зарезервировано
1 - Текстовой обмен имя пользователя/пароль
2 - PPP CHAP
3 - PPP PAP
4 - Никакой аутентификации
5 - Microsoft CHAP версия 1  (MSCHAPv1)
Эта AVP должна присутствовать,  если должна использоваться прокси аутентификация.  Если она отсутствует,  тогда
предполагается,  что этот партнер не может выполнить прокси аутентификацию,  необходимую для повторного
запуска фазы аутентификации в LNS,  если клиент уже вошел в эту фазу с LAC  (который может быть определен AVP
Proxy LCP,  если имеется).  Далее описаны соответствующие AVP для каждого типа аутентификации.
Имя прокси Authen  (ICCN)
AVP имени прокси Authen,  тип атрибута 30,  специфицирует имя аутентифицируемого клиента при использовании
прокси аутентификации.
Имя Authen является строкой октетов произвольной длины.  Оно содержит имя,  специфицированное в отклике
аутентификации клиента.
Эта AVP должна присутствовать в сообщениях,  содержащих AVP типа Proxy Authen с типом Authen 1,  2,  3 или 5.
Может быть,  желательно применить AVP-сокрытие для защиты имени,  представленного открытым текстом.  Эта AVP
может быть скрытой  (H-бит может быть 0 или 1).  M-бит для этой AVP должен быть равен 0.  Длина  (до сокрытия)
равна 6 плюс длина имени.
Приглашение прокси Authen  (ICCN)
AVP приглашения прокси Authen,  тип атрибута 31,  специфицирует приглашение,  посланное LAC партнеру PPP при
использовании прокси аутентификации.  Приглашение представляет собой строку из одного или более октетов.
Эта AVP должна присутствовать для типов прокси Authen 2 и 5.  Поле приглашения содержит приглашение CHAP,
предлагаемое LAC клиенту.
Эта AVP может быть скрытой  (бит H может быть 0 или 1).  M-бит для этой AVP должен быть равен 0.  Длина  (до
сокрытия) этой AVP равна 6,  плюс длина приглашения.
ID прокси Authen  (ICCN)
AVP  ID прокси Authen,  тип атрибута 32,  специфицирует код  ID PPP-аутентификации,  которая реализуется между
LAC и PPP-партнером,  когда используется прокси аутентификация.  Поле значения атрибута для этого AVP имеет
следующий формат:
0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
Зарезервировано ID
Рис.  15.  Поле значения атрибута для AVP  ID прокси Authen
ID представляет собой 2-октетное целое число без знака,  старший октет которого должен быть равен нулю.
AVP прокси Authen  ID должна присутствовать для типов Proxy authen 2,  3 и 5.  Для 2 и 5,  поле  ID содержит значение
ID-байта переданное LAC клиенту в его приглашении  (Challenge).  Для 3 - это значение идентификатора AuthenticateRequest.  Эта AVP может быть скрытой  (бит H может быть 0 или 1).  M-бит для этой AVP должен быть равен 0.
Отклик прокси Authen Response  (ICCN)
AVP отклика прокси Authen,  тип атрибута 33,  специфицирует отклик аутентификации PPP,  полученный LAC от PPP-партнера,  когда используется прокси аутентификация.  Отклик представляет собой строку октетов произвольной
длины.
10.10.13 4.4.1.3 Протокол туннелей на сетевом у ровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 19/41
Эта AVP должна присутствовать для типов прокси authen 1,  2,  3 и 5.  Поле отклика содержит отклик клиента на
приглашение.  Для типов прокси authen 2 и 5,  это поле содержит значение отклика,  полученное LAC.  Для типов 1 или
3,  оно несет в себе открытый текст пароля,  полученного LAC от клиента.  В случае паролей с открытым текстом
рекомендуется AVP-сокрытие.
Эта AVP может быть скрытой  (бит H может быть 0 или 1).  M-бит для этой AVP должен быть равен 0.  Длина  (до
сокрытия) этой AVP равна 6 плюс длина отклика.
4.4.6.  AVP статуса вызова
Ошибки вызова  (WEN)
AVP ошибок вызова,  тип атрибута 34,  используется LAC для посылки LNS информации об ошибке.  Поле значения
атрибута для этого AVP имеет следующий формат:
0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31
Зарезервировано Ошибка CRC  (H)
Ошибка CRC  (L) Ошибка в формате кадра  (H)
Ошибка в формате кадра  (L) Аппаратное переполнение  (H)
Аппаратное переполнение  (L) Переполнение буфера  (H)
Переполнение буфера  (L) Ошибка таймаута  (H)
Ошибка таймаута  (L) Ошибка выравнивания  (H)
Ошибка выравнивания  (L)
Рис.  16.  Поле значения атрибута для AVP ошибок вызова
Определены следующие поля:
Зарезервировано Не используется,  должно равняться нулю 0
Ошибки CRC
Число PPP-кадров,  полученных с CRC-ошибками с момента реализации
вызова
Ошибки формата кадров Число полученных PPP-пакетов с неверным форматом
Аппаратное переполнение Число переполнений аппаратного буфера с момента реализации вызова
Число переполнений буфера
Число зарегистрированных переполнений буфера с момента реализации
вызова
Число ошибок таймаутов Число таймаутов с момента реализации вызова
Ошибки выравнивания Число ошибок выравнивания с момента реализации вызова
Эта AVP может быть скрытой  (бит H может быть 0 или 1).  M-бит для этой AVP должен быть равен 1.  Длина  (до
сокрытия) этой AVP равна 32.
ACCM  (SLI)
AVP ACCM,  тип атрибута 35,  используется LNS,  чтобы проинформировать LAC о ACCM,  согласуемом LNS с PPP-партнером.  Поле значения атрибута для этого AVP имеет следующий формат:
10.10.13 4.4.1.3 Протокол туннелей на сетевом у ровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 20/41
0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31
Зарезервировано Послать ACCM  (H)
Послать ACCM  (L) Получить ACCM  (H)
Получить ACCM  (L)
Рис.  17.  Поле значения атрибута для AVP ACCM
Посланное ACCM и полученное ACCM имеют по 4 октета,  перед которыми размещаются 2 октета
зарезервированного количества.  Значение посланного ACCM должно использоваться LAC для обработки пакетов,
которые он отправляет через канал.  Значение полученного ACCM должно использоваться LAC для обработки
пакетов,  которые он получает через канал.  Значения по умолчанию,  используемые LAC для обоих этих полей равны
0xFFFFFFFF.  LAC должен учитывать значения этих полей,  если только нет конфигурационной информации,  которая
указывает,  что запрошенная маска должна быть модифицирована,  чтобы разрешить операцию.
Эта AVP может быть скрытой  (бит H может быть 1 или 0).  M-бит для этой AVP должен быть равен 1.  Длина этой AVP
равна 16.
5. Протокольные операции
Необходимая процедура установления PPP-сессии туннелирования L2TP включает в себя два этапа:
1.   Установление управляющего канала для туннеля,  и
2.   Формирование сессии в соответствии с запросом входящего или исходящего вызова.
Туннель и соответствующий управляющий канал должны быть сформированы до инициализации входящего или
исходящего вызовов.  L2TP-сессия должна быть реализована до того,  как L2TP сможет передавать PPP-кадры через
туннель.  В одном туннеле могут существовать несколько сессий между одними и теми же LAC и LNS.
Рис.  18.  PPP-туннелирование
5.1. Установление контрольного соединения
Управляющее соединение является первичным,  которое должно быть реализовано между LAC и LNS,  прежде чем
запускать сессию.  Установление управляющего соединения включает в себя безопасную идентификацию партнера,
а также определение версии L2TP,  возможностей канала,  кадрового обмена и т. д.  Для установления управляющего
соединения осуществляется обмен тремя сообщениями.  Типичным является ниже приведенный обмен:
LAC или LNS LAC или LNS
SCCRQ ->
<- SCCRP
SCCCN ->
<- ZLB ACK
10.10.13 4.4.1.3 Протокол туннелей на сетевом уровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 21/41
Если в очереди нет больше сообщений для партнера,  посылается ZLB ACK.
5.1.1.  Аутентификация туннеля
L2TP включает в себя простую,  опционную,  CHAP-подобную  [RFC1994] систему аутентификации туннеля в
процессе установления \управляющего соединения.  Если LAC или LNS хочет идентифицировать партнера,  с
которым контактирует или контактировал посредством AVP приглашения,  включенного в SCCRQ или SCCRP-сообщения.
Если в SCCRQ или SCCRP получена AVP приглашения,  AVP отклика приглашения должна быть послана в
следующем SCCRP или SCCCN,  соответственно.  Если ожидаемый отклик партнера не соответствует полученному,
установление туннеля должно быть запрещено.
При участии в аутентификации туннеля LAC и LNS должны обладать общим секретным кодом.  Это тот же
секретный код,  который использовался для AVP-сокрытия  (смотри раздел 4. 3).
5.2. Установление сессии
После успешного установления управляющего соединения,  могут формироваться индивидуальные сессии.  Каждая
сессия соответствует одному PPP информационному потоку между LAC и LNS.  В отличие от установления
управляющего соединения,  установление сессии является асимметричным в отношении LAC и LNS.  LAC
запрашивает LNS доступ к сессии для входных запросов,  а LNS запрашивает LAC запустить сессию для работы с
исходящими запросами.
5.2.1.  Установление входящего вызова
Для установления сессии используется обмен тремя сообщениями.  Типичным является ниже приведенный обмен:
LAC LNS
(Обнаружен вызов)
ICRQ ->
<-  ICRP
ICCN ->
<- ZLB ACK
Если в очереди нет больше сообщений для партнера,  посылается ZLB ACK.
5.2.2.  Установление исходящего вызова
Для установления сессии используется обмен тремя сообщениями.  Типичным является ниже приведенный обмен:
LAC LNS
<- OCRQ
OCRP ->
(Выполнить операцию вызова)
OCCN ->
<- ZLB ACK
Если в очереди нет больше сообщений для партнера,  посылается ZLB ACK.
5.3. Переадресация кадров PPP
Когда туннель сформирован,  PPP-кадры от удаленной системы,  получаемые LAC,  освобождаются от CRC,  канальных
заголовков,  и т. д.,  инкапсулированных в L2TP,  и переадресуются через соответствующий туннель.  LNS получает
L2TP-пакет,  и обрабатывает инкапсулированный PPP-кадр,  как если бы он был получен через локальный интерфейс
PPP.
10.10.13 4.4.1.3 Протокол туннелей на сетевом у ровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 22/41
Отправитель сообщения,  ассоциированный с определенной сессией и туннелем,  помещает  ID сессии и туннеля
(специфицированные партнером) в соответствующие поля заголовка всех исходящих сообщений.  Таким способом,
PPP-кадры мультиплексируются и демультиплексируются через общий туннель для данной пары LNS-LAC.  Для
заданной пары LNS-LAC может быть реализовано несколько туннелей,  а для любого туннеля несколько сессий.
Значение 0 для  ID-сессии и  ID-туннеля является зарезервированным и не должно использоваться в качестве
ID-сессии или  ID-туннеля.  Для случаев,  когда  ID-сессии еще не присвоен партнером  (т. e. ,  в процессе установления
новой сессии или туннеля),  поле  ID-сессии должно содержать 0,  а для идентификации сессии должна
использоваться AVP  ID-сессии сообщения.  Аналогично,  для случаев,  когда  ID-туннеля еще не присвоен партнером,
ID-туннеля должен быть присвоен 0,  а для идентификации туннеля должна использоваться AVP  ID-туннеля.
5.4. Использование порядковых номеров в канале данных
Порядковые номера определены в заголовке L2TP для управляющих сообщений и опционно для информационных
(смотри раздел 3. 1).  Они используются для организации надежной транспортировки управляющих сообщений
(смотри раздел 5. 8) и опционно информационных сообщений.  Каждый партнер поддерживает отдельную
нумерацию для управляющего соединения и для каждой информационной сессии в пределах туннеля.
В отличие от канала управления L2TP,  информационный канал L2TP не использует нумерацию сообщений для
повторной пересылки.  Скорее информационные сообщения могут использовать порядковые номера для
детектирования потерь пакетов и/или восстановления исходной последовательности пакетов,  которые могут быть
перемешаны при транспортировке.  LAC может потребовать,  чтобы порядковые номера присутствовали в
информационных сообщениях,  посредством AVP необходимого упорядочения  (смотри раздел 4. 4. 6).  Если эта AVP
присутствует при установлении сессии,  порядковые номера должны присутствовать всегда.  Если эта AVP
отсутствует,  упорядочивание сообщений находится под управлением LNS.  Сервер LNS управляет разрешением и
запрещением использования порядковых номеров путем посылки информационных сообщений с или без
порядковых номеров на протяжении всей сессии.  Таким образом,  если LAC получает информационное сообщение
без порядкового номера,  он должен прекратить посылку сообщений с порядковыми номерами.  Если LAC получает
информационное сообщение с порядковым номером,  он должен начать посылку информационных сообщений с
порядковыми номерами.  Если LNS разрешает нумерацию сообщений после предыдущего запрещения в ходе
сессии,  порядковые номера устанавливаются в соответствии с состоянием их последнего применения.
LNS может инициировать запрет нумерации сообщений в любое время в ходе сессии  (включая первое
информационное сообщение).  Рекомендуется,  чтобы для соединений,  где возможна потеря или изменение порядка
пакетов,  нумерация сообщений была всегда разрешена.  Запрещение нумерации возможно,  только когда риск
ошибки считается приемлемым.  Например,  если PPP-сессия при туннелировании не использует каких-либо
посторонних протоколов или сжатия данных и работает только с  IP  (как это определено в ходе процедуры
инициализации),  тогда LNS может запретить нумерацию пакетов так как  IP сам следит за их порядком.
5.5. Keepalive (Hello)
Механизм keepalive используется L2TP,  для того чтобы разделять простои туннеля от длительных периодов
отсутствия управления или информационной активности в туннеле.  Это выполняется путем введения управляющих
сообщений Hello  (смотри раздел 6. 5) после специфицированного периода времени,  истекшего с момента
последнего получения управляющего сообщения через туннель.  Как для любого другого управляющего сообщения,
при недоставке сообщения Hello туннель объявляется нерабочим,  и система возвращается в исходное состояние.
Механизм перевода транспортной среды в исходное состояние путем введения сообщений Hello гарантирует,  что
разрыв соединения между LNS и LAC будет детектирован на обоих концах туннеля.
5.6. Прерывание сессии
Прерывание сессии может быть инициировано LAC или LNS и выполняется путем посылки управляющего
сообщения CDN.  После того как последняя сессия прервана,  управляющее соединение может быть также
разорвано.  Ниже приводится типовой обмен управляющими сообщениями:
10.10.13 4.4.1.3 Протокол туннелей на сетевом у ровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 23/41
LAC или LNS LAC или LNS
CDN ->
(Clean up)
<- ZLB ACK
(Clean up)
5.7. Разрыв контрольного соединения
Разрыв контрольного соединения может быть инициирован LAC или LNS и выполняется путем посылки одного
управляющего сообщения StopCCN.  Получатель StopCCN должен послать ZLB ACK,  чтобы подтвердить получение
сообщения,  и поддерживает состояние управляющего соединения на уровне достаточном для корректного приема
StopCCN,  а также повторения цикла,  если ZLB ACK потеряно.  Рекомендуемое время повторения цикла равно 31
секунде  (смотри раздел 5. 8).  Ниже приводится типовой обмен управляющими сообщениями:
LAC или LNS LAC или LNS
StopCCN ->
(Clean up)
<- ZLB ACK
(Wait)
(Clean up)
Программа может ликвидировать туннель и все сессии туннеля путем посылки StopCCN.  Таким образом,  не нужно
прерывать каждую сессию,  если разорван туннель.
5.8. Надежная доставка управляющих сообщений
L2TP обеспечивает нижний уровень надежного транспорта для всех управляющих сообщений.  Поля Nr  и Ns
заголовка управляющего сообщения  (смотри раздел 3. 1) относятся к этому транспорту.  Функции верхнего уровня
L2TP не занимаются повторной пересылкой или упорядочением управляющих сообщений.  Надежный
управляющий канал обеспечивается за счет специального протокола,  например,  TCP,  поддерживающего
повторную пересылку управляющих сообщений и контроль перегрузки.  Каждый партнер поддерживает
независимую нумерацию сообщений для управляющего канала в туннеле.
Порядковые номера сообщений Ns начинаются с 0.  Каждое последующее сообщение имеет номер на 1 больше,
чем предыдущее.  Номер по порядку,  таким образом,  является простым счетчиком,  работающим по модулю 65536.
Порядковый номер в заголовке полученного сообщения рассматривается меньше или равным последнему
полученному числу,  если его значение лежит в интервале между последним полученным кодом и предыдущими
32767 включительно.  Например,  если последний полученный номер был равен 15,  тогда сообщения с порядковыми
номерами 0 - 15,  а также 32784 - 65535,  будут рассматриваться как сообщение с меньшим или равным номером.
Такое сообщение будет рассматриваться как дубликат уже полученного и не будет обрабатываться.  Однако,  для
того чтобы гарантировать,  что все сообщения подтверждены корректно  (в частности в случае потери сообщения
ZLB ACK),  получение сообщения-дубликата должно быть подтверждено.  Это подтверждение может быть
реализовано косвенно,  или непосредственно через ZLB ACK.
Все управляющие сообщения в пространстве номеров занимают одну нишу,  за исключением подтверждения ZLB.
Таким образом,  Ns не инкрементируется после посылки сообщения ZLB.
Номер последнего полученного сообщения,  Nr,  используется для подтверждения сообщений,  принятых L2TP-партнером.  Этот код должен содержать порядковый номер сообщения,  которые партнер ожидает получить
следующим  (например,  последний Ns сообщения  (non-ZLB) плюс 1,  по модулю 65536).  В то время как Nr  в
полученном ZLB используется для удаления сообщений из локальной очереди сообщений,  ждущих  imes повторной
передачи в локальной очереди  (смотри ниже),  Nr  следующего сообщения не должен обновляться при получении
Ns ZLB.
Протокол надежной доставки принимающего партнера ответственен за проверку того,  что управляющие
10.10.13 4.4.1.3 Протокол туннелей на сетевом у ровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 24/41
сообщения доставлены на верхний уровень в правильном порядке и без дублирования.  Сообщения,  пребывающие
в неверном порядке,  могут быть занесены в очередь для последующей корректной доставки,  когда пропущенные
сообщения будут получены,  или они могут быть выброшены,  что вынудит партнера послать их повторно.  Каждый
туннель поддерживает очередь управляющих сообщений,  которые нужно передать его партнеру.  Сообщение в
начале очереди посылается с заданным значением Ns,  и хранится до тех пор,  пока не придет от партнера
управляющее сообщение,  в котором поле Nr  указывает на то,  что данное сообщение получено.  Если в течение
определенного времени  (рекомендуемое значение равно 1 секунде) отклика не получено,  сообщение посылается
повторно.  Повторно посылаемое сообщение имеет то же значение Ns,  но величина Nr  должна быть сделана равной
номеру очередного ожидаемого сообщения.
Каждая повторная посылка сообщения должна реализовываться по истечении задержки,  величина которой
возрастает экспоненциально от раза к разу.  Таким образом,  если первая повторная передача происходит спустя 1
секунду,  следующая повторная передача может производиться по истечении 2 секунд,  затем 4 секунд,  и т. д.
Программная реализация может установить верхний предел на время между повторными пересылками сообщения.
Этот предел должен быть не меньше 8 секунд.  Если после нескольких повторных посылок,  не зафиксировано
никакого отклика от партнера,   (рекомендуемое число попыток равно 5,  но должно быть настраиваемым),  туннель и
все сессии должны быть аннулированы.
Когда туннель закрывается не по причине обрыва соединения,  состояние и механизм надежной доставки должны
поддерживаться и работать в течение всего периода повторных передач.
Механизм скользящего окна используется для передачи управляющих сообщений.  Рассмотрим двух партнеров A &
B.  Предположим A задает размер приемного окна в сообщениях SCCRQ или SCCRP равным N.  B при этом
позволено иметь до N ожидающих подтверждения получения сообщений.  Когда N послано,  нужно ждать
подтверждения,  которое сдвинет окно,  прежде чем посылать новое управляющее сообщение.  Программная
реализация может поддерживать приемное окно с размером 1  (т. e.,  посылать AVP размера приемного окна со
значением 1),  но должно воспринимать от своего партнера окна с шириной до 4  (например,  имеет возможность
послать 4 сообщения,  прежде чем остановиться и ожидать отклика).  Значение 0 для AVP размера приемного окна
является недопустимым.
При повторной передаче управляющих сообщений следует использовать медленный старт и окно подавления
перегрузки.  Рекомендуемая процедура для этого описана в приложении A.
Партнер не должен отказываться подтверждать сообщения,  в качестве меры управления потоком управляющих
сообщений.  Предполагается,  что реализация L2TP способна работать с входными управляющими сообщениями,
возможно реагируя с ошибками,  отражающими невозможность выполнения запрашиваемых действий.  В
приложении B представлены примеры управляющих сообщений,  подтверждений и повторных передач.
6. Протокольная спецификация контрольного
соединения
Следующие сообщения управляющего соединения используются для установления,  ликвидации и поддержания
L2TP-туннелей.  Вся информация посылается в порядке,  определенном для сети  (старший октет первый).  Любые
"резервные" или "пустые" поля для обеспечения протокольной масштабируемости должны содержать 0.
6.1. Запрос Start-Control-Connection (SCCRQ)
Start-Control-Connection-Request  (SCCRQ) является управляющим сообщением,  используемым для инициализации
туннеля между LNS и LAC.  Оно посылается LAC или LNS в процессе установления туннеля.  Следующие AVP должны
присутствовать в SCCRQ:
AVP типа сообщения  (Message Type AVP)
Версия протокола  (Protocol Version)
Имя ЭВМ  (Host Name)
Возможности кадрового обмена  (Framing Capabilities)
Присвоенный туннелю  ID  (Assigned Tunnel  ID)
10.10.13 4.4.1.3 Протокол туннелей на сетевом у ровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 25/41
Следующие AVP могут присутствовать в SCCRQ:
Возможности канала  (Bearer  Capabilities)
Размер премного окна  (Receive Window Size)
Приглашение  (Challenge)
Арбитр конфликта  (Tie Breaker )
Фирменная версия  (Firmware Revision)
Имя производителя  (Vendor  Name)
6.2. Отклик Start-Control-Connection (SCCRP)
Start-Control-Connection-Reply  (SCCRP) является управляющим сообщением,  посланным в ответ на сообщение
SCCRQ.  SCCRP используется для индикации того,  что SCCRQ было принято и установление туннеля должно быть
продолжено.  Следующие AVP должны присутствовать в SCCRP:
Тип сообщения  (Message Type)
Версия протокола  (Protocol Version)
Framing Capabilities
Имя ЭВМ  (Host Name)
Присвоенный туннелю  ID  (Assigned Tunnel  ID)
Следующие AVP могут присутствовать в SCCRP:
Возможности несущего канала  (Bearer  Capabilities)
Фирменная версия  (Firmware Revision)
Имя производителя  (Vendor  Name)
Размер приемного окна  (Receive Window Size)
Приглашение  (Challenge)
Отклик на приглашение  (Challenge Response)
6.3. Start-Control-Connection-Connected (SCCCN)
Start-Control-Connection-Connected  (SCCCN) является   управляющим сообщением,  посылаемым в ответ на SCCRP.
SCCCN завершает процесс установления туннеля.
Следующее AVP должно присутствовать в SCCCN: Message Type
Следующее AVP может присутствовать в SCCCN: Challenge Response
6.4. Stop-Control-Connection-Notification (StopCCN)
Stop-Control-Connection-Notification  (StopCCN) является управляющим сообщением,  посылаемым LAC или LNS для
информирования своего партнера о том,  что туннель закрывается  (shutdown) и управляющий канал должен быть
разорван.  Кроме того,  все активные сессии закрываются  (без посылки каких-либо управляющих сообщений).
Причина для отправки этого запроса указывается в AVP кода результата.  Явно отклик на это сообщение не
посылается,  используется отклик ACK,  который используется для обеспечения надежной связи для управляющего
соединения транспортного уровня.  Следующие AVP должны присутствовать в StopCCN:
Тип сообщения  (Message Type)
Присвоенный туннелю  ID  (Assigned Tunnel  ID)
Результирующий код  (Result Code)
6.6. Запрос входящего вызова ICRQ (Incoming-CallRequest)
10.10.13 4.4.1.3 Протокол туннелей на сетевом у ровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 26/41
Incoming-Call-Request  (ICRQ) является управляющим сообщением,  посылаемым LAC к LNS,  когда зарегистрирован
входящий вызов.  Это первое из трех сообщений обмена,  используемых для установления сессии в пределах L2TP
туннеля.
ICRQ используется для индикации того,  что для данного вызова должна быть установлена сессия между LAC и LNS,
и предоставляет LNS параметры сессии.  LAC может отложить ответ на вызов,  до тех пор пока он не получит  ICRP от
LNS,  указывающий,  что должна быть запущена сессия.  Этот механизм позволяет LNS получить достаточно
информации о вызове,  прежде чем будет определено,  следует ли на него отвечать.  В качестве альтернативы LAC
может ответить на вызов,  согласовать аутентификацию LCP и PPP,  и использовать информацию,  полученную для
выбора LNS.  В этом случае,  к моменту получения сообщения  ICRP на вызов уже получен ответ;  в этом случае LAC
просто разыгрывает шаги "call  indication" и "call answer ".  Следующие AVP должны присутствовать в  ICRQ:
Тип сообщения
ID,  Присвоенный сессии  (Assigned Session  ID)
Call Ser ial Number
Следующие AVP могут присутствовать в  ICRQ:
Тип носителя  (Bearer  Type)
ID физического канала  (Physical Channel  ID)
Вызывающий номер  (Calling Number )
Вызванный номер  (Called Number )
Субадрес  (Sub-Address)
6.7. Отклик входящего вызова ICRP (Incoming-CallReply)
Incoming-Call-Reply  (ICRP) является управляющим сообщением,  посылаемым LNS к LAC в ответ на полученное
сообщение  ICRQ.  Он является вторым из трех сообщений обмена,  используемых для установления сессии в пределах
L2TP туннеля.
ICRP используется для индикации того,  что  ICRQ успешен,  и для LAC,  чтобы ответить на вызов,  если это еще не было
сделано.  Оно позволяет также LNS индицировать необходимые параметры для L2TP-сессии.  Следующие AVP
должны присутствовать в  ICRP:
Тип сообщения  (Message Type)
ID,  присвоенный сессии  (Assigned Session  ID)
6.8. Incoming-Call-Connected (ICCN)
Incoming-Call-Connected  (ICCN) является управляющим сообщением,  посылаемым от LAC к LNS в ответ на
полученное сообщение  ICRP.  Оно является третьим сообщением из трех сообщений обмена,  используемых для
установления сессий в пределах L2TP-туннеля.
ICCN используется для индикации того,  что  ICRP принято,  на вызов получен ответ,  а L2TP-сессия должна перейти в
состояние “установлена”.  Оно также предоставляет дополнительную информацию LNS о параметрах,  используемых
для вызова,  на который получен ответ  (параметры,  которые не всегда быть доступны в момент посылки  ICRQ).
Следующие AVP должны присутствовать в  ICCN:
Тип сообщения  (Message Type)
Скорость обмена в канале  ((Tx) Connect Speed)
Тип кадрового обмена  (Framing Type)
Следующие AVP могут присутствовать в  ICCN:
Ini ti al  Recei ved LCP CONFREQ
Последнее посланное LCP CONFREQ
10.10.13 4.4.1.3 Протокол туннелей на сетевом уровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 27/41
Последнее полученное LCP CONFREQ
Тип Proxy Authen
Имя Proxy Authen
Приглашение Proxy Authen
Прокси Authen  ID
Отклик прокси Authen
ID частной группы
Скорость обмена соединения  (Rx Connect Speed)
Необходима нумерация  (Sequencing Required)
6.9. Запрос исходящего вызова OCRQ (Outgoing-CallRequest)
Outgoing-Call-Request  (OCRQ) является управляющим сообщением,  посылаемым от LNS к LAC для индикации того,
что необходимо осуществить исходящий вызов LAC.  Оно является первым сообщением из трех,  которые
используются для установления сессии в пределах L2TP-туннеля.
OCRQ используется для индикации того,  что сессия для данного вызова между LNS и LAC установлена и
предоставляет LAC параметры L2TP-сессии и вызова.
LNS должен получить от LAC AVP Bearer Capabilities  (возможностей носителя) на фазе установления туннеля,  для
того чтобы послать LAC исходящий вызов.  Следующие AVP должны присутствовать в OCRQ:
Тип сообщения  (Message Type)
ID,  присвоенное сессии  (Assigned Session  ID)
Call Ser ial Number
Минимальный BPS
Максимальный BPS
Тип несущего канала  (Bearer  Type)
Тип кадрового обмена  (Framing Type)
Телефонный номер адресата  (Called Number )
Следующие AVP могут присутствовать в OCRQ: Sub-Address
6.10. Отклик исходящего вызова OCRP (OutgoingCall-Reply)
Сообщение Outgoing-Call-Reply  (OCRP) является управляющим сообщением,  посылаемым от LAC к LNS в ответ на
полученное сообщение OCRQ.  Оно является вторым из трех сообщений,  которые используются при установлении
сессии в L2TP-туннеле.  OCRP используется для индикации того,  что LAC может попытаться послать исходящий
вызов и вернуть определенные параметры,  относящиеся к попытке вызова.  Следующие AVP должны присутствовать
в OCRP:
Тип сообщения  (Message Type)
Assigned Session  ID
Следующие AVP могут присутствовать в OCRP: Physical Channel  ID
6.11. Outgoing-Call-Connected (OCCN)
Сообщение Outgoing-Call-Connected  (OCCN) является управляющим сообщением,  посылаемым от LAC к LNS,
следом за OCRP,  и после того как исходящий вызов завершен.  Это завершающее сообщение из трех,  используемых
при установлении сессии в пределах L2TP-туннеля.
10.10.13 4.4.1.3 Протокол туннелей на сетевом уровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 28/41
OCCN используется для индикации того,  что результат запрошенного исходящего вызова положителен.  Оно также
предоставляет LNS информацию об определенных параметрах,  полученных после реализации вызова.  Следующие
AVP должны присутствовать в OCCN:
Тип сообщения  (Message Type)
Скорость обмена  ((Tx) Connect Speed)
Тип кадрового обмена  (Framing Type)
Следующие AVP могут присутствовать в OCCN:
Скорость обмена  (Rx Connect Speed)
Необходима нумерация  (Sequencing Required)
6.12. Call-Disconnect-Notify (CDN)
Сообщение Call-Disconnect-Notify  (CDN) является L2TP управляющим сообщением,  посылаемым LAC или LNS с
целью запроса разрыва соединения для определенного вызова в пределах туннеля.  Его целью является
информирование партнера о рассоединении и причине разрыва соединения.  Партнер должен освободить все
ресурсы,  и не посылать сообщений о причине данной операции. Следующие AVP должны присутствовать в CDN:
Message Type
Код результата  (Result Code)
Assigned Session  ID
Следующие AVP могут присутствовать в CDN: Код причины Q. 931
6.13. WAN-Error-Notify (WEN)
Сообщение WAN-Er ror-Notify является L2TP управляющим сообщением,  посылаемым от LAC к LNS для индикации
условий ошибки WAN  (условия,  которые реализовались в интерфейсе,  поддерживающим PPP).  Счетчики в этом
сообщении являются накопительными.  Это сообщение должно посылаться,  только когда произошла ошибка,  и не
чаще чем раз в 60 секунд.  Счетчики сбрасываются,  когда реализуется новый вызов.  Следующие AVP должны
присутствовать в WEN:
Тип сообщения  (Message Type)
Ошибки вызова  (Call Er rors)
6.14. Set-Link-Info (SLI)
Сообщение Set-Link-Info является управляющим сообщением L2TP,  посланным от LNS к LAC для установления
согласуемых опций PPP.  Эти опции можно изменять в любое время на протяжении реализации вызова,  таким
образом,  LAC должен быть способен обновлять свою собственную информацию вызова и поведение на
протяжении активной PPP-сессии.  Следующие AVP должны присутствовать в SLI:
Тип сообщения  (Message Type)
ACCM
7. Машины состояний управляющего соединения
Управляющие сообщения,  определенные в разделе 6 пересылаются в соответствии с таблицами состояний,
описанными в данном разделе.  Таблицы определены для входящих вызовов,  исходящих вызовов,  а также для
инициации самого туннеля.  Таблицы состояний не задают таймауты и поведение при повторной передаче,  так как
это определяется механизмами,  рассмотренными в секции 5. 8.
10.10.13 4.4.1.3 Протокол туннелей на сетевом у ровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 29/41
7.1. Протокольные операции контрольного
соединения
Этот раздел описывает работу различных функций управляющего соединения L2TP и сообщения управляющего
соединения,  которые используются для их поддержания.
Получение некорректного или неправильно сформатированного управляющего сообщения должно
регистрироваться соответствующим образом,  а управляющее соединение возвращается в исходное состояние,
чтобы гарантировать восстановление заданного состояния.  Управляющее соединение может затем перезапуститься
инициатором операции.
Некорректное управляющее сообщение определяется как сообщение,  которое содержит тип сообщения,
помеченное как обязательное  (смотри раздел 4. 4. 1) и неизвестное программе управляющее сообщение,  которое
получено в правильной последовательности  (например,  в ответ на SCCRQ послано SCCCN).
Примеры управляющих сообщений с некорректным форматом включают те,  которые имеют неверное значение в
своем заголовке,  содержат AVP,  сформированную некорректно или чье значение находится вне допустимых
пределов,  или сообщение,  которое не имеет необходимого AVP.  Управляющее сообщение с некорректным
заголовком должно быть отброшено.  Управляющее сообщение с некорректным AVP должно проверить M-бит для
этого AVP,  чтобы определить,  является ли ошибка исправимой или нет.
Неверно сформатированное,  но исправимое необязательное  (M-бит равен нулю) AVP в управляющем сообщении
должно рассматриваться,  также как нераспознанное необязательное AVP.  Таким образом,  если получена AVP с
неверным форматом и битом M=1,  сессия или туннель должны быть разорваны с соответствующим кодом
результата или ошибки.  Если M-бит не равен 1,  AVP должно игнорироваться  (за исключением записи об ошибке в
местном журнале).
Это не должно рассматриваться,  как разрешение посылать неверно сформатированные AVP,  а лишь как указание на
то,  как реагировать на неверно сформатированное сообщение в случае его получения.  Невозможно перечислить
все возможные ошибки в сообщениях и дать совет,  как с ними обходиться.  Примером исправимой неверно
сформатированной AVP может быть случай,  когда получена AVP скорости соединения Rx,  атрибут 38,  с полем длина
8,  а не 10 и BPS с двумя,  а не четырьмя октетами.  Так как Rx Connect Speed не является обязательным,  такое условие
не может рассматриваться как катастрофическое.  Как таковое,  управляющее сообщение должно быть воспринято,
как если бы AVP не было получено  (за исключением записи в локальный журнал ошибок).  В нескольких случаях в
последующих таблицах,  посылается протокольное сообщение,  а затем случается "сброс".  Заметим,  что,  несмотря на
ликвидацию туннеля одним из партнеров,  в течение определенного времени механизм надежной доставки должен
быть сохранен  (смотри раздел 5. 8) вплоть до окончательного закрытия туннеля.  Это позволяет сообщениям
управления туннеля надежно доставляться партнеру.
7.2. Состояния контрольного соединения
Протокол управляющего соединения L2TP не отличим от LNS и LAC,  но различен для отправителя и получателя.
Партнером инициатором является тот,  кто первым формирует туннель  (в конфликтной ситуации,  это победитель).
Так как LAC или LNS может быть инициатором,  может произойти столкновение.  Смотри Tie Breaker  AVP в разделе
4. 4. 3,  где описано разрешение такого   конфликта.
7.2.1.  Установление контрольного соединения
Состояние Событие Действие
Новое
состояние
Idle Local Open  request Послать SCCRQ wait-ctl-reply
Idle
Получить SCCRQ,
приемлемо
Послать SCCRP wait-ctl-conn
10.10.13 4.4.1.3 Протокол туннелей на сетевом уровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 30/41
idle
Получить SCCRQ,
не приемлемо
Послать StopCCN,
Clean up
idle
idle Получить SCCRP
Послать StopCCN
Clean up
idle
Idle Получить SCCCN Clean up idle
wait-ctl-reply
Получить SCCRP,
приемлемо
Послать SCCCN,
Послать  tunnel-open
ожидающей сессии
established
wait-ctl-reply
Получить SCCRP,
не приемлемо
Послать StopCCN,
Clean up
idle
wait-ctl-reply
Получить SCCRQ,
проигрыш  tie-breaker
Clean up,
Re-queue SCCRQ
для состояния  idle
idle
wait-ctl-reply Получить SCCCN
Послать StopCCN
Clean up
idle
wait-ctl-conn
Получить SCCCN,
приемлемо
Послать  tunnel-open
ожидающей сессии
established
wait-ctl-conn
Получить SCCCN,
не приемлемо
Послать StopCCN,
Clean up
idle
wait-ctl-conn
Получить SCCRP,
SCCRQ
Послать StopCCN,
Clean up
idle
Established
Local Open  request
(новый вызов)
Послать  tunnel-open
ожидающей сессии
established
Еstablished
Административное
закрытие туннеля
Послать StopCCN
Clean up
idle
Established
Получить SCCRQ,
SCCRP,  SCCCN
Send StopCCN
Clean up
idle
Idle
wait-ctl-reply,
wait-ctl-conn,
established
Получить StopCCN Clean up idle
Состояниями,  ассоциированными с LNS или LAC для установления управляющего соединения,  являются:
Idl e  (пассивно)
Инициатор и получатель начинают функционирование из этого состояния.  Инициатор посылает SCCRQ,  в то время
как получатель остается в пассивном состоянии вплоть до получения SCCRQ.
wai t-ctl-reply  (ожидание управляющего отклика)
Инициатор проверяет,  не поступил ли запрос на установление еще одного соединения от того же самого партнера,
и если это так,  реагирует на столкновение,  как это описано в разделе 5. 8.
Когда получено SCCRP,  оно проверяется на совместимость версии.  Если версия отклика ниже версии посланного
запроса,  должна использоваться более старая  (низшая) версия.  Если версия отклика более ранняя,  и она
10.10.13 4.4.1.3 Протокол туннелей на сетевом у ровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 31/41
поддерживается,  инициатор переходит в состояние “установлено”.  Если версия более ранняя и не поддерживается,
партнеру должно быть послано StopCCN,  а инициатор переходит в исходное состояние и разрывает туннель.
wai t-ctl-conn  (ожидание управляющего соединения)
Состояние,  когда ожидается SCCCN;  после получения,  проверяется отклик приглашения.  Туннель оказывается
установленным,  или разорванным,  если не прошла аутентификация.
Establ i shed  (установлено)
Установленное соединение может быть аннулировано по местным причинам или в результате получения StopControl-Connection-Notification.  В случае местного разрыва инициатор должен послать Stop-Control-ConnectionNotification и ликвидировать туннель.
Если инициатор получает Stop-Control-Connection-Notification,  он должен разорвать туннель.
7.3. Временные соображения
В силу того,  что телефонная связь по своей природе работает в реальном времени,  как LNS,  так и LAC должны быть
реализованы по многопроцессной схеме,  такой чтобы сообщения,  относящиеся к нескольким вызовам,  не
блокировались.
7.4. Входящие вызовы
Сообщение  Incoming-Call-Request генерируется LAC,  когда зарегистрирован входящий вызов  (например,  звонки в
телефонной линии).  LAC выбирает  ID-сессии и порядковый номер и индицирует тип носителя вызова.  Модемы
должны всегда индицировать аналоговый тип вызова.  Вызовы  ISDN должны индицировать цифровой тип вызова,
когда доступно цифровое обслуживание и используется настройка скорости обмена,  и аналоговый,  если применен
цифровой модем.  Вызывающий номер,  вызываемый номер и субадрес могут быть включены в сообщение,  если они
доступны через телефонную сеть.
Раз LAC посылает  Incoming-Call-Request,  он ждет отклика от LNS,  но необязательно отвечает на вызов из
телефонной сети.  LNS может решить не воспринять вызов если:
Нет ресурсов для поддержки новых сессий;
Поля вызывающего,  вызываемого и субадреса не соответствуют авторизованному пользователю;
Сервис носителя не авторизован или не поддерживается.
Если LNS решает принять вызов,  он откликается посылкой  Incoming-Call-Reply.  Когда LAC получает  Incoming-CallReply,  он пытается подключить вызов.  Последнее сообщение о подключении от LAC к LNS указывает,  что статус
вызова для LAC и LNS должнен перейти в состояние “установлено”.  Если вызов завершается до того,  как LNS успел
принять его,  LAC посылает Disconnect-Notify,  чтобы индицировать эту ситуацию.
Когда телефонный клиент вешает трубку,  LAC посылает сообщение Call-Disconnect-Notify.  Если LNS хочет
аннулировать вызов,  он посылает сообщение Call-Disconnect-Notify и ликвидирует свою сессию.
7.4.1.  Состояния LAC входящих вызовов
Состояние Событие Действие Новое  состояние
Idle
Bearer  Ring или
Готов индицировать
входящее соединение
Инициировать локальное
открытие туннеля
wait-tunnel
Idle Получить  ICCN,   ICRP,  CDN Clean up idle
10.10.13 4.4.1.3 Протокол туннелей на сетевом у ровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 32/41
wait-tunnel Разрыв канала или
локальный запрос закрытия
Clean up idle
wait-tunnel tunnel-open Послать  ICRQ wait-reply
wait-reply Получить  ICRP,  приемлемо Послать  ICCN established
wait-reply
Получить  ICRP,
Не приемлемо
Послать CDN,
Clean up
idle
wait-reply Получить  ICRQ
Послать CDN
Clean up
idle
wait-reply Получить CDN  ICCN Clean up idle
wait-reply
Локальный запрос закрытия
или потеря несущей
Послать CDN,
Clean up
idle
Established Получить CDN Clean up idle
Established
Получить  ICRQ,
ICRP,   ICCN
Послать CDN,
Clean up
idle
Established
Потеря несущей или
локальный запрос закрытия
Послать CDN,
Clean up
idle
Состояниями,  ассоциированными с LAC,  для входящих вызовов являются:
idle
LAC детектирует входящий вызов на одном из своих интерфейсов.  Обычно это означает,  что по аналоговой линии
получены звонки или  ISDN TE зарегистрировало входное сообщение Q. 931 SETUP.  LAC инициализирует свою
машину состояния,  формирующую туннель,  и переходит в состояние ожидания подтверждения существования
туннеля.
wai t-tunnel
В этом состоянии сессия ожидает открытия соединения или верификации того,  что туннель уже открыт.  Как только
получено уведомление о том,  что туннель открыт,  может быть начат обмен управляющими сообщениями сессии.
Первым таким сообщением будет  Incoming-Call-Request.
wai t-reply
LAC получает CDN-сообщение,  указывающее,  что LNS не хочет воспринимать вызов и переходит назад в состояние
idle  (пассивен),  или получает сообщение  Incoming-Call-Reply,  означающее,  что вызов принят,  LAC посылает
сообщение  Incoming-Call-Connected и переходит в состояние “установлен”.
established
Через туннель передаются данные.  Вызов может быть аннулирован после:
Событие на подключенном интерфейсе:  LAC посылает сообщение Call-Disconnect-Notify
Получение сообщения Call-Disconnect-Notify:  LAC переходит в исходное состояние,  аннулируя вызов.
Локальная причина:  LAC посылает сообщение Call-Disconnect-Notify.
7.4.2.  Состояния LNS входящих вызовов
Состояние Событие Действие Новое  состояние
10.10.13 4.4.1.3 Протокол туннелей на сетевом уровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 33/41
Idle Получение  ICRQ,
Приемлемо
Послать  ICRP wait-connect
idle
Получение  ICRQ,
Не приемлемо
Послать CDN,
Clean up
idle
idle Получение  ICRP
Послать CDN
Clean up
idle
Idle Получение  ICCN Clean up idle
wait-connect
Получение  ICCN
Приемлемо
Подготовиться для приема
данных
established
wait-connect
Получение  ICCN
Не приемлемо
Послать CDN,
Clean up
idle
wait-connect Получение  ICRQ,   ICRP
Послать CDN
Clean up
idle
idle,
wait-connect,
established
Получение CDN Clean up idle
wait-connect
established
Локальный запрос закрытия
Послать CDN,
Clean up
idle
established Получение  ICRQ,   ICRP,   ICCN
Послать CDN
Clean up
idle
Состояниями,  ассоциированными с LNS для входящих вызовов являются:
idle
Получено сообщение  Incoming-Call-Request.  Если запрос неприемлем,  посылается Call-Disconnect-Notify LAC и LNS
остается в состоянии  idle.  Если сообщение  Incoming-Call-Request приемлемо,  посылается  Incoming-Call-Reply.  Сессия
переходит в состояние wait-connect.
wai t-connect
Если сессия все еще подключена к LAC,  он посылает сообщение  Incoming-Call-Connected LNS,  который затем
переходит в состояние ”установлено”.  LAC может послать Call-Disconnect-Notify для индикации того,  что источник
входящего запроса не может быть подключен.  Это может произойти,  например,  если пользователь телефона
случайно устанавливает в LAC стандартный голосовой режим,  что приводит прерыванию диалога с модемом.
establ i shed
Сессия завершается при получении сообщения Call-Disconnect-Notify от LAC или путем посылки Call-DisconnectNotify.
Сброс системы в базовое состояние происходит на обеих сторонах вне зависимости от действий инициатора
операции.
7.5. Исходящие вызовы
Исходящие вызовы инициируются LNS и заставляют LAC реализовать вызов.  Для исходящих вызовов используется
три сообщения:  Outgoing-Call-Request,  Outgoing-Call-Reply,  и Outgoing-Call-Connected.  LNS посылает Outgoing-CallRequest,
специфицирующий телефонный номер партнера,  субадрес и другие параметры.  LAC должен реагировать
на сообщение Outgoing-Call-Request откликом Outgoing-Call-Reply,  так как LAC определяет,  что имеется
возможность реализовать вызов,  который должен быть административно авторизован.  Например,  разрешено ли
LNS осуществлять международные телефонные вызовы? Если для исходящего вызова осуществлено соединение,
LAC посылает LNS сообщение Outgoing-Call-Connected,  характеризующее окончательный результат попытки
вызова.
10.10.13 4.4.1.3 Протокол туннелей на сетевом у ровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 34/41
7.5.1.  Состояния LAC исходящих вызовов
Состояние Событие Действие Новое  состояние
Idle
Получение OCRQ,
Приемлемо
Послать OCRP,
Open bearer
wait-cs-answer
idle
Получение OCRQ,
Не приемлемо
Послать CDN,
Clean up
idle
idle Получение OCRP
Послать CDN
Clean up
idle
Idle Получение OCCN,  CDN Clean up idle
wait-cs-answer
Bearer  answer ,
framing detected
Послать OCCN established
wait-cs-answer Bearer   failure
Послать CDN,
Clean up
idle
wait-cs-answer
Получение OCRQ,
OCRP,  OCCN
Послать CDN
Clean up
idle
Established
Получение OCRQ,
OCRP,  OCCN
Послать CDN
Clean up
idle
wait-cs-answer ,
established
Получение CDN Clean up idle
established
Потеря несущей,
локальный запрос закрытия
Послать CDN,
Clean up
idle
Состояниями,  ассоциированными с LAC,  для исходящих вызовов являются:
i dl e
Если Outgoing-Call-Request получен с ошибкой,  посылается отклик Call-Disconnect-Notify.  В противном случае,
выделяется физический канал и посылается Outgoing-Call-Reply.  Производится исходящий вызов и LAC переходит в
состояние wait-cs-answer.
wai t-cs-answer
Если вызов не завершен или произошел таймаут ожидания завершения вызова,  посылается Call-Disconnect-Notify с
соответствующими кодами ошибки и происходит переход в состояние  idle.  Если устанавливается соединение с
коммутацией каналов и зафиксирован обмен кадрами,  посылается Outgoing-Call-Connected,  отмечающий
успешную реализацию вызова и LAC переходит в состояние “установлено”.
established
Если LAC получил Call-Disconnect-Notify,  вызов должен быть аннулирован через соответствующий механизм и
сессия закрыта.  Если вызов аннулирован клиентом или интерфейсом,  через который был осуществлен вызов,
должно быть послано LNS сообщение Call-Disconnect-Notify.  Отправитель сообщения Call-Disconnect-Notify
переходит в состояние  idle.
7.5.2.  Состояние исходящего вызова LNS
Состояние Событие Действие Новое  состояние
Idle Локальный запрос открытия
Инициировать
локально
tunnel-open
wait-tunnel
10.10.13 4.4.1.3 Протокол туннелей на сетевом уровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 35/41
idle
Получение OCCN,
OCRP,  CDN
Clean up idle
wait-tunnel tunnel-open Послать OCRQ wait-reply
wait-reply
Получение OCRP,
Приемлемо
никакого wait-connect
wait-reply
Получение OCRP,
Не приемлемо
Послать CDN
Clean up
idle
wait-reply Получение OCCN,  OCRQ
Послать CDN
Clean up
idle
wait-connect Получение OCCN none established
wait-connect Получение OCRQ,  OCRP
Послать CDN
Clean up
idle
Idle,
wait-reply,
wait-connect,
established
Получение CDN, Clean up idle
established
Получение OCRQ,
OCRP,  OCCN
Послать CDN
Clean up
idle
wait-reply,
wait-connect,
established
Локальный запрос закрытия
Послать CDN
Clean up
idle
wait-tunnel Локальный запрос закрытия Clean up idle
Состояниями,  ассоциированными с LNS,  для исходящих вызовов являются:
i dl e, wai t-tunnel
Когда инициирован исходящий вызов,  сначала создается туннель.  Когда туннель создан,  посылается сообщение
Outgoing-Call-Request LAC и сессия переходит в состояние wait-reply.
wai t-repl y
Если получено Call-Disconnect-Notify,  произошла ошибка,  и сессия переводится в исходное состояние  idle.  Если
получено сообщение Outgoing-Call-Reply,  вызов находится в развитии и сессия переходит в состояние wait-connect.
wai t-connect
Если получено Call-Disconnect-Notify,  вызов не состоялся;  сессия возвращается в исходное состояние  idle.  Если
получено Outgoing-Call-Connected,  вызов прошел,  и сессия может осуществлять обмен данными.
establ i shed
Если получено Call-Disconnect-Notify,  вызов был аннулирован по причине,  указанной в кодах результата и причины;
сессия возвращается в состояние  idle.  Если LNS решает завершить сессию,  он посылает LAC сообщение CallDisconnect-Notify и затем переводит сессию в исходное состояние  idle.
7.6. Ликвидация туннеля
Разрыв туннеля происходит в случае посылки партнером сообщения Stop-Control-Connection-Notification.
Отправитель этого уведомления должен ждать определенное время отклика на это сообщение,  прежде чем
ликвидировать управляющую информацию,  имеющую отношение к туннелю.  Получатель этого уведомления
должен послать подтверждение получения этого сообщения и затем ликвидировать управляющую информацию.
10.10.13 4.4.1.3 Протокол туннелей на сетевом уровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 36/41
Конкретная программная реализация может использовать определенный алгоритм принятия решения о разрыве
управляющего соединения.  Некоторые реализации могут оставить туннель открытым на некоторое время.  Другие
могут решить закрыть туннель немедленно после разрыва последнего соединения пользователей.
8. Реализация L2TP через специфическую среду
Протокол L2TP является само документируемым,  работающим поверх уровня,  который служит для
транспортировки.  Однако,  необходимы некоторые детали подключения к среде,  для того чтобы обеспечить
совместимость различных реализаций.
8.1. L2TP через UDP/IP
L2TP использует зарегистрированный UDP-порт 1701  [RFC1700].  Весь L2TP-пакет,  включая поле данных и L2TP-заголовок,  пересылается внутри UDP-дейтограммы.  Создатель L2TP-туннеля выбирает доступный UDP-порт
(который может быть или не быть 1701),  и посылает пакет по нужному адресу места назначения с номером порта
1701.  Получатель выбирает свободный номер порта в своей системе  (который может быть или не быть 1701),  и
посылает отклик инициатору по его номеру порта и адресу.  Раз номера портов отправителя и получателя
определены,  они должны оставаться неизменными в течение всей жизни туннеля.
Может происходить  IP-фрагментация,  так как L2TP-пакет путешествует через Интернет.  Протокол L2TP не
предпринимает каких-то специальных усилий,  чтобы оптимизировать этот процесс.
По умолчанию для любых реализаций L2TP должно быть активизировано контрольное суммирование UDP как для
управляющих,  так и информационных сообщений.  Реализация L2TP может предоставить опцию,  способную
блокировать контрольное суммирование UDP-дейтограмм для информационных сообщений.  Рекомендуется,  чтобы
контрольные суммы UDP были всегда активированы для управляющих сообщений.
Порт 1701 используется как пакетами L2F  [RFC2341],  так и L2TP.  Поле версия в каждом из заголовков может
использоваться,  чтобы отличить пакеты этих двух типов  (L2F использует значение 1,  а версия L2TP,  описанная в этом
документе,  использует 2).  Реализация L2TP,  работающая в системе,  которая не поддерживает L2F,  должна
отбрасывать все L2F-пакеты.
Для PPP-клиентов,  использующих туннель L2TP-поверх-UDP/IP,  PPP-связь имеет возможность менять порядок или
отбрасывать пакеты.  В первом случае могут нарушаться протоколы,  отличные от  IP и использующие для
транспортировки PPP.  Во втором - могут нарушаться протоколы,  в которых предполагается по пакетный контроль
ошибок,  такой как TCP со сжатием заголовков.  Контроль порядка можно осуществить,  используя номера
информационных L2TP-сообщений,  если какой-то протокол,  транспортируемый через PPP-туннель,  не способен
справиться с изменением порядка пакетов.
Молчаливое отбрасывание пакетов может оказаться проблематичным для некоторых протоколов.  Если в PPP
разрешена надежная доставка  [RFC1663],  никакой выше расположенный протокол не может столкнуться с потерей
пакетов.  Если в L2TP разрешена нумерация пакетов,  L2TP может контролировать потерю пакетов.  В случае LNS,  PPP
и L2TP стеки присутствуют в LNS,  и потеря пакета может регистрироваться,  как если бы пакет получен с неверной
CRC.  Когда клиенты LAC и PPP физически различны,  возможна аналоговая сигнализация,  реализуемая путем
посылки PPP-клиенту пакета с неверной контрольной суммой.  Заметим,  что это сильно усложнит отладку канальных
программ клиента,  так как статистика клиента не сможет отличить истинные ошибки транспортной среды от
ошибок,  инициированных LAC.  Эта техника нереализуема на аппаратном уровне.
Если используется VJ-сжатие,  и не разрешена ни надежная доставка в PPP,  ни нумерация пакетов,  каждый
потерянный пакет будет приводить к вероятности 2
-16
того,  что сегмент TCP будет переадресован с неверным
содержимым  [RFC1144].  Там где вероятность потери велика,  не следует использовать сжатие заголовков TCP-сегментов.
8.2. IP
При работе в  IP-среде протокол L2TP должен обеспечить UDP-инкапсуляцию,  описанную в 8. 1.  Другие
конфигурации  (возможно соответствующие формату со сжатием заголовков) могут быть определены и доступны в
10.10.13 4.4.1.3 Протокол туннелей на сетевом уровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 37/41
качестве конфигурируемой опции.
9. Соображения безопасности
Протокол L2TP сталкивается при своей работе с несколькими проблемами безопасности.  Ниже рассмотрены
некоторые подходы для решения этих проблем.
9.1. Безопасность на конце туннеля
Концы туннеля могут опционно выполнять процедуру аутентификации друг друга при установлении туннеля.  Эта
аутентификация имеет те же атрибуты безопасности,  что и CHAP,  и обладает разумной защитой против атак
воспроизведения и искажения в процессе установления туннеля.  Этот механизм не реализует аутентификации при
формировании туннеля;  так как достаточно просто для злонамеренного пользователя,  который наблюдает обмен в
туннеле,  ввести свои пакеты,  когда аутентификация полностью завершена.
Для реализации аутентификации LAC и LNS должны использовать общий секретный ключ.  Каждая из сторон
использует один и тот же ключ,  когда выполняет роль аутентификатора и аутентифицируемого.  Так как
используется только один ключ,  AVP аутентификации туннеля несут в себе разные значения полей в CHAP  ID для
вычисления дайджеста каждого сообщения,  чтобы противостоять атакам воспроизведения.
Assigned Tunnel  ID и Assigned Session  ID  (смотри раздел 4. 4. 3) должны быть выбраны непредсказуемым образом.
Такая методика препятствует деятельности хакеров,  которые не имеют доступа к пакетам,  которыми обмениваются
LAC и LNS.
9.2. Безопасность пакетного уровня
Обеспечение безопасности L2TP требует,  чтобы транспортная среда могла обеспечить шифрование передаваемых
данных,  целостность сообщений и аутентификацию услуг для всего L2TP-трафика.  Этот безопасный транспорт
работает с пакетом L2TP в целом и функционально независим от PPP и протокола,  вложенного в PPP.  Как таковой,
L2TP ответственен за конфиденциальность,  целостность и аутентифицированность L2TP-пакетов внутри туннеля
(LAC и LNS).
9.3. Безопасность от начала до конца
Защищая поток L2TP-пакетов,  так как это делает безопасный транспорт,  мы защищаем данные,  передаваемые по
PPP-туннелю от LAC к LNS.  Такая защита не должна рассматриваться как замена для безопасности точка-точка при
передаче данных между ЭВМ или приложениями.
9.4. L2TP и IPsec
При работе поверх  IP,   IPsec  (безопасный  IP) предоставляет безопасность на пакетном уровне за счет ESP и/или AH.
Все управляющие и информационные пакеты L2TP в конкретном туннеле выглядят для системы  Ipsec,  как обычные
информационные UDP/IP-пакеты.
Помимо транспортной безопасности  IP,   IPsec определяет режим работы,  который позволяет туннелировать  IP-пакеты.
Шифрование и аутентификация на пакетном уровне,  выполняемые режимом туннеля  IPsec и средства L2TP,
поддержанные  IPsec предоставляют эквивалентные уровни безопасности.
IPsec определяет также средства контроля доступа,  которые необходимы для приложений,  поддерживающих  IPsec.
Эти средства позволяют фильтровать пакеты,  на основе характеристик сетевого и транспортного уровней,  таких как
IP-адрес,  порт,  и т. д.  В модели L2TP-туннеля,  аналогичная фильтрация выполняется на PPP-уровне или сетевом
уровне поверх L2TP.  Эти средства управления доступом на сетевом уровне могут быть реализованы в LNS за счет
механизма авторизации,  специфицированного производителем,  или на сетевом уровне,  используя транспортный
режим  IPsec точка-точка между взаимодействующими ЭВМ.
10.10.13 4.4.1.3 Протокол туннелей на сетевом у ровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 38/41
9.5. Аутентификация прокси PPP
L2TP определяет AVP,  которые могут пересылаться в процессе установления сессии с целью передачи PPP
аутентификационной информации,  полученной в LAC,  для перепроверки в LNS  (смотри раздел 4. 4. 5).  Это
предполагает полное доверие между LAC и LNS.  Если LNS решит использовать прокси аутентификацию,  она должна
быть конфигурируема,  требуя нового цикла PPP-аутентификации по инициативе LNS  (который может включать или
нет новый раунд согласования параметров с LCP).
10. Соображения IANA
Этот документ определяет ряд "магических" числе,  которые определяются  IANA.  Эта секция объясняет критерии,
которые должна использовать  IANA при присвоении дополнительных чисел в каждый из этих списков.  Следующие
субсекции описывают политику присвоения для пространства имен,  определенных в данном документе.
10.1. Атрибуты AVP
Как это определено в разделе 4. 1,  AVP содержат поля  ID производителя,  атрибута и значения.  Для  ID производителя
значение 0  IANA поддерживает регистр присвоенных атрибутов,  а в некоторых случаях и значений.  Атрибуты 0-39
присвоены согласно тому,  как это описано в разделе 4. 4.  Остальные значения доступны для присвоения при
согласовании с  IETF  [RFC 2434].
10.2. Значения типа сообщения AVP
Как определено в разделе 4. 4. 1,  AVP типа сообщения  (тип атрибута 0) имеет значение поддерживаемое  IANA.
Значения 0-16 определены в разделе 3. 2,  остальные - могут присваиваться по согласованию с  IETF  [RFC 2434]
10.3. Значения результирующих кодов AVP
Как это определено в разделе 4. 4. 2,  результирующий код AVP  (тип атрибута 1) содержит три поля.  Два из них  (поля
кодов результата и ошибки) имеют значения,  обслуживаемые  IANA.
10.3.1.  Значения поля кода результата
AVP кода результата может быть включено в сообщения CDN и StopCCN.  Допустимые значения поля кода
результата AVP зависят от значения типа сообщения AVP.  Для сообщения StopCCN,  значения 0-7 определены в
разделе 4. 4. 2;  для сообщения StopCCN,  значения 0-11 определены в том же разделе.  Оставшиеся значения поля
кода результата для обоих сообщений доступны для присвоения через согласование с  IETF  [RFC 2434].
10.3.2.  Значения поля кода ошибки
Значения 0-7 определены в разделе 4. 4. 2.  Значения 8-32767 доступны для присвоения через согласование с  IETF
[RFC 2434].  Оставшиеся значения поля кода ошибки доступны для присвоения в соответствии с алгоритмом
“первый пришел - первым обслужен”  [RFC 2434].
10.4. Framing Capabilities & Bearer Capabilities
AVP Framing Capabilities и Bearer  Capabilities  (определенные в разделе 4. 4. 3) содержат 32-битовые маски.
Дополнительные биты могут быть определены через стандартную процедуру  [RFC 2434].
10.5. Значения типов прокси аутентификации AVP
10.10.13 4.4.1.3 Протокол туннелей на сетевом уровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 39/41
AVP типа прокси Authen  (тип атрибута 29) имеет ассоциированное значение,  поддерживаемое  IANA.  Значения 0-5
определены в разделе 4. 4. 5,  оставшиеся значения доступны для присвоения по схеме “первым пришел - первым
обслужен”  [RFC 2434].
10.6. Биты заголовка AVP
Имеется 4 резервных бита в заголовке AVP.  Дополнительные биты должны присваиваться через стандартную
процедуру  [RFC 2434].
11. Ссылки
[DSS1]
ITU-T Recommendation,  "Digital subscr iber  Signaling System No.  1  (DSS 1) -  ISDN user-network
inter face  layer  3 specification  for  basic call control",  Rec.  Q. 931(I. 451),  May 1998
[KPS]
Kaufman,  C. ,  Per lman,  R. ,  и Speciner ,  M. ,  "Network Secur ity:  Pr ivate Communications  in a Public
Wor ld",  Prentice Hall,  March 1995,   ISBN 0-13-061466-1
[RFC791] Postel,   J. ,  "Internet Protocol",  STD 5,  RFC 791,  September  1981.
[RFC1034] Mockapetr is,  P. ,  "Domain Names - Concepts и Facilities",  STD 13,  RFC 1034,  November  1987.
[RFC1144] Jacobson,  V. ,  "Compressing TCP/IP Headers  for  Low-Speed Ser ial Links",  RFC 1144,  February 1990.
[RFC1661] Simpson,  W. ,  "The Point-to-Point Protocol  (PPP)",  STD 51,  RFC 1661,   July 1994.
[RFC1662] Simpson,  W. ,  "PPP  in HDLC-like Framing",  STD 51,  RFC 1662,   July 1994.
[RFC1663] Rand,  D. ,  "PPP Reliable Transmission",  RFC 1663,   July 1994.
[RFC1700]
Reynolds,   J.  и  J.  Postel,  "Assigned Numbers",  STD 2,  RFC 1700,  October  1994.  Смотри также:
http: //www. iana. org/numbers. html
[RFC1990]
Sklower ,  K. ,  Lloyd,  B. ,  McGregor ,  G. ,  Car r ,  D.  и T.  Coradetti,  "The PPP Multilink Protocol  (MP)",  RFC
1990,  August 1996.
[RFC1994] Simpson,  W. ,  "PPP Challenge Handshake Authentication Protocol  (CHAP)",  RFC 1994,  August 1996.
[RFC1918]
Rekhter ,  Y. ,  Moskowitz,  B. ,  Kar renberg,  D. ,  de Groot,  G.  и E.  Lear ,  "Address Allocation  for  Pr ivate
Internets",  BCP 5,  RFC 1918,  February 1996.
[RFC2119]
Bradner ,  S. ,  "Key words  for  use  in RFCs  to  Indicate Requirement Levels",  BCP 14,  RFC 2119,  March
1997.
[RFC2138]
Rigney,  C. ,  Rubens,  A. ,  Simpson,  W.  и S.  Willens,  "Remote Authentication Dial  In User  Service
(RADIUS)",  RFC 2138,  Apr il 1997.
[RFC2277] Alvestrand,  H. ,  "IETF Policy on Character  Sets и Languages",  BCP 18,  RFC 2277,   January 1998.
[RFC2341]
Valencia,  A. ,  Littlewood,  M.  и T.  Kolar ,  "Cisco Layer  Two Forwarding  (Protocol) L2F",  RFC 2341,  May
1998.
[RFC2401] Kent,  S.  и R.  Atkinson,  "Secur ity Architecture  for   the  Internet Protocol",  RFC 2401,  November  1998.
[RFC2434]
Nar ten,  T.  и H.  Alvestrand,  "Guidelines  for  Wr iting an  IANA Considerations Section  in RFCs",  BCP 26,
RFC 2434,  October  1998.
[RFC2637]
Hamzeh,  K. ,  Pall,  G. ,  Ver thein,  W. ,  Taarud,   J. ,  Little,  W.  и G.  Zorn,  "Point-to-Point Tunneling Protocol
(PPTP)",  RFC 2637,   July 1999.
[STEVENS]
Stevens,  W.  Richard,  "TCP/IP  Illustrated,  Volume  I The Protocols",  Addison-Wesley Publishing
Company,   Inc. ,  March 1996,   ISBN 0-201-63346-9
Приложение A:
Медленный старт в управляющем канале и подавление перегрузки
10.10.13 4.4.1.3 Протокол туннелей на сетевом уровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 40/41
Хотя каждая из сторон указала максимальный размер окна приема,  рекомендуется,  чтобы при передаче
управляющих пакетов использовался медленный старт и метод подавления перегрузки.  Методы,  описанные здесь,
базируются на TCP-алгоритме подавления перегрузки,  как это описано в разделе 21. 6 книги “TCP/IP  Illustrated”,  том  I,
написанной W.  Richard Stevens  [STEVENS].
Медленный старт и подавление перегрузки используют несколько переменных.  Окно перегрузки  (CWND)
определяет число пакетов,  которые отправитель может послать,  не дожидаясь подтверждения.  Размер CWND
расширяется и сокращается так,  как это описано ниже.  Заметим,  однако,  что CWND никогда не должно превышать
размера окна,  полученного из AVP приемного окна  (далее предполагается,  что любое увеличение ограничивается
размером приемного окна).  Переменная SSTHRESH определяет,  когда отправитель переходит от медленного старта
к подавлению перегрузки.  Медленный старт используется,  когда CWND меньше SSHTRESH.
Отправитель начинает работу с фазы медленного старта.  Начальный размер CWND равен одному пакету,  а уровень
SSHTRESH в начальный момент определяется размером окна  (полученным из AVP приемного окна).  Отправитель
передает один пакет и ждет подтверждения получения.  Когда подтверждение получено,  окно перегрузки
увеличивается на единицу и становится равным двум.  Во время медленного старта,  размер CWND увеличивается на
единицу при получении каждого ACK.  Увеличение CWND на 1 при получении ACK приводит к удвоению CWND за
время RTT,  что эквивалентно экспоненциальному росту.  Когда значение CWND достигает SSHTRESH,  фаза
медленного старта завершается и начинается подавление перегрузки.
При подавлении перегрузки,  CWND расширяется более медленно.  В частности,  оно увеличивается на 1/CWND для
каждого полученного подтверждения ACK.  Расширение окна на фазе подавления перегрузки является линейным,  с
увеличением CWND на 1 за время RTT.
Когда происходит перегрузка  (индицируемая повторной передачей пакета) половина CWND записывается в
SSTHRESH,  а CWND делается равным 1.  Отправитель после этого возвращается в режим медленного старта.
Приложение B: Примеры управляющих сообщений
B.1: Установление туннеля Lock-step
В этом примере,  LAC формирует туннель,  при этом реализуется обмен сообщениями в обоих направлениях.  В этом
примере показано,  что окончательное подтверждение посылается в сообщении ZLB ACK.  Альтернативой может
быть подтверждение,  пришедшее в сообщении,  посланном в ответ на  ICRQ или OCRQ,  которые направляются
стороной,  инициировавшей формирование туннеля.
LAC или LNSLNS или LAC
SCCRQ ->
Nr :  0,  Ns:  0
<- SCCRP
Nr :  1,  Ns:  0
SCCCN ->
Nr :  1,  Ns:  1
<- ZLB
Nr :  2,  Ns:  1
B.2: Потеря пакета и повторная передача
Существующий туннель имеет новую сессию,  запрошенную LAC.  Пакет  ICRP потерян и должен быть послан LNS
повторно.  Заметим,  что потеря  ICRP несет в себе две проблемы:  это не только блокирует машину состояний
высокого уровня,  но и лишает LAC своевременного прихода подтверждения его  ICRQ на нижнем уровне.
LAC LNS
ICRQ ->
Nr :  1,  Ns:  2
(пакет потерян) <-  ICRP
10.10.13 4.4.1.3 Протокол туннелей на сетевом уровне L2 (L2TP)
book .itep.ru/4/44/l2pr.htm 41/41
Nr :  3,  Ns:  1
(пауза;  таймер LAC запускается первым,  поэтому первым и срабатывает)
ICRQ ->
Nr :  1,  Ns:  2
(Понимая,  что он уже видел этот пакет,  LNS отбрасывает его и посылает ZLB)
<- ZLB
Nr :  3,  Ns:  2
(срабатывает таймер повторной передачи LNS)
<-  ICRP
Nr :  3,  Ns:  1
ICCN ->
Nr :  2,  Ns:  3
<- ZLB
Nr :  4,  Ns:  2
Previ ous: 4. 4. 1. 2  IP-туннели       UP: 4. 4. 1  IP-протокол







Network Working Group                                          K. Hamzeh
Request for Comments: 2637                         Ascend Communications
Category: Informational                                          G. Pall
                                                   Microsoft Corporation
                                                             W. Verthein
                                                                    3Com
                                                               J. Taarud
                                                Copper Mountain Networks
                                                               W. Little
                                                          ECI Telematics
                                                                 G. Zorn
                                                   Microsoft Corporation
                                                               July 1999


                Point-to-Point Tunneling Protocol (PPTP)

Status of this Memo

   This memo provides information for the Internet community.  It does
   not specify an Internet standard of any kind.  Distribution of this
   memo is unlimited.

Copyright Notice

   Copyright (C) The Internet Society (1999).  All Rights Reserved.

IESG Note

   The PPTP protocol was developed by a vendor consortium. The
   documentation of PPTP is provided as information to the Internet
   community. The PPP WG is currently defining a Standards Track
   protocol (L2TP) for tunneling PPP across packet-switched networks.

Abstract

   This document specifies a protocol which allows the Point to Point
   Protocol (PPP) to be tunneled through an IP network.  PPTP does not
   specify any changes to the PPP protocol but rather describes a new
   vehicle for carrying PPP.  A client-server architecture is defined in
   order to decouple functions which exist in current Network Access
   Servers (NAS) and support Virtual Private Networks (VPNs).  The PPTP
   Network Server (PNS) is envisioned to run on a general purpose
   operating system while the client, referred to as a PPTP Access
   Concentrator (PAC) operates on a dial access platform.  PPTP
   specifies a call-control and management protocol which allows the
   server to control access for dial-in circuit switched calls
   originating from a PSTN or ISDN or to initiate outbound circuit-



Hamzeh, et al.               Informational                      [Page 1]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


   switched connections.  PPTP uses an enhanced GRE (Generic Routing
   Encapsulation) mechanism to provide a flow- and congestion-controlled
   encapsulated datagram service for carrying PPP packets.

Specification of Requirements

   In this document, the key words "MAY", "MUST, "MUST NOT", "optional",
   "recommended", "SHOULD", and "SHOULD NOT" are to be interpreted as
   described in [12].

   The words "silently discard", when used in reference to the behavior
   of an implementation upon receipt of an incoming packet, are to be
   interpreted as follows: the implementation discards the datagram
   without further processing, and without indicating an error to the
   sender.  The implementation SHOULD provide the capability of logging
   the error, including the contents of the discarded datagram, and
   SHOULD record the event in a statistics counter.

Table of Contents

   1. Introduction  . . . . . . . . . . . . . . . . . . . . . . . .   3
   1.1.  Protocol Goals and Assumptions . . . . . . . . . . . . . .   4
   1.2.  Terminology  . . . . . . . . . . . . . . . . . . . . . . .   5
   1.3.  Protocol Overview  . . . . . . . . . . . . . . . . . . . .   6
   1.3.1.  Control Connection Overview  . . . . . . . . . . . . . .   7
   1.3.2.  Tunnel Protocol Overview . . . . . . . . . . . . . . . .   7
   1.4.  Message Format and Protocol Extensibility  . . . . . . . .   8
   2.  Control Connection Protocol Specification  . . . . . . . . .  10
   2.1.  Start-Control-Connection-Request . . . . . . . . . . . . .  10
   2.2.  Start-Control-Connection-Reply . . . . . . . . . . . . . .  12
   2.3.  Stop-Control-Connection-Request  . . . . . . . . . . . . .  15
   2.4.  Stop-Control-Connection-Reply  . . . . . . . . . . . . . .  16
   2.5.  Echo-Request . . . . . . . . . . . . . . . . . . . . . . .  17
   2.6.  Echo-Reply . . . . . . . . . . . . . . . . . . . . . . . .  18
   2.7.  Outgoing-Call-Request  . . . . . . . . . . . . . . . . . .  19
   2.8.  Outgoing-Call-Reply  . . . . . . . . . . . . . . . . . . .  22
   2.9.  Incoming-Call-Request  . . . . . . . . . . . . . . . . . .  25
   2.10.  Incoming-Call-Reply . . . . . . . . . . . . . . . . . . .  28
   2.11.  Incoming-Call-Connected . . . . . . . . . . . . . . . . .  29
   2.12.  Call-Clear-Request  . . . . . . . . . . . . . . . . . . .  31
   2.13.  Call-Disconnect-Notify  . . . . . . . . . . . . . . . . .  32
   2.14.  WAN-Error-Notify  . . . . . . . . . . . . . . . . . . . .  33
   2.15.  Set-Link-Info . . . . . . . . . . . . . . . . . . . . . .  35
   2.16.  General Error Codes . . . . . . . . . . . . . . . . . . .  36
   3.  Control Connection Protocol Operation  . . . . . . . . . . .  36
   3.1.  Control Connection States  . . . . . . . . . . . . . . . .  37
   3.1.1.  Control Connection Originator (may be PAC or PNS)  . . .  37
   3.1.2.  Control connection Receiver (may be PAC or PNS)  . . . .  39



Hamzeh, et al.               Informational                      [Page 2]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


   3.1.3.  Start Control Connection Initiation Request Collision  .  40
   3.1.4.  Keep Alives and Timers . . . . . . . . . . . . . . . . .  40
   3.2.  Call States  . . . . . . . . . . . . . . . . . . . . . . .  41
   3.2.1.  Timing considerations  . . . . . . . . . . . . . . . . .  41
   3.2.2.  Call ID Values . . . . . . . . . . . . . . . . . . . . .  41
   3.2.3.  Incoming Calls . . . . . . . . . . . . . . . . . . . . .  41
   3.2.3.1.  PAC Incoming Call States . . . . . . . . . . . . . . .  42
   3.2.3.2.  PNS Incoming Call States . . . . . . . . . . . . . . .  43
   3.2.4.  Outgoing Calls . . . . . . . . . . . . . . . . . . . . .  44
   3.2.4.1.  PAC Outgoing Call States . . . . . . . . . . . . . . .  45
   3.2.4.2.  PNS Outgoing Call States . . . . . . . . . . . . . . .  46
   4.  Tunnel Protocol Operation  . . . . . . . . . . . . . . . . .  47
   4.1.  Enhanced GRE header  . . . . . . . . . . . . . . . . . . .  47
   4.2.  Sliding Window Protocol  . . . . . . . . . . . . . . . . .  49
   4.2.1.  Initial Window Size  . . . . . . . . . . . . . . . . . .  49
   4.2.2.  Closing the Window . . . . . . . . . . . . . . . . . . .  49
   4.2.3.  Opening the Window . . . . . . . . . . . . . . . . . . .  50
   4.2.4.  Window Overflow  . . . . . . . . . . . . . . . . . . . .  50
   4.2.5.  Multi-packet Acknowledgment  . . . . . . . . . . . . . .  50
   4.3.  Out-of-sequence Packets  . . . . . . . . . . . . . . . . .  50
   4.4.  Acknowledgment Time-Outs . . . . . . . . . . . . . . . . .  51
   4.4.1.  Calculating Adaptive Acknowledgment Time-Out . . . . . .  53
   4.4.2.  Congestion Control: Adjusting for Time-Out . . . . . . .  54
   5.  Security Considerations  . . . . . . . . . . . . . . . . . .  54
   6.  Authors' Addresses . . . . . . . . . . . . . . . . . . . . .  55
   7.  References . . . . . . . . . . . . . . . . . . . . . . . . .  56
   8.  Full Copyright Statement . . . . . . . . . . . . . . . . . .  57

1.  Introduction

   PPTP allows existing Network Access Server (NAS) functions to be
   separated using a client-server architecture. Traditionally, the
   following functions are implemented by a NAS:

      1) Physical native interfacing to PSTN or ISDN and control of
         external modems or terminal adapters.

         A NAS may interface directly to a telco analog or digital
         circuit or attach via an external modem or terminal adapter.
         Control of a circuit-switched connection is accomplished with
         either modem control or DSS1 ISDN call control protocols.

         The NAS, in conjunction with the modem or terminal adapters,
         may perform rate adaption, analog to digital conversion, sync
         to async conversion or a number of other alterations of data
         streams.





Hamzeh, et al.               Informational                      [Page 3]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


      2) Logical termination of a Point-to-Point-Protocol (PPP) Link
         Control Protocol (LCP) session.

      3) Participation in PPP authentication protocols [3,9,10].

      4) Channel aggregation and bundle management for PPP Multilink
         Protocol.

      5) Logical termination of various PPP network control protocols
         (NCP).

      6) Multiprotocol routing and bridging between NAS interfaces.

   PPTP divides these functions between the PAC and PNS. The PAC is
   responsible for functions 1, 2, and possibly 3. The PNS may be
   responsible for function 3 and is responsible for functions 4, 5, and
   6.  The protocol used to carry PPP protocol data units (PDUs) between
   the PAC and PNS, as well as call control and management is addressed
   by PPTP.

   The decoupling of NAS functions offers these benefits:

      Flexible IP address management. Dial-in users may maintain a
      single IP address as they dial into different PACs as long as they
      are served from a common PNS. If an enterprise network uses
      unregistered addresses, a PNS associated with the enterprise
      assigns addresses meaningful to the private network.

      Support of non-IP protocols for dial networks behind IP networks.
      This allows Appletalk and IPX, for example to be tunneled through
      an IP-only provider. The PAC need not be capable of processing
      these protocols.

      A solution to the "multilink hunt-group splitting" problem.
      Multilink PPP, typically used to aggregate ISDN B channels,
      requires that all of the channels composing a multilink bundle be
      grouped at a single NAS.  Since a multilink PPP bundle can be
      handled by a single PNS, the channels comprising the bundle may be
      spread across multiple PACs.

1.1.  Protocol Goals and Assumptions

   The PPTP protocol is implemented only by the PAC and PNS. No other
   systems need to be aware of PPTP. Dial networks may be connected to a
   PAC without being aware of PPTP. Standard PPP client software should
   continue to operate on tunneled PPP links.





Hamzeh, et al.               Informational                      [Page 4]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


   PPTP can also be used to tunnel a PPP session over an IP network. In
   this configuration the PPTP tunnel and the PPP session runs between
   the same two machines with the caller acting as a PNS.

   It is envisioned that there will be a many-to-many relationship
   between PACs and PNSs.  A PAC may provide service to many PNSs. For
   example, an Internet service provider may choose to support PPTP for
   a number of private network clients and create VPNs for them. Each
   private network may operate one or more PNSs. A single PNS may
   associate with many PACs to concentrate traffic from a large number
   of geographically diverse sites.

   PPTP uses an extended version of GRE to carry user PPP packets. These
   enhancements allow for low-level congestion and flow control to be
   provided on the tunnels used to carry user data between PAC and PNS.
   This mechanism allows for efficient use of the bandwidth available
   for the tunnels and avoids unnecessary retransmisions and buffer
   overruns.  PPTP does not dictate the particular algorithms to be used
   for this low level control but it does define the parameters that
   must be communicated in order to allow such algorithms to work.
   Suggested algorithms are included in section 4.

1.2.  Terminology

   Analog Channel

      A circuit-switched communication path which is intended to carry
      3.1 Khz audio in each direction.

   Digital Channel

      A circuit-switched communication path which is intended to carry
      digital information in each direction.

   Call

      A connection or attempted connection between two terminal
      endpoints on a PSTN or ISDN -- for example, a telephone call
      between two modems.

   Control Connection

      A control connection is created for each PAC, PNS pair and
      operates over TCP [4]. The control connection governs aspects of
      the tunnel and of sessions assigned to the tunnel.






Hamzeh, et al.               Informational                      [Page 5]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


   Dial User

      An end-system or router attached to an on-demand PSTN or ISDN
      which is either the initiator or recipient of a call.

   Network Access Server (NAS)

      A device providing temporary, on-demand network access to users.
      This access is point-to-point using PSTN or ISDN lines.

   PPTP Access Concentrator (PAC)

      A device attached to one or more PSTN or ISDN lines capable of PPP
      operation and of handling the PPTP protocol. The PAC need only
      implement TCP/IP to pass traffic to one or more PNSs. It may also
      tunnel non-IP protocols.

   PPTP Network Server (PNS)

      A PNS is envisioned to operate on general-purpose computing/server
      platforms. The PNS handles the server side of the PPTP protocol.
      Since PPTP relies completely on TCP/IP and is independent of the
      interface hardware, the PNS may use any combination of IP
      interface hardware including LAN and WAN devices.

   Session

      PPTP is connection-oriented.  The PNS and PAC maintain state for
      each user that is attached to a PAC.  A session is created when
      end-to-end PPP connection is attempted between a dial user and the
      PNS.  The datagrams related to a session are sent over the tunnel
      between the PAC and PNS.

   Tunnel

      A tunnel is defined by a PNS-PAC pair.  The tunnel protocol is
      defined by a modified version of GRE [1,2].  The tunnel carries
      PPP datagrams between the PAC and the PNS.  Many sessions are
      multiplexed on a single tunnel.  A control connection operating
      over TCP controls the establishment, release, and maintenance of
      sessions and of the tunnel itself.

1.3.  Protocol Overview

   There are two parallel components of PPTP: 1) a Control Connection
   between each PAC-PNS pair operating over TCP and 2) an IP tunnel
   operating between the same PAC-PNS pair which is used to transport
   GRE encapsulated PPP packets for user sessions between the pair.



Hamzeh, et al.               Informational                      [Page 6]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


1.3.1.  Control Connection Overview

   Before PPP tunneling can occur between a PAC and PNS, a control
   connection must be established between them. The control connection
   is a standard TCP session over which PPTP call control and management
   information is passed. The control session is logically associated
   with, but separate from, the sessions being tunneled through a PPTP
   tunnel.  For each PAC-PNS pair both a tunnel and a control connection
   exist. The control connection is responsible for establishment,
   management, and release of sessions carried through the tunnel. It is
   the means by which a PNS is notified of an incoming call at an
   associated PAC, as well as the means by which a PAC is instructed to
   place an outgoing dial call.

   A control connection can be established by either the PNS or the PAC.
   Following the establishment of the required TCP connection, the PNS
   and PAC establish the control connection using the Start-Control-
   Connection-Request and -Reply messages.  These messages are also used
   to exchange information about basic operating capabilities of the PAC
   and PNS.  Once the control connection is established, the PAC or PNS
   may initiate sessions by requesting outbound calls or responding to
   inbound requests. The control connection may communicate changes in
   operating characteristics of an individual user session with a Set-
   Link-Info message.  Individual sessions may be released by either the
   PAC or PNS, also through Control Connection messages.

   The control connection itself is maintained by keep-alive echo
   messages.  This ensures that a connectivity failure between the PNS
   and the PAC can be detected in a timely manner. Other failures can be
   reported via the

   Wan-Error-Notify message, also on the control connection.

   It is intended that the control connection will also carry management
   related messages in the future, such as a message allowing the PNS to
   request the status of a given PAC; these message types have not yet
   been defined.

1.3.2.  Tunnel Protocol Overview

   PPTP requires the establishment of a tunnel for each communicating
   PNS-PAC pair.  This tunnel is used to carry all user session PPP
   packets for sessions involving a given PNS-PAC pair.  A key which is
   present in the GRE header indicates which session a particular PPP
   packet belongs to.






Hamzeh, et al.               Informational                      [Page 7]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


   In this manner, PPP packets are multiplexed and demultiplexed over a
   single tunnel between a given PNS-PAC pair.  The value to use in the
   key field is established by the call establishment procedure which
   takes place on the control connection.

   The GRE header also contains acknowledgment and sequencing
   information that is used to perform some level of congestion-control
   and error detection over the tunnel.  Again the control connection is
   used to determine rate and buffering parameters that are used to
   regulate the flow of PPP packets for a particular session over the
   tunnel.  PPTP does not specify the particular algorithms to use for
   congestion-control and flow-control.  Suggested algorithms for the
   determination of adaptive time-outs to recover from dropped data or
   acknowledgments on the tunnel are included in section 4.4 of this
   document.

1.4.  Message Format and Protocol Extensibility

   PPTP defines a set of messages sent as TCP data on the control
   connection between a PNS and a given PAC.  The TCP session for the
   control connection is established by initiating a TCP connection to
   port 1723 [6]. The source port is assigned to any unused port number.

   Each PPTP Control Connection message begins with an 8 octet fixed
   header portion.  This fixed header contains the following: the total
   length of the message, the PPTP Message Type indicator, and a "Magic
   Cookie".

   Two Control Connection message types are indicated by the PPTP
   Message Type field:

         1 - Control Message
         2 - Management Message

   Management messages are currently not defined.

   The Magic Cookie is always sent as the constant 0x1A2B3C4D.  Its
   basic purpose is to allow the receiver to ensure that it is properly
   synchronized with the TCP data stream.  It should not be used as a
   means for resynchronizing the TCP data stream in the event that a
   transmitter issues an improperly formatted message.  Loss of
   synchronization must result in immediate closing of the control
   connection's TCP session.

   For clarity, all Control Connection message templates in the next
   section include the entire PPTP Control Connection message header.
   Numbers preceded by 0x are hexadecimal values.




Hamzeh, et al.               Informational                      [Page 8]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


The currently defined Control Messages, grouped by function, are:

         Control Message                        Message Code

         (Control Connection Management)

         Start-Control-Connection-Request            1
         Start-Control-Connection-Reply              2
         Stop-Control-Connection-Request             3
         Stop-Control-Connection-Reply               4
         Echo-Request                                5
         Echo-Reply                                  6

         (Call Management)

         Outgoing-Call-Request                       7
         Outgoing-Call-Reply                         8
         Incoming-Call-Request                       9
         Incoming-Call-Reply                        10
         Incoming-Call-Connected                    11
         Call-Clear-Request                         12
         Call-Disconnect-Notify                     13

         (Error Reporting)

         WAN-Error-Notify                           14

         (PPP Session Control)

         Set-Link-Info                              15

   The Start-Control-Connection-Request and -Reply messages determine
   which version of the Control Connection protocol will be used.  The
   version number field carried in these messages consists of a version
   number in the high octet and a revision number in the low octet.
   Version handling is described in section 2. The current value of the
   version number field is 0x0100 for version 1, revision 0.

   The use of the GRE-like header for the encapsulation of PPP user
   packets is specified in section 4.1.

   The MTU for the user data packets encapsulated in GRE is 1532 octets,
   not including the IP and GRE headers.








Hamzeh, et al.               Informational                      [Page 9]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


2.  Control Connection Protocol Specification

   Control Connection messages are used to establish and clear user
   sessions.  The first set of Control Connection messages are used to
   maintain the control connection itself.  The control connection is
   initiated by either the PNS or PAC after they establish the
   underlying TCP connection.  The procedure and configuration
   information required to determine which TCP connections are
   established is not covered by this protocol.

   The following Control Connection messages are all sent as user data
   on the established TCP connection between a given PNS-PAC pair.  Note
   that care has been taken to ensure that all word (2 octet) and
   longword (4 octet) values begin on appropriate boundaries.  All data
   is sent in network order (high order octets first).  Any "reserved"
   fields MUST be sent as 0 values to allow for protocol extensibility.

2.1.  Start-Control-Connection-Request

   The Start-Control-Connection-Request is a PPTP control message used
   to establish the control connection between a PNS and a PAC.  Each
   PNS-PAC pair requires a dedicated control connection to be
   established.  A control connection must be established before any
   other PPTP messages can be issued.  The establishment of the control
   connection can be initiated by either the PNS or PAC.  A procedure
   which handles the occurrence of a collision between PNS and PAC
   Start-Control-Connection-Requests is described in section 3.1.3.
























Hamzeh, et al.               Informational                     [Page 10]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |             Length            |       PPTP Message Type       |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                         Magic Cookie                          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |     Control Message Type      |           Reserved0           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |       Protocol Version        |           Reserved1           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                     Framing Capabilities                      |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                      Bearer Capabilities                      |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |       Maximum Channels        |       Firmware Revision       |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                                                               |
      +                     Host Name (64 octets)                     +
      |                                                               |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                                                               |
      +                   Vendor String (64 octets)                   +
      |                                                               |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

      Length                   Total length in octets of this PPTP
                               message, including the entire PPTP
                               header.

      PPTP Message Type        1 for Control Message.

      Magic Cookie             0x1A2B3C4D. This constant value is used
                               as a sanity check on received messages
                               (see section 1.4).

      Control Message Type     1 for Start-Control-Connection-Request.

      Reserved0                This field MUST be 0.

      Protocol Version         The version of the PPTP protocol that the
                               sender wishes to use.

      Reserved1                This field MUST be 0.







Hamzeh, et al.               Informational                     [Page 11]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


   Framing Capabilities     A set of bits indicating the type of framing
                            that the sender of this message can provide.
                            The currently defined bit settings are:

                               1 - Asynchronous Framing supported

                               2 - Synchronous Framing supported

   Bearer Capabilities      A set of bits indicating the bearer
                            capabilities that the sender of this message
                            can provide.  The currently defined bit
                            settings are:

                               1 - Analog access supported

                               2 - Digital access supported

   Maximum Channels         The total number of individual PPP sessions
                            this PAC can support.  In Start-Control-
                            Connection-Requests issued by the PNS, this
                            value SHOULD be set to 0.  It MUST be
                            ignored by the PAC.

   Firmware Revision        This field contains the firmware revision
                            number of the issuing PAC, when issued by
                            the PAC, or the version of the PNS PPTP
                            driver if issued by the PNS.

   Host Name                A 64 octet field containing the DNS name of
                            the issuing PAC or PNS.  If less than 64
                            octets in length, the remainder of this
                            field SHOULD be filled with octets of value
                            0.

   Vendor Name              A 64 octet field containing a vendor
                            specific string describing the type of PAC
                            being used, or the type of PNS software
                            being used if this request is issued by the
                            PNS.  If less than 64 octets in length, the
                            remainder of this field SHOULD be filled
                            with octets of value 0.

2.2.  Start-Control-Connection-Reply

   The Start-Control-Connection-Reply is a PPTP control message sent in
   reply to a received Start-Control-Connection-Request message.  This
   message contains a result code indicating the result of the control
   connection establishment attempt.



Hamzeh, et al.               Informational                     [Page 12]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |             Length            |       PPTP Message Type       |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                         Magic Cookie                          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |     Control Message Type      |           Reserved0           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |       Protocol Version        |  Result Code  |  Error Code   |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                      Framing Capability                       |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                       Bearer Capability                       |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |       Maximum Channels        |       Firmware Revision       |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                                                               |
      +                     Host Name (64 octets)                     +
      |                                                               |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                                                               |
      +                   Vendor String (64 octets)                   +
      |                                                               |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

   Length                   Total length in octets of this PPTP message,
                            including the entire PPTP header.

   PPTP Message Type        1 for Control Message.

   Magic Cookie             0x1A2B3C4D.

   Control Message Type     2 for Start-Control-Connection-Reply.

   Reserved0                This field MUST be 0.

   Protocol Version         The version of the PPTP protocol that the
                            sender wishes to use.

   Result Code              Indicates the result of the command channel
                            establishment attempt.  Current valid Result
                            Code values are:

                                  1 - Successful channel establishment

                                  2 - General error -- Error Code
                                      indicates the problem



Hamzeh, et al.               Informational                     [Page 13]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


                                  3 - Command channel already exists;

                                  4 - Requester is not authorized to
                                      establish a command channel

                                  5 - The protocol version of the
                                      requester is not supported

   Error Code               This field is set to 0 unless a "General
                            Error" exists, in which case Result Code is
                            set to 2 and this field is set to the value
                            corresponding to the general error condition
                            as specified in section 2.2.

   Framing Capabilities     A set of bits indicating the type of framing
                            that the sender of this message can provide.
                            The currently defined bit settings are:

                                  1 - Asynchronous Framing supported

                                  2 - Synchronous Framing supported.

   Bearer Capabilities      A set of bits indicating the bearer
                            capabilities that the sender of this message
                            can provide.  The currently defined bit
                            settings are:

                                  1 - Analog access supported

                                  2 - Digital access supported

   Maximum Channels         The total number of individual PPP sessions
                            this PAC can support.  In a Start-Control-
                            Connection-Reply issued by the PNS, this
                            value SHOULD be set to 0 and it must be
                            ignored by the PAC. The PNS MUST NOT use
                            this value to try to track the remaining
                            number of PPP sessions that the PAC will
                            allow.

   Firmware Revision        This field contains the firmware revision
                            number of the issuing PAC, or the version of
                            the PNS PPTP driver if issued by the PNS.








Hamzeh, et al.               Informational                     [Page 14]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


   Host Name                A 64 octet field containing the DNS name of
                            the issuing PAC or PNS.  If less than 64
                            octets in length, the remainder of this
                            field SHOULD be filled with octets of value
                            0.

   Vendor Name              A 64 octet field containing a vendor
                            specific string describing the type of PAC
                            being used, or the type of PNS software
                            being used if this request is issued by the
                            PNS.  If less than 64 octets in length, the
                            remainder of this field SHOULD be filled
                            with octets of value 0.

2.3.  Stop-Control-Connection-Request

   The Stop-Control-Connection-Request is a PPTP control message sent by
   one peer of a PAC-PNS control connection to inform the other peer
   that the control connection should be closed.  In addition to closing
   the control connection, all active user calls are implicitly cleared.
   The reason for issuing this request is indicated in the Reason field.

       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |             Length            |       PPTP Message Type       |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                         Magic Cookie                          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |     Control Message Type      |           Reserved0           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |    Reason     |   Reserved1   |           Reserved2           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

   Length                   Total length in octets of this PPTP message,
                            including the entire PPTP header.

   PPTP Message Type        1 for Control Message.

   Magic Cookie             0x1A2B3C4D.

   Control Message Type     3 for Stop-Control-Connection-Request.

   Reserved0                This field MUST be 0.

   Reason                   Indicates the reason for the control
                            connection being closed. Current valid
                            Reason values are:



Hamzeh, et al.               Informational                     [Page 15]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


                                  1 (None) - General request to clear
                                    control connection

                                  2 (Stop-Protocol) - Can't support
                                    peer's version of the protocol

                                  3 (Stop-Local-Shutdown) - Requester is
                                    being shut down

      Reserved1, Reserved2     These fields MUST be 0.

2.4.  Stop-Control-Connection-Reply

   The Stop-Control-Connection-Reply is a PPTP control message sent by
   one peer of a PAC-PNS control connection upon receipt of a Stop-
   Control-Connection-Request from the other peer.

       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |            Length             |       PPTP Message Type       |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                         Magic Cookie                          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |     Control Message Type      |           Reserved0           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |  Result Code  |   Error Code  |           Reserved1           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

   Length                   Total length in octets of this PPTP message,
                            including the entire PPTP header.

   PPTP Message Type        1 for Control Message.

   Magic Cookie             0x1A2B3C4D.

   Control Message Type     4 for Stop-Control-Connection-Reply.

   Reserved0                This field MUST be 0.

   Result Code              Indicates the result of the attempt to close
                            the control connection. Current valid Result
                            Code values are:








Hamzeh, et al.               Informational                     [Page 16]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


                                  1 (OK) - Control connection closed

                                  2 (General Error) - Control connection
                                    not closed for reason indicated in
                                    Error Code

   Error Code               This field is set to 0 unless a "General
                            Error" exists, in which case Result Code is
                            set to 2 and this field is set to the value
                            corresponding to the general error condition
                            as specified in section 2.2.

   Reserved1                This field MUST be 0.

2.5.  Echo-Request

   The Echo-Request is a PPTP control message sent by either peer of a
   PAC-PNS control connection. This control message is used as a "keep-
   alive" for the control connection.  The receiving peer issues an
   Echo-Reply to each Echo-Request received. As specified in section
   3.1.4, if the sender does not receive an Echo-Reply in response to an
   Echo-Request, it will eventually clear the control connection.

       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |            Length             |       PPTP Message Type       |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                         Magic Cookie                          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |     Control Message Type      |           Reserved0           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                          Identifier                           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

   Length                   Total length in octets of this PPTP message,
                            including the entire PPTP header.

   PPTP Message Type        1 for Control Message.

   Magic Cookie             0x1A2B3C4D.

   Control Message Type     5 for Echo-Request.

   Reserved0                This field MUST be 0.






Hamzeh, et al.               Informational                     [Page 17]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


   Identifier               A value set by the sender of the Echo-
                            Request that is used to match the reply with
                            the corresponding request.

2.6.  Echo-Reply

   The Echo-Reply is a PPTP control message sent by either peer of a
   PAC-PNS control connection in response to the receipt of an Echo-
   Request.

       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |            Length             |      PPTP Message Type        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                         Magic Cookie                          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |     Control Message Type      |           Reserved0           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                          Identifier                           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |  Result Code  |   Error Code  |           Reserved1           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

   Length                   Total length in octets of this PPTP message,
                            including the entire PPTP header.

   PPTP Message Type        1 for Control Message.

   Magic Cookie             0x1A2B3C4D.

   Control Message Type     6 for Echo-Reply.

   Reserved0                This field MUST be 0.

   Identifier               The contents of the identify field from the
                            received Echo-Request is copied to this
                            field.

   Result Code              Indicates the result of the receipt of the
                            Echo-Request. Current valid Result Code
                            values are:

                                  1 (OK) - The Echo-Reply is valid

                                  2 (General Error) - Echo-Request not
                                    accepted for the reason indicated in
                                    Error Code



Hamzeh, et al.               Informational                     [Page 18]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


   Error Code               This field is set to 0 unless a "General
                            Error" condition exists, in which case
                            Result Code is set to 2 and this field is
                            set to the value corresponding to the
                            general error condition as specified in
                            section 2.2.

   Reserved1                This field MUST be 0.

2.7.  Outgoing-Call-Request

   The Outgoing-Call-Request is a PPTP control message sent by the PNS
   to the PAC to indicate that an outbound call from the PAC is to be
   established.  This request provides the PAC with information required
   to make the call. It also provides information to the PAC that is
   used to regulate the transmission of data to the PNS for this session
   once it is established.


































Hamzeh, et al.               Informational                     [Page 19]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |            Length             |       PPTP Message Type       |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                         Magic Cookie                          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |     Control Message Type      |           Reserved0           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |            Call ID            |      Call Serial Number       |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                          Minimum BPS                          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                          Maximum BPS                          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                          Bearer Type                          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                         Framing Type                          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |   Packet Recv. Window Size    |    Packet Processing Delay    |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |      Phone Number Length      |           Reserved1           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                                                               |
      +                   Phone Number (64 octets)                    +
      |                                                               |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                                                               |
      +                    Subaddress (64 octets)                     +
      |                                                               |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

   Length                   Total length in octets of this PPTP message,
                            including the entire PPTP header.

   PPTP Message Type        1 for Control Message.

   Magic Cookie             0x1A2B3C4D.

   Control Message Type     7 for Outgoing-Call-Request.

   Reserved0                This field MUST be 0.









Hamzeh, et al.               Informational                     [Page 20]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


   Call ID                  A unique identifier, unique to a particular
                            PAC-PNS pair assigned by the PNS to this
                            session.  It is used to multiplex and
                            demultiplex data sent over the tunnel
                            between the PNS and PAC involved in this
                            session.

   Call Serial Number       An identifier assigned by the PNS to this
                            session for the purpose of identifying this
                            particular session in logged session
                            information.  Unlike the Call ID, both the
                            PNS and PAC associate the same Call Serial
                            Number with a given session. The combination
                            of IP address and call serial number SHOULD
                            be unique.

   Minimum BPS              The lowest acceptable line speed (in
                            bits/second) for this session.

   Maximum BPS              The highest acceptable line speed (in
                            bits/second) for this session.

   Bearer Type              A value indicating the bearer capability
                            required for this outgoing call.  The
                            currently defined values are:

                                  1 - Call to be placed on an analog
                                      channel

                                  2 - Call to be placed on a digital
                                      channel

                                  3 - Call can be placed on any type of
                                      channel

   Framing Type             A value indicating the type of PPP framing
                            to be used for this outgoing call.

                                  1 - Call to use Asynchronous framing

                                  2 - Call to use Synchronous framing

                                  3 - Call can use either type of
                                      framing

   Packet Recv. Window Size The number of received data packets the PNS
                            will buffer for this session.




Hamzeh, et al.               Informational                     [Page 21]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


   Packet Processing Delay  A measure of the packet processing delay
                            that might be imposed on data sent to the
                            PNS from the PAC.  This value is specified
                            in units of 1/10 seconds.  For the PNS this
                            number should be very small.  See section
                            4.4 for a description of how this value is
                            determined and used.

   Phone Number Length      The actual number of valid digits in the
                            Phone Number field.

   Reserved1                This field MUST be 0.

   Phone Number             The number to be dialed to establish the
                            outgoing session.  For ISDN and analog calls
                            this field is an ASCII string.  If the Phone
                            Number is less than 64 octets in length, the
                            remainder of this field is filled with
                            octets of value 0.

   Subaddress               A 64 octet field used to specify additional
                            dialing information.  If the subaddress is
                            less than 64 octets long, the remainder of
                            this field is filled with octets of value 0.

2.8.  Outgoing-Call-Reply

   The Outgoing-Call-Reply is a PPTP control message sent by the PAC to
   the PNS in response to a received Outgoing-Call-Request message.  The
   reply indicates the result of the outgoing call attempt.  It also
   provides information to the PNS about particular parameters used for
   the call.  It provides information to allow the PNS to regulate the
   transmission of data to the PAC for this session.


















Hamzeh, et al.               Informational                     [Page 22]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |            Length             |      PPTP Message Type        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                         Magic Cookie                          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |     Control Message Type      |           Reserved0           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |            Call ID            |       Peer's Call ID          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |  Result Code  |  Error Code   |          Cause Code           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                         Connect Speed                         |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |   Packet Recv. Window Size    |    Packet Processing Delay    |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                      Physical Channel ID                      |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

   Length                   Total length in octets of this PPTP message,
                            including the entire PPTP header.

   PPTP Message Type        1 for Control Message.

   Magic Cookie             0x1A2B3C4D.

   Control Message Type     8 for Outgoing-Call-Reply.

   Reserved0                This field MUST be 0.

   Call ID                  A unique identifier for the tunnel, assigned
                            by the PAC to this session.  It is used to
                            multiplex and demultiplex data sent over the
                            tunnel between the PNS and PAC involved in
                            this session.

   Peer's Call ID           This field is set to the value received in
                            the Call ID field of the corresponding
                            Outgoing-Call-Request message.  It is used
                            by the PNS to match the Outgoing-Call-Reply
                            with the Outgoing-Call-Request it issued. It
                            also is used as the value sent in the GRE
                            header for mux/demuxing.







Hamzeh, et al.               Informational                     [Page 23]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


   Result Code              This value indicates the result of the
                            Outgoing-Call-Request attempt.  Currently
                            valid values are:

                                  1 (Connected) - Call established with
                                    no errors

                                  2 (General Error) - Outgoing Call not
                                    established for the reason indicated
                                    in Error Code

                                  3 (No Carrier) - Outgoing Call failed
                                    due to no carrier detected

                                  4 (Busy) - Outgoing Call failed due to
                                    detection of a busy signal

                                  5 (No Dial Tone) - Outgoing Call
                                    failed due to lack of a dial tone

                                  6 (Time-out) - Outgoing Call was not
                                    established within time allotted by
                                    PAC

                                  7 (Do Not Accept) - Outgoing Call
                                    administratively prohibited

   Error Code               This field is set to 0 unless a "General
                            Error" condition exists, in which case
                            Result Code is set to 2 and this field is
                            set to the value corresponding to the
                            general error condition as specified in
                            section 2.2.

   Cause Code               This field gives additional failure
                            information.  Its value can vary depending
                            upon the type of call attempted.  For ISDN
                            call attempts it is the Q.931 cause code.

   Connect Speed            The actual connection speed used, in
                            bits/second.

   Packet Recv. Window Size The number of received data packets the PAC
                            will buffer for this session.







Hamzeh, et al.               Informational                     [Page 24]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


   Packet Processing Delay  A measure of the packet processing delay
                            that might be imposed on data sent to the
                            PAC from the PNS.  This value is specified
                            in units of 1/10 seconds.  For the PAC, this
                            number is related to the size of the buffer
                            used to hold packets to be sent to the
                            client and to the speed of the link to the
                            client.  This value should be set to the
                            maximum delay that can normally occur
                            between the time a packet arrives at the PAC
                            and is delivered to the client.  See section
                            4.4 for an example of how this value is
                            determined and used.

   Physical Channel ID      This field is set by the PAC in a vendor-
                            specific manner to the physical channel
                            number used to place this call.  It is used
                            for logging purposes only.

2.9.  Incoming-Call-Request

   The Incoming-Call-Request is a PPTP control message sent by the PAC
   to the PNS to indicate that an inbound call is to be established from
   the PAC.  This request provides the PNS with parameter information
   for the incoming call.

   This message is the first in the "three-way handshake" used by PPTP
   for establishing incoming calls.  The PAC may defer answering the
   call until it has received an Incoming-Call-Reply from the PNS
   indicating that the call should be established. This mechanism allows
   the PNS to obtain sufficient information about the call before it is
   answered to determine whether the call should be answered or not.



















Hamzeh, et al.               Informational                     [Page 25]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |            Length             |       PPTP Message Type       |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                         Magic Cookie                          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |     Control Message Type      |           Reserved0           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |            Call ID            |      Call Serial Number       |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                       Call Bearer Type                        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                      Physical Channel ID                      |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |     Dialed Number Length      |     Dialing Number Length     |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                                                               |
      +                   Dialed Number (64 octets)                   +
      |                                                               |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                                                               |
      +                  Dialing Number (64 octets)                   +
      |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                                                               |
      +                    Subaddress (64 octets)                     +
      |                                                               |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

   Length                   Total length in octets of this PPTP message,
                            including the entire PPTP header.

   PPTP Message Type        1 for Control Message.

   Magic Cookie             0x1A2B3C4D.

   Control Message Type     9 for Incoming-Call-Request.

   Reserved0                This field MUST be 0.

   Call ID                  A unique identifier for this tunnel,
                            assigned by the PAC to this session.  It is
                            used to multiplex and demultiplex data sent
                            over the tunnel between the PNS and PAC
                            involved in this session.





Hamzeh, et al.               Informational                     [Page 26]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


   Call Serial Number       An identifier assigned by the PAC to this
                            session for the purpose of identifying this
                            particular session in logged session
                            information.  Unlike the Call ID, both the
                            PNS and PAC associate the same Call Serial
                            Number to a given session. The combination
                            of IP address and call serial number should
                            be unique.

   Bearer Type              A value indicating the bearer capability
                            used for this incoming call.  Currently
                            defined values are:

                                  1 - Call is on an analog channel

                                  2 - Call is on a digital channel

   Physical Channel ID      This field is set by the PAC in a vendor-
                            specific manner to the number of the
                            physical channel this call arrived on.

   Dialed Number Length     The actual number of valid digits in the
                            Dialed Number field.

   Dialing Number Length    The actual number of valid digits in the
                            Dialing Number field.

   Dialed Number            The number that was dialed by the caller.
                            For ISDN and analog calls this field is an
                            ASCII string.  If the Dialed Number is less
                            than 64 octets in length, the remainder of
                            this field is filled with octets of value 0.

   Dialing Number           The number from which the call was placed.
                            For ISDN and analog calls this field is an
                            ASCII string.  If the Dialing Number is less
                            than 64 octets in length, the remainder of
                            this field is filled with octets of value 0.

   Subaddress               A 64 octet field used to specify additional
                            dialing information.  If the subaddress is
                            less than 64 octets long, the remainder of
                            this field is filled with octets of value 0.








Hamzeh, et al.               Informational                     [Page 27]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


2.10.  Incoming-Call-Reply

   The Incoming-Call-Reply is a PPTP control message sent by the PNS to
   the PAC in response to a received Incoming-Call-Request message.  The
   reply indicates the result of the incoming call attempt.  It also
   provides information to allow the PAC to regulate the transmission of
   data to the PNS for this session.

   This message is the second in the three-way handshake used by PPTP
   for establishing incoming calls.  It indicates to the PAC whether the
   call should be answered or not.

       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |            Length             |       PPTP Message Type       |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                         Magic Cookie                          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |     Control Message Type      |           Reserved0           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |            Call ID            |       Peer's Call ID          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |  Result Code  |  Error Code   |   Packet Recv. Window Size    |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |     Packet Transmit Delay     |           Reserved1           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

   Length                   Total length in octets of this PPTP message,
                            including the entire PPTP header.

   PPTP Message Type        1 for Control Message.

   Magic Cookie             0x1A2B3C4D.

   Control Message Type     10 for Incoming-Call-Reply.

   Reserved0                This field MUST be 0.

   Call ID                  A unique identifier for this tunnel assigned
                            by the PNS to this session.  It is used to
                            multiplex and demultiplex data sent over the
                            tunnel between the PNS and PAC involved in
                            this session.

   Peer's Call ID           This field is set to the value received in
                            the Call ID field of the corresponding
                            Incoming-Call-Request message. It is used by



Hamzeh, et al.               Informational                     [Page 28]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


                            the PAC to match the Incoming-Call-Reply
                            with the Incoming-Call-Request it issued.
                            This value is included in the GRE header of
                            transmitted data packets for this session.

   Result Code              This value indicates the result of the
                            Incoming-Call-Request attempt.  Current
                            valid Result Code values are:

                                  1 (Connect) - The PAC should answer
                                    the incoming call

                                  2 (General Error) - The Incoming Call
                                    should not be established due to the
                                    reason indicated in Error Code

                                  3 (Do Not Accept) - The PAC should not
                                    accept the incoming call.  It should
                                    hang up or issue a busy indication

   Error Code               This field is set to 0 unless a "General
                            Error" condition exists, in which case
                            Result Code is set to 2 and this field is
                            set to the value corresponding to the
                            general error condition as specified in
                            section 2.2.

   Packet Recv. Window Size The number of received data packets the PAC
                            will buffer for this session.

   Packet Transmit Delay    A measure of the packet processing delay
                            that might be imposed on data sent to the
                            PAC from the PNS.  This value is specified
                            in units of 1/10 seconds.

   Reserved1                This field MUST be 0.

2.11.  Incoming-Call-Connected

   The Incoming-Call-Connected message is a PPTP control message sent by
   the PAC to the PNS in response to a received Incoming-Call-Reply.  It
   provides information to the PNS about particular parameters used for
   the call.  It also provides information to allow the PNS to regulate
   the transmission of data to the PAC for this session.

   This message is the third in the three-way handshake used by PPTP for
   establishing incoming calls.  It provides a mechanism for providing
   the PNS with additional information about the call that cannot, in



Hamzeh, et al.               Informational                     [Page 29]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


   general, be obtained at the time the Incoming-Call-Request is issued
   by the PAC.

       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |            Length             |      PPTP Message Type        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                         Magic Cookie                          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |     Control Message Type      |           Reserved0           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |       Peer's Call ID          |           Reserved1           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                         Connect Speed                         |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |   Packet Recv. Window Size    |     Packet Transmit Delay     |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                         Framing Type                          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

   Length                   Total length in octets of this PPTP message,
                            including the entire PPTP header.

   PPTP Message Type        1 for Control Message.

   Magic Cookie             0x1A2B3C4D.

   Control Message Type     11 for Incoming-Call-Connected.

   Reserved0                This field MUST be 0.

   Peer's Call ID           This field is set to the value received in
                            the Call ID field of the corresponding
                            Incoming-Call-Reply message.  It is used by
                            the PNS to match the Incoming-Call-Connected
                            with the Incoming-Call-Reply it issued.

   Connect Speed            The actual connection speed used, in
                            bits/second.

   Packet Recv. Window Size The number of received data packets the PAC
                            will buffer for this session.

   Packet Transmit Delay    A measure of the packet processing delay
                            that might be imposed on data sent to the
                            PAC from the PNS.  This value is specified
                            in units of 1/10 seconds.



Hamzeh, et al.               Informational                     [Page 30]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


   Framing Type             A value indicating the type of PPP framing
                            being used by this incoming call.

                                  1 - Call uses asynchronous framing

                                  2 - Call uses synchronous framing

2.12.  Call-Clear-Request

   The Call-Clear-Request is a PPTP control message sent by the PNS to
   the PAC indicating that a particular call is to be disconnected.  The
   call being cleared can be either an incoming or outgoing call, in any
   state.  The PAC responds to this message with a Call-Disconnect-
   Notify message.

       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |            Length             |      PPTP Message Type        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                         Magic Cookie                          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |     Control Message Type      |           Reserved0           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |            Call ID            |           Reserved1           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

   Length                   Total length in octets of this PPTP message,
                            including the entire PPTP header.

   PPTP Message Type        1 for Control Message.

   Magic Cookie             0x1A2B3C4D.

   Control Message Type     12 for Call-Clear-Request.

   Reserved0                This field MUST be 0.

   Call ID                  The Call ID assigned by the PNS to this
                            call.  This value is used instead of the
                            Peer's Call ID because the latter may not be
                            known to the PNS if the call must be aborted
                            during call establishment.

   Reserved1                This field MUST be 0.






Hamzeh, et al.               Informational                     [Page 31]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


2.13.  Call-Disconnect-Notify

   The Call-Disconnect-Notify message is a PPTP control message sent by
   the PAC to the PNS.  It is issued whenever a call is disconnected,
   due to the receipt by the PAC of a Call-Clear-Request or for any
   other reason.  Its purpose is to inform the PNS of both the
   disconnection and the reason for it.

       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |            Length             |      PPTP Message Type        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                         Magic Cookie                          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |     Control Message Type      |           Reserved0           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |            Call ID            |  Result Code  |  Error Code   |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |          Cause Code           |           Reserved1           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                                                               |
      +              Call Statistics (128 octets)                     +
      |                                                               |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

   Length                   Total length in octets of this PPTP message,
                            including the entire PPTP header.

   PPTP Message Type        1 for Control Message.

   Magic Cookie             0x1A2B3C4D.

   Control Message Type     13 for Call-Disconnect-Notify.

   Reserved0                This field MUST be 0.

   Call ID                  The value of the Call ID assigned by the PAC
                            to this call.  This value is used instead of
                            the Peer's Call ID because the latter may
                            not be known to the PNS if the call must be
                            aborted during call establishment.









Hamzeh, et al.               Informational                     [Page 32]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


   Result Code              This value indicates the reason for the
                            disconnect. Current valid Result Code values
                            are:

                                  1 (Lost Carrier) - Call disconnected
                                    due to loss of carrier

                                  2 (General Error) - Call disconnected
                                    for the reason indicated in Error
                                    Code

                                  3 (Admin Shutdown) - Call disconnected
                                    for administrative reasons

                                  4 (Request) - Call disconnected due to
                                    received Call-Clear-Request

   Error Code               This field is set to 0 unless a "General
                            Error" condition exists, in which case the
                            Result Code is set to 2 and this field is
                            set to the value corresponding to the
                            general error condition as specified in
                            section 2.2.

   Cause Code               This field gives additional disconnect
                            information.  Its value varies depending on
                            the type of call being disconnected.  For
                            ISDN calls it is the Q.931 cause code.

   Call Statistics          This field is an ASCII string containing
                            vendor-specific call statistics that can be
                            logged for diagnostic purposes.  If the
                            length of the string is less than 128, the
                            remainder of the field is filled with octets
                            of value 0.

2.14.  WAN-Error-Notify

   The WAN-Error-Notify message is a PPTP control message sent by the
   PAC to the PNS to indicate WAN error conditions (conditions that
   occur on the interface supporting PPP).  The counters in this message
   are cumulative.  This message should only be sent when an error
   occurs, and not more than once every 60 seconds.  The counters are
   reset when a new call is established.







Hamzeh, et al.               Informational                     [Page 33]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |            Length             |      PPTP Message Type        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                         Magic Cookie                          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |     Control Message type      |           Reserved0           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |        Peer's Call ID         |           Reserved1           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                          CRC Errors                           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                        Framing Errors                         |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                       Hardware Overruns                       |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                        Buffer Overruns                        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                        Time-out Errors                        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                       Alignment Errors                        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

   Length                   Total length in octets of this PPTP message,
                            including the entire PPTP header.

   PPTP Message Type        1 for Control Message.

   Magic Cookie             0x1A2B3C4D.

   Control Message Type     14 for WAN-Error-Notify.

   Reserved0                This field MUST be 0.

   Peer's Call ID           Th Call ID assigned by the PNS to this call.

   CRC Errors               Number of PPP frames received with CRC
                            errors since session was established.

   Framing Errors           Number of improperly framed PPP packets
                            received.

   Hardware Overruns        Number of receive buffer over-runs since
                            session was established.

   Buffer Overruns          Number of buffer over-runs detected since
                            session was established.



Hamzeh, et al.               Informational                     [Page 34]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


   Time-out Errors          Number of time-outs since call was
                            established.

   Alignment Errors         Number of alignment errors since call was
                            established.

2.15.  Set-Link-Info

   The Set-Link-Info message is a PPTP control message sent by the PNS
   to the PAC to set PPP-negotiated options.  Because these options can
   change at any time during the life of the call, the PAC must be able
   to update its internal call information dynamically and perform PPP
   negotiation on an active PPP session.

       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |            Length             |      PPTP Message Type        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                         Magic Cookie                          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |     Control Message type      |           Reserved0           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |        Peer's Call ID         |           Reserved1           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                           Send ACCM                           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                         Receive ACCM                          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

   Length                   Total length in octets of this PPTP message,
                            including the entire PPTP header.

   PPTP Message Type        1 for Control Message.

   Magic Cookie             0x1A2B3C4D.

   Control Message Type     15 for Set-Link-Info.

   Reserved0                This field MUST be 0.

   Peer's Call ID           The value of the Call ID assigned by the PAC
                            to this call.

   Reserved1                This field MUST be 0.






Hamzeh, et al.               Informational                     [Page 35]

RFC 2637        Point-to-Point Tunneling Protocol (PPTP)       July 1999


   Send ACCM                The send ACCM value the client should use to
                            process outgoing PPP packets.  The default
                            value used by the client until this message
                            is received is 0XFFFFFFFF.  See [7].

   Receive ACCM             The receive ACCM value the client should use
                            to process incoming PPP packets. The default
                            value used by the client until this message
                            is received is 0XFFFFFFFF.  See [7].

2.16.  General Error Codes

   General error codes pertain to types of errors which are not specific
   to any particular PPTP request, but rather to protocol or message
   format errors.  If a PPTP reply indicates in its Result Code that a
   general error occurred, the General Error value should be examined to
   determined what the error was.  The currently defined General Error
   codes and their meanings are:

      0 (None)          - No general error

      1 (Not-Connected) - No control connection exists yet for this
                          PAC-PNS pair

      2 (Bad-Format)    - Length is wrong or Magic Cookie value is
                          incorrect

      3 (Bad-Value)     - One of the field values was out of range or
                          reserved field was non-zero

      4 (No-Resource)   - Insufficient resources to handle this command
                          now

      5 (Bad-Call ID)    - The Call ID is invalid in this context

      6 (PAC-Error)     - A generic vendor-specific error occurred in
                          the PAC

3.  Control Connection Protocol Operation

   This section describes the operation of various PPTP control
   connection functions and the Control Connection messages which are
   used to support them.  The protocol operation of the control
   connection is simplified because TCP is used to provide a reliable
   transport mechanism.  Ordering and retransmission of messages is not
   a concern at this level.  The TCP connection itself, however, can
   close at any time and an appropriate error recovery mechanism must be
   provided to handle this case.


